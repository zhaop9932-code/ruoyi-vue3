# 多租户架构接口变更文档

## 1. 文档概述

### 1.1 变更背景
系统从单用户架构迁移至多租户架构，采用行级隔离方案实现数据隔离。所有业务表添加`tenant_id`字段，通过在API请求中传递租户ID，实现不同租户数据的安全隔离。

### 1.2 变更范围
- **所有业务接口**：需要添加租户ID参数
- **新增租户管理接口**：用于租户的创建、查询、更新和删除
- **认证授权接口**：JWT Token中添加租户ID

### 1.3 文档用途
- 指导前端开发团队进行API调试
- 说明接口变更点和兼容性处理
- 提供接口调用示例

## 2. 核心变更说明

### 2.1 租户ID传递方式

#### 2.1.1 请求头方式（推荐）
```
X-Tenant-Id: 1
```

#### 2.1.2 请求参数方式
```
GET /api/system/user/list?tenantId=1
```

### 2.2 JWT Token增强
JWT Token中新增`tenantId`字段，用于存储当前登录用户的租户ID。

### 2.3 响应数据变化
所有包含业务数据的响应，都会包含`tenantId`字段。

## 3. 新增API接口

### 3.1 租户管理接口

#### 3.1.1 查询租户列表

| 属性 | 值 |
|------|-----|
| URL | `/system/tenant/list` |
| 方法 | GET |
| 权限 | `system:tenant:list` |
| 状态 | 新增 |

**请求参数**

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| tenantName | String | 否 | 租户名称 |
| tenantCode | String | 否 | 租户编码 |
| status | String | 否 | 状态（0正常 1停用） |

**响应示例**
```json
{
  "code": 0,
  "msg": "查询成功",
  "rows": [
    {
      "tenantId": 1,
      "tenantName": "默认租户",
      "tenantCode": "default",
      "status": "0",
      "createTime": "2026-01-11 19:30:00",
      "updateTime": "2026-01-11 19:30:00",
      "remark": "系统默认租户"
    }
  ],
  "total": 1
}
```

#### 3.1.2 新增租户

| 属性 | 值 |
|------|-----|
| URL | `/system/tenant` |
| 方法 | POST |
| 权限 | `system:tenant:add` |
| 状态 | 新增 |

**请求体**
```json
{
  "tenantName": "测试租户",
  "tenantCode": "test",
  "status": "0",
  "remark": "测试用租户"
}
```

**响应示例**
```json
{
  "code": 0,
  "msg": "操作成功",
  "data": null
}
```

#### 3.1.3 修改租户

| 属性 | 值 |
|------|-----|
| URL | `/system/tenant` |
| 方法 | PUT |
| 权限 | `system:tenant:edit` |
| 状态 | 新增 |

**请求体**
```json
{
  "tenantId": 2,
  "tenantName": "测试租户（已更新）",
  "tenantCode": "test",
  "status": "0",
  "remark": "更新后的测试租户"
}
```

**响应示例**
```json
{
  "code": 0,
  "msg": "操作成功",
  "data": null
}
```

#### 3.1.4 删除租户

| 属性 | 值 |
|------|-----|
| URL | `/system/tenant/{tenantId}` |
| 方法 | DELETE |
| 权限 | `system:tenant:remove` |
| 状态 | 新增 |

**请求参数**

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| tenantId | Long | 是 | 租户ID |

**响应示例**
```json
{
  "code": 0,
  "msg": "操作成功",
  "data": null
}
```

#### 3.1.5 查询租户详情

| 属性 | 值 |
|------|-----|
| URL | `/system/tenant/{tenantId}` |
| 方法 | GET |
| 权限 | `system:tenant:query` |
| 状态 | 新增 |

**请求参数**

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| tenantId | Long | 是 | 租户ID |

**响应示例**
```json
{
  "code": 0,
  "msg": "查询成功",
  "data": {
    "tenantId": 1,
    "tenantName": "默认租户",
    "tenantCode": "default",
    "status": "0",
    "createTime": "2026-01-11 19:30:00",
    "updateTime": "2026-01-11 19:30:00",
    "remark": "系统默认租户"
  }
}
```

## 4. 修改API接口

### 4.1 用户管理接口

#### 4.1.1 查询用户列表

| 属性 | 值 |
|------|-----|
| URL | `/system/user/list` |
| 方法 | GET |
| 权限 | `system:user:list` |
| 状态 | 修改 |

**请求参数**

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| tenantId | Long | 否 | 租户ID（可通过请求头传递） |
| userName | String | 否 | 用户名 |
| phonenumber | String | 否 | 手机号码 |
| status | String | 否 | 用户状态 |

**响应示例**
```json
{
  "code": 0,
  "msg": "查询成功",
  "rows": [
    {
      "userId": 1,
      "tenantId": 1,
      "userName": "admin",
      "nickName": "管理员",
      "email": "admin@example.com",
      "phonenumber": "13800138000",
      "status": "0"
    }
  ],
  "total": 1
}
```

#### 4.1.2 新增用户

| 属性 | 值 |
|------|-----|
| URL | `/system/user` |
| 方法 | POST |
| 权限 | `system:user:add` |
| 状态 | 修改 |

**请求体**
```json
{
  "tenantId": 1,
  "userName": "test",
  "nickName": "测试用户",
  "email": "test@example.com",
  "phonenumber": "13800138001",
  "password": "123456",
  "deptId": 1,
  "roleIds": [1],
  "postIds": [1]
}
```

**响应示例**
```json
{
  "code": 0,
  "msg": "操作成功",
  "data": null
}
```

### 4.2 角色管理接口

#### 4.2.1 查询角色列表

| 属性 | 值 |
|------|-----|
| URL | `/system/role/list` |
| 方法 | GET |
| 权限 | `system:role:list` |
| 状态 | 修改 |

**请求参数**

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| tenantId | Long | 否 | 租户ID（可通过请求头传递） |
| roleName | String | 否 | 角色名称 |
| status | String | 否 | 角色状态 |

**响应示例**
```json
{
  "code": 0,
  "msg": "查询成功",
  "rows": [
    {
      "roleId": 1,
      "tenantId": 1,
      "roleName": "超级管理员",
      "roleKey": "admin",
      "status": "0"
    }
  ],
  "total": 1
}
```

### 4.3 部门管理接口

#### 4.3.1 查询部门列表

| 属性 | 值 |
|------|-----|
| URL | `/system/dept/list` |
| 方法 | GET |
| 权限 | `system:dept:list` |
| 状态 | 修改 |

**请求参数**

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| tenantId | Long | 否 | 租户ID（可通过请求头传递） |
| deptName | String | 否 | 部门名称 |

**响应示例**
```json
{
  "code": 0,
  "msg": "查询成功",
  "rows": [
    {
      "deptId": 1,
      "tenantId": 1,
      "deptName": "总部",
      "parentId": 0,
      "orderNum": 1
    }
  ],
  "total": 1
}
```

### 4.4 配置管理接口

#### 4.4.1 查询配置列表

| 属性 | 值 |
|------|-----|
| URL | `/system/config/list` |
| 方法 | GET |
| 权限 | `system:config:list` |
| 状态 | 修改 |

**请求参数**

| 参数名 | 类型 | 必填 | 描述 |
|--------|------|------|------|
| tenantId | Long | 否 | 租户ID（可通过请求头传递） |
| configKey | String | 否 | 配置键名 |

**响应示例**
```json
{
  "code": 0,
  "msg": "查询成功",
  "rows": [
    {
      "configId": 1,
      "tenantId": 1,
      "configKey": "sys.title",
      "configValue": "RuoYi管理系统",
      "configType": "Y"
    }
  ],
  "total": 1
}
```

### 4.5 CPQ相关接口

所有CPQ相关接口（如产品管理、价格管理、配置规则等）都需要传递租户ID，响应数据中会包含租户ID。

示例：查询产品列表

| 属性 | 值 |
|------|-----|
| URL | `/cpq/product/list` |
| 方法 | GET |
| 权限 | `cpq:product:list` |
| 状态 | 修改 |

**请求头**
```
X-Tenant-Id: 1
```

**响应示例**
```json
{
  "code": 0,
  "msg": "查询成功",
  "rows": [
    {
      "productId": 1,
      "tenantId": 1,
      "productName": "测试产品",
      "productCode": "TEST-001",
      "status": "0"
    }
  ],
  "total": 1
}
```

## 5. 认证授权接口变更

### 5.1 登录接口

| 属性 | 值 |
|------|-----|
| URL | `/login` |
| 方法 | POST |
| 状态 | 修改 |

**请求体**
```json
{
  "username": "admin",
  "password": "admin123",
  "code": "",
  "uuid": ""
}
```

**响应示例**
```json
{
  "code": 0,
  "msg": "操作成功",
  "token": "eyJhbGciOiJIUzUxMiJ9...",
  "data": {
    "userId": 1,
    "tenantId": 1,
    "userName": "admin",
    "nickName": "管理员",
    "avatar": ""
  }
}
```

### 5.2 获取用户信息接口

| 属性 | 值 |
|------|-----|
| URL | `/getInfo` |
| 方法 | GET |
| 状态 | 修改 |

**响应示例**
```json
{
  "code": 0,
  "msg": "操作成功",
  "data": {
    "userId": 1,
    "tenantId": 1,
    "userName": "admin",
    "nickName": "管理员",
    "avatar": "",
    "roles": ["admin"],
    "permissions": ["*:*:*"]
  }
}
```

## 6. 兼容性处理

### 6.1 旧版本接口兼容

系统对旧版本接口做了兼容处理：
- 如果请求中未传递租户ID，默认使用租户ID为1
- 确保现有功能不受影响

### 6.2 前端兼容性处理

1. **全局拦截器**：在前端请求拦截器中统一添加租户ID请求头
2. **Token解析**：解析JWT Token中的租户ID
3. **响应处理**：处理包含租户ID的响应数据

## 7. 接口调用示例

### 7.1 使用Axios调用示例

```javascript
// 设置全局请求拦截器
axios.interceptors.request.use(config => {
  // 从本地存储获取当前租户ID
  const tenantId = localStorage.getItem('tenantId') || '1';
  // 添加租户ID请求头
  config.headers['X-Tenant-Id'] = tenantId;
  return config;
});

// 调用用户列表接口
axios.get('/system/user/list')
  .then(response => {
    console.log(response.data);
  })
  .catch(error => {
    console.error(error);
  });

// 调用新增用户接口
axios.post('/system/user', {
  tenantId: 1,
  userName: 'test',
  nickName: '测试用户',
  password: '123456'
}).then(response => {
  console.log(response.data);
});
```

### 7.2 使用Postman测试示例

1. **设置请求头**：在Headers标签中添加`X-Tenant-Id: 1`
2. **发送请求**：调用任意业务接口
3. **查看响应**：响应数据中包含`tenantId`字段

## 8. 常见问题处理

### 8.1 400 Bad Request - Invalid tenant ID
**原因**：租户ID格式错误
**解决**：确保传递的租户ID是有效的数字

### 8.2 403 Forbidden - No permission to access this tenant
**原因**：用户没有权限访问该租户
**解决**：检查用户的租户权限配置

### 8.3 404 Not Found - Tenant not found
**原因**：租户不存在
**解决**：检查租户ID是否正确

## 9. 测试建议

1. **单元测试**：针对每个API接口进行单元测试
2. **集成测试**：测试多租户场景下的数据隔离
3. **性能测试**：测试多租户架构下的系统性能
4. **安全测试**：测试租户间数据隔离的安全性

## 10. 文档更新记录

| 版本 | 更新日期 | 更新内容 | 更新人 |
|------|----------|----------|--------|
| v1.0 | 2026-01-11 | 初始版本 | 系统管理员 |

## 11. 联系方式

如有疑问，请联系系统开发团队：
- 邮箱：dev@example.com
- 电话：010-12345678

---

**文档结束**