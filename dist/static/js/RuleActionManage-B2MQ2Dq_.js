import{_ as he,r as m,z as be,w as Oe,o as De,h as r,G as J,d as y,e as u,i as o,H as x,k as a,l as P,q as l,n as B,as as Re,m as z,j as g,K as Y,L as F,t as N,a3 as xe,M as j,s as V,V as d,E as H}from"./index-CwdKQqOf.js";import K from"./ActionContent-Dw0ch5ry.js";import{l as Ve,s as Ue,d as W,u as Le,a as Me}from"./ruleAction-pCoBry9w.js";import{T as S,f as $e,h as qe,e as T,A as Be,j as Ge,k as Je,l as w}from"./actionConfig-C-hhf0v-.js";import"./ActionTypeSelector-D6XzvoPv.js";import"./TargetTypeSelector-DMvPq2hV.js";import"./TargetObjectSelector-D57w5mnf.js";import"./NodeSelector-Ct-lJUlq.js";import"./superBomStructure-BzSqI57Q.js";import"./AttributeSelector-D3T3OJek.js";import"./bom-DdrUuB8x.js";import"./superBomDynamicAttribute-BGTx_QxK.js";import"./superBomProductRelation-e2EKVMIZ.js";import"./superBomRuleRelation-Cz_bCmLL.js";import"./superBomVariable-gMrvMuGl.js";import"./ActionParamsConfig-D_MeBCNX.js";import"./BasicInfoSection-BjcOnwIf.js";const ze={class:"rule-action-manage"},Ye={class:"action-list"},Fe={style:{display:"flex","align-items":"center",gap:"8px"}},je={style:{"font-weight":"600"}},He={style:{"margin-top":"10px"}},Ke={style:{"margin-left":"8px"}},We={key:2,class:"action-items"},Xe=["onClick"],Qe={class:"action-header-left"},Ze={class:"action-title"},et={key:0,class:"action-name"},tt={key:1,class:"action-name text-muted"},at={class:"action-header-right"},ot={class:"dialog-footer"},nt={__name:"RuleActionManage",props:{ruleId:{type:[String,Number],required:!0},bomId:{type:[String,Number],required:!0}},setup(U){const h=U,k=m(!1),s=m([]),I=m([]),L=m([]),C=be(()=>s.value.filter(t=>t.selected)),b=m([]),A=m(!1),O=m(""),c=m({}),E=m(-1),X=m(null),D=m({valid:!0,errors:[]}),M=async()=>{k.value=!0;try{const t=await Ve(h.ruleId);t.code===200&&t.data&&(s.value=t.data.map(e=>({...e,selected:!1})))}catch(t){console.error("加载动作列表失败:",t),d.error("加载动作列表失败")}finally{k.value=!1}},Q=()=>{c.value={ruleId:h.ruleId,actionType:"",actionName:"",targetType:"",targetId:"",structureId:"",attributeId:"",actionParams:"{}",actionPriority:1,actionStatus:"0",actionSequence:s.value.length+1,description:""},E.value=-1,O.value="新增动作",A.value=!0},Z=(t,e)=>{c.value={...t},E.value=e,O.value="编辑动作",A.value=!0},ee=async()=>{if(!D.value.valid){d.warning(D.value.errors.join(", "));return}k.value=!0;try{if(c.value.actionId)await Le(c.value),d.success("更新成功");else{const t=await Me(c.value);t.code===200&&(c.value.actionId=t.data.actionId,d.success("新增成功"))}E.value>=0?s.value[E.value]={...c.value}:s.value.push({...c.value,selected:!1}),A.value=!1}catch(t){console.error("保存动作失败:",t),d.error("保存动作失败")}finally{k.value=!1}},te=async(t,e)=>{try{await H.confirm("确定要删除该动作吗?","提示",{type:"warning"}),t.actionId&&await W(t.actionId),s.value.splice(e,1),d.success("删除成功")}catch(i){i!=="cancel"&&(console.error("删除动作失败:",i),d.error("删除动作失败"))}},ae=async()=>{try{await H.confirm(`确定要删除选中的 ${C.value.length} 个动作吗?`,"提示",{type:"warning"});const t=C.value.filter(e=>e.actionId).map(e=>W(e.actionId));await Promise.all(t),s.value=s.value.filter(e=>!e.selected),d.success("删除成功")}catch(t){t!=="cancel"&&(console.error("批量删除失败:",t),d.error("批量删除失败"))}},oe=async()=>{try{const t=C.value.map(e=>{const{selected:i,..._}=e;return _});await Ue(Number(h.ruleId),t),d.success("批量保存成功"),await M()}catch(t){console.error("批量保存失败:",t),d.error("批量保存失败")}},ne=()=>{M()},le=t=>{const e=I.value.indexOf(t);e>=0?I.value.splice(e,1):I.value.push(t)},ie=()=>{},se=(t,e)=>{},re=()=>{c.value={},E.value=-1,D.value={valid:!0,errors:[]}},G=(t,e)=>{const i={...t,actionId:null,actionName:`${t.actionName||"未命名动作"} (副本)`,actionSequence:s.value.length+1,selected:!1};s.value.push(i),d.success("动作已复制，请编辑后保存")},ce=()=>{if(C.value.length!==1){d.warning("请选择一个动作进行复制");return}const t=C.value[0];s.value.findIndex(e=>e===t),G(t)},ue={enable_node:{actionName:"节点启用控制",actionType:T.IS_ENABLE,targetType:S.NODE,actionParams:JSON.stringify({value:!0}),actionStatus:"0",actionPriority:1,description:"控制指定节点的启用状态"},recommend_product:{actionName:"产品推荐",actionType:T.IS_RECOMMEND,targetType:S.NODE_PRODUCT,actionParams:JSON.stringify({value:!0}),actionStatus:"0",actionPriority:2,description:"将指定产品设置为推荐"},discount_90:{actionName:"9折优惠",actionType:T.APPLY_DISCOUNT,targetType:S.NODE,actionParams:JSON.stringify({type:"percentage",value:.9,isStackable:!1}),actionStatus:"0",actionPriority:3,description:"应用9折折扣"},discount_range:{actionName:"阶梯折扣",actionType:T.SET_PRICE,targetType:S.NODE,actionParams:JSON.stringify({settingType:"formula",value:"${quantity} < 10 ? ${price} : (${quantity} < 100 ? ${price} * 0.9 : ${price} * 0.8)"}),actionStatus:"0",actionPriority:3,description:"根据数量设置阶梯价格：小于10件原价，10-100件9折，100件以上8折"},full_reduce:{actionName:"满1000减100",actionType:T.APPLY_FULL_REDUCTION,targetType:S.NODE,actionParams:JSON.stringify({conditionType:"amount",conditionValue:1e3,reduceType:"fixed",reduceValue:100,isLoop:!1}),actionStatus:"0",actionPriority:3,description:"订单满1000元减100元"},price_formula:{actionName:"公式计算价格",actionType:T.SET_PRICE,targetType:S.NODE,actionParams:JSON.stringify({settingType:"formula",value:"${price} * ${quantity}"}),actionStatus:"0",actionPriority:3,description:"使用公式计算总价"},mutual_exclude:{actionName:"互斥选择",actionType:T.MUTUAL_EXCLUDE,targetType:S.NODE_PRODUCT,actionParams:JSON.stringify({}),actionStatus:"0",actionPriority:2,description:"设置产品之间互斥，只能选其一"},multi_select:{actionName:"多选限制",actionType:T.MULTIPLE_SELECT,targetType:S.NODE_PRODUCT,actionParams:JSON.stringify({minSelect:1,maxSelect:5}),actionStatus:"0",actionPriority:2,description:"限制最少选1个，最多选5个产品"},conflict_detect:{actionName:"冲突检测",actionType:T.TRIGGER_WARNING,targetType:"",actionParams:JSON.stringify({level:"high",message:"检测到配置冲突"}),actionStatus:"0",actionPriority:5,description:"检测并警告配置冲突"}},de=t=>{const e=ue[t];e&&(c.value={ruleId:h.ruleId,targetId:"",structureId:"",attributeId:"",actionSequence:s.value.length+1,...e},E.value=-1,O.value="使用模板创建动作",A.value=!0,d.success(`已加载"${e.actionName}"模板，请完善配置后保存`))},pe=t=>{for(const e of Be){const i=e.options.find(_=>_.value===t);if(i)return i.label}return t},me=t=>Je[t]||t,_e=t=>{const e=Ge(t);return{[w.BASIC]:"primary",[w.MUTUAL]:"success",[w.PRICE]:"warning",[w.MESSAGE]:"info",[w.DATA]:"danger"}[e]||""},fe=t=>{L.value=t,t.forEach(e=>{I.value.includes(e)||I.value.push(e)}),setTimeout(()=>{L.value=[]},3e3)},ve=()=>{b.value=qe(s.value)};return Oe(()=>s.value,()=>{ve()},{deep:!0}),De(()=>{M()}),(t,e)=>{const i=r("el-button"),_=r("el-col"),$=r("el-icon"),f=r("el-dropdown-item"),ye=r("el-dropdown-menu"),ge=r("el-dropdown"),Te=r("el-row"),R=r("el-tag"),Ce=r("el-alert"),Ne=r("el-empty"),Se=r("el-checkbox"),Ie=r("ArrowRight"),Ae=r("el-input"),Ee=r("el-form-item"),Pe=r("el-form"),ke=r("el-dialog"),q=J("hasPermi"),we=J("loading");return u(),y("div",ze,[o(Te,{gutter:10,class:"mb8"},{default:a(()=>[o(_,{span:1.5},{default:a(()=>[x((u(),P(i,{type:"primary",icon:"Plus",onClick:Q},{default:a(()=>e[6]||(e[6]=[l(" 新增动作 ")])),_:1,__:[6]})),[[q,["cpq:ruleAction:add"]]])]),_:1}),o(_,{span:1.5},{default:a(()=>[o(i,{type:"success",icon:"DocumentChecked",disabled:C.value.length===0,onClick:oe},{default:a(()=>e[7]||(e[7]=[l(" 批量保存 ")])),_:1,__:[7]},8,["disabled"])]),_:1}),o(_,{span:1.5},{default:a(()=>[x((u(),P(i,{type:"danger",icon:"Delete",disabled:C.value.length===0,onClick:ae},{default:a(()=>e[8]||(e[8]=[l(" 批量删除 ")])),_:1,__:[8]},8,["disabled"])),[[q,["cpq:ruleAction:remove"]]])]),_:1}),o(_,{span:1.5},{default:a(()=>[o(i,{type:"warning",icon:"Refresh",onClick:ne},{default:a(()=>e[9]||(e[9]=[l(" 刷新 ")])),_:1,__:[9]})]),_:1}),o(_,{span:1.5},{default:a(()=>[o(i,{type:"info",icon:"DocumentCopy",disabled:C.value.length!==1,onClick:ce},{default:a(()=>e[10]||(e[10]=[l(" 复制动作 ")])),_:1,__:[10]},8,["disabled"])]),_:1}),o(_,{span:1.5},{default:a(()=>[o(ge,{onCommand:de},{dropdown:a(()=>[o(ye,null,{default:a(()=>[o(f,{command:"enable_node"},{default:a(()=>e[12]||(e[12]=[l("节点启用控制")])),_:1,__:[12]}),o(f,{command:"recommend_product"},{default:a(()=>e[13]||(e[13]=[l("产品推荐")])),_:1,__:[13]}),o(f,{command:"discount_90"},{default:a(()=>e[14]||(e[14]=[l("常用折扣(9折)")])),_:1,__:[14]}),o(f,{command:"discount_range"},{default:a(()=>e[15]||(e[15]=[l("阶梯折扣")])),_:1,__:[15]}),o(f,{command:"full_reduce"},{default:a(()=>e[16]||(e[16]=[l("满减优惠")])),_:1,__:[16]}),o(f,{command:"price_formula"},{default:a(()=>e[17]||(e[17]=[l("价格公式计算")])),_:1,__:[17]}),o(f,{command:"mutual_exclude"},{default:a(()=>e[18]||(e[18]=[l("互斥选择")])),_:1,__:[18]}),o(f,{command:"multi_select"},{default:a(()=>e[19]||(e[19]=[l("多选限制")])),_:1,__:[19]}),o(f,{divided:"",command:"conflict_detect"},{default:a(()=>e[20]||(e[20]=[l("冲突检测")])),_:1,__:[20]})]),_:1})]),default:a(()=>[o(i,{type:"primary",icon:"Memo"},{default:a(()=>[e[11]||(e[11]=l(" 使用模板 ")),o($,{class:"el-icon--right"},{default:a(()=>[o(B(Re))]),_:1})]),_:1,__:[11]})]),_:1})]),_:1})]),_:1}),x((u(),y("div",Ye,[b.value.length>0?(u(),P(Ce,{key:0,type:"warning",closable:!1,style:{"margin-bottom":"15px"}},{title:a(()=>[g("div",Fe,[o($,null,{default:a(()=>[o(B(xe))]),_:1}),g("span",je,"检测到 "+N(b.value.length)+" 个潜在冲突",1)])]),default:a(()=>[g("div",He,[(u(!0),y(Y,null,F(b.value,(n,p)=>(u(),y("div",{key:p,style:{"margin-bottom":"8px"}},[o(R,{type:B($e)(n.level),size:"small"},{default:a(()=>[l(N(n.level==="error"?"错误":n.level==="warning"?"警告":"提示"),1)]),_:2},1032,["type"]),g("span",Ke,N(n.message),1),o(i,{link:"",type:"primary",size:"small",onClick:v=>fe(n.actions)},{default:a(()=>e[21]||(e[21]=[l(" 查看相关动作 ")])),_:2,__:[21]},1032,["onClick"])]))),128))])]),_:1})):z("",!0),s.value.length===0?(u(),P(Ne,{key:1,description:"暂无动作配置,请点击'新增动作'按钮添加"})):(u(),y("div",We,[(u(!0),y(Y,null,F(s.value,(n,p)=>(u(),y("div",{key:n.actionId||p,class:j(["action-item",{"highlight-conflict":L.value.includes(p)}])},[g("div",{class:"action-header",onClick:v=>le(p)},[g("div",Qe,[o(Se,{modelValue:n.selected,"onUpdate:modelValue":v=>n.selected=v,onChange:ie,onClick:e[0]||(e[0]=V(()=>{},["stop"]))},null,8,["modelValue","onUpdate:modelValue"]),o($,{class:j(["expand-icon",{"is-expanded":I.value.includes(p)}])},{default:a(()=>[o(Ie)]),_:2},1032,["class"]),g("span",Ze,[o(R,{type:_e(n.actionType),size:"small"},{default:a(()=>[l(N(pe(n.actionType)),1)]),_:2},1032,["type"]),n.actionName?(u(),y("span",et,N(n.actionName),1)):(u(),y("span",tt,"未命名动作 #"+N(p+1),1))]),n.targetType?(u(),P(R,{key:0,size:"small",effect:"plain"},{default:a(()=>[l(N(me(n.targetType)),1)]),_:2},1024)):z("",!0)]),g("div",at,[o(R,{type:n.actionStatus==="0"?"success":"info",size:"small"},{default:a(()=>[l(N(n.actionStatus==="0"?"启用":"禁用"),1)]),_:2},1032,["type"]),o(i,{type:"primary",link:"",icon:"Edit",onClick:V(v=>Z(n,p),["stop"])},{default:a(()=>e[22]||(e[22]=[l(" 编辑 ")])),_:2,__:[22]},1032,["onClick"]),o(i,{type:"info",link:"",icon:"DocumentCopy",onClick:V(v=>G(n),["stop"])},{default:a(()=>e[23]||(e[23]=[l(" 复制 ")])),_:2,__:[23]},1032,["onClick"]),x((u(),P(i,{type:"danger",link:"",icon:"Delete",onClick:V(v=>te(n,p),["stop"])},{default:a(()=>e[24]||(e[24]=[l(" 删除 ")])),_:2,__:[24]},1032,["onClick"])),[[q,["cpq:ruleAction:remove"]]])])],8,Xe),o(K,{element:s.value[p],"onUpdate:element":v=>s.value[p]=v,"is-expanded":I.value.includes(p),"bom-id":U.bomId,onValidate:v=>se()},null,8,["element","onUpdate:element","is-expanded","bom-id","onValidate"])],2))),128))]))])),[[we,k.value]]),o(ke,{modelValue:A.value,"onUpdate:modelValue":e[5]||(e[5]=n=>A.value=n),title:O.value,width:"60%","close-on-click-modal":!1,onClose:re},{footer:a(()=>[g("span",ot,[o(i,{onClick:e[4]||(e[4]=n=>A.value=!1)},{default:a(()=>e[25]||(e[25]=[l("取消")])),_:1,__:[25]}),o(i,{type:"primary",onClick:ee},{default:a(()=>e[26]||(e[26]=[l("保存")])),_:1,__:[26]})])]),default:a(()=>[o(Pe,{model:c.value,ref_key:"actionFormRef",ref:X,"label-width":"120px"},{default:a(()=>[o(Ee,{label:"动作名称"},{default:a(()=>[o(Ae,{modelValue:c.value.actionName,"onUpdate:modelValue":e[1]||(e[1]=n=>c.value.actionName=n),placeholder:"请输入动作名称"},null,8,["modelValue"])]),_:1}),o(K,{element:c.value,"onUpdate:element":e[2]||(e[2]=n=>c.value=n),"is-expanded":!0,"bom-id":U.bomId,onValidate:e[3]||(e[3]=n=>D.value=n)},null,8,["element","bom-id"])]),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}},St=he(nt,[["__scopeId","data-v-336e98dd"]]);export{St as default};
