import{_ as pe,r as s,$ as H,H as fe,h as be,G as ve,a as m,c as D,o as h,e as u,j as ye,b as o,w as a,f as N,t as _e,l as c,aj as Ne,ak as ge,al as Ie,am as O,an as Se,a0 as Ve,K as xe,ao as he,ap as we,x as Ce,aq as ke,F as Te,n as Be,m as De,E as p,Q as qe}from"./index-DgigFOm-.js";import Ee from"./BomNodeInfoDetail-BYKHxGZL.js";import Ue from"./BomNodeAttributes-B79b_GJu.js";import Me from"./BomNodeProducts-DgAYwzxT.js";import Oe from"./BomNodeDynamicProps-B6jtuAvf.js";import Je from"./BomNodeOtherInfo-D5wM07E7.js";import{a as Fe,r as Le,s as K,t as Ae}from"./bom-CjuVRwkz.js";import"./product-C-f__cve.js";import"./superBomProductRelation-c5nmns4w.js";import"./series-BysOPRJ0.js";import"./catalog-B3PFbkp3.js";import"./superBomDynamicAttribute-6n4Uab6m.js";const Pe={class:"bom-node-info"},Re={class:"node-content"},je={class:"node-tree-container"},ze={class:"tree-header"},Qe={class:"tree-node"},$e={class:"tree-node-action"},Ge={class:"node-detail-container"},He={key:0,class:"empty-detail"},Ke={key:1},Xe={class:"detail-header"},Ye={class:"dialog-footer"},We={__name:"BomNodeInfo",props:{bomId:{type:[String,Number],required:!0}},setup(g){const w=g,J=s(null),V=s(!1),q=s(""),r=s(null),C=s(null),F=s("nodeInfo"),I=s(!1),L=s(0),A=s(0),f=s(null),v=s(!1),k=s("新增节点"),T=s(!1),E=s(null),U=s([]),X={label:"nodeName",children:"children"},l=H({bomStructureId:null,bomId:w.bomId,nodeCode:"",nodeName:"",nodeType:"0",parentNodeId:null,quantity:1,unit:"",status:"enabled",priority:1,description:"",children:[],isRequired:"0",selectionType:"single",minSelection:0,maxSelection:0,isQuantityEditable:"1",icon:"",nodeDescription:""}),Y=H({nodeName:[{required:!0,message:"节点名称不能为空",trigger:"blur"}],nodeType:[{required:!0,message:"请选择节点类型",trigger:"change"}],parentNodeId:[{required:!1,message:"请选择父节点",trigger:"change"}],quantity:[{required:!0,message:"请输入数量",trigger:"blur"},{type:"number",min:0,message:"数量不能小于0",trigger:"blur"}],status:[{required:!0,message:"请选择状态",trigger:"change"}],priority:[{required:!0,message:"请输入优先级",trigger:"blur"},{type:"number",min:1,max:10,message:"优先级必须在1-10之间",trigger:"blur"}]}),W=(t,e)=>t?e.nodeName.toLowerCase().includes(t.toLowerCase()):!0;fe(q,t=>{J.value.filter(t)});const B=async()=>{V.value=!0;try{const e=(await Fe(w.bomId)).data||[];U.value=Z(e),V.value=!1}catch(t){console.error("加载节点树失败:",t),p.error("加载节点树失败"),V.value=!1}},Z=t=>{if(!Array.isArray(t)||t.length===0)return[];const e=[],d=new Map;return t.forEach(i=>{d.set(i.bomStructureId,{...i,children:[]})}),t.forEach(i=>{const y=d.get(i.bomStructureId),x=i.parentNodeId||0;x===0||!d.has(x)?e.push(y):d.get(x).children.push(y)}),e},P=(t=U.value,e=[])=>{for(const d of t)e.push(d),d.children&&d.children.length>0&&P(d.children,e);return e},ee=async t=>{V.value=!0;try{const d=(await Le({bomStructureId:t.bomStructureId})).rows.find(i=>i.bomStructureId===t.bomStructureId);d?(r.value={...d},console.log("selectedNode.value:",r.value),console.log("selectedNode.value.bomStructureId:",r.value.bomStructureId),C.value=JSON.parse(JSON.stringify(d))):(r.value={...t},C.value=JSON.parse(JSON.stringify(t)))}catch(e){console.error("获取节点信息失败:",e),p.error("获取节点信息失败"),r.value={...t},C.value=JSON.parse(JSON.stringify(t))}finally{V.value=!1}},oe=(t,e)=>{t.preventDefault(),f.value=e,L.value=t.clientX,A.value=t.clientY,I.value=!0},R=t=>{t.target.closest(".context-menu")===null&&(I.value=!1)},te=(t,e)=>{switch(f.value=e,t){case"addChild":j();break;case"edit":r.value={...e},C.value=JSON.parse(JSON.stringify(e)),z();break;case"delete":Q(e);break}},le=()=>{T.value=!0,$(),k.value="新增根节点",v.value=!0},j=()=>{f.value&&($(),l.parentNodeId=f.value.bomStructureId,T.value=!1,k.value="新增子节点",I.value=!1,v.value=!0)},z=()=>{f.value&&(Object.assign(l,{...f.value}),T.value=!f.value.parentNodeId,k.value="编辑节点",I.value=!1,v.value=!0)},ae=async()=>{f.value&&(await Q(f.value),I.value=!1)},Q=async t=>{try{await qe.confirm(`确定要删除节点 "${t.nodeName}" 吗？`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await Ae([t.bomStructureId]),await B(),p.success("节点删除成功"),r.value&&r.value.bomStructureId===t.bomStructureId&&(r.value=null)}catch(e){e!=="cancel"&&(p.error("删除失败"),console.error("删除节点失败:",e))}},ne=async()=>{try{await E.value.validate(),l.bomId=w.bomId,await K(l),await B(),l.bomStructureId?p.success("节点更新成功"):p.success("节点新增成功"),v.value=!1}catch(t){t!==!1&&(p.error("操作失败，请检查表单数据"),console.error("提交节点表单失败:",t))}},re=t=>{r.value=t},de=async()=>{try{if(!r.value){p.warning("请先选择一个节点");return}const t={...r.value,bomId:w.bomId};delete t.children,delete t._treeNodeId,delete t.loading,await K(t),await B(),p.success("节点信息保存成功")}catch(t){p.error("保存节点信息失败"),console.error("保存节点信息失败:",t)}},$=()=>{var t;l.bomStructureId=null,l.nodeCode="",l.nodeName="",l.nodeType="0",l.parentNodeId=null,l.quantity=1,l.unit="",l.status="enabled",l.priority=1,l.description="",l.isRequired="0",l.selectionType="single",l.minSelection=0,l.maxSelection=0,l.isQuantityEditable="1",l.icon="",l.nodeDescription="",(t=E.value)==null||t.resetFields()};return be(()=>{B(),document.addEventListener("click",R)}),ve(()=>{document.removeEventListener("click",R)}),(t,e)=>{const d=m("el-input"),i=m("el-button"),y=m("el-icon"),x=m("el-empty"),S=m("el-tab-pane"),ue=m("el-tabs"),b=m("el-form-item"),_=m("el-option"),M=m("el-select"),G=m("el-input-number"),se=m("el-form"),ie=m("el-dialog");return h(),D("div",Pe,[u("div",Re,[u("div",je,[u("div",ze,[o(d,{modelValue:q.value,"onUpdate:modelValue":e[0]||(e[0]=n=>q.value=n),placeholder:"搜索节点名称","prefix-icon":"Search",clearable:"",size:"small",style:{width:"150px"}},null,8,["modelValue"]),o(i,{type:"primary",icon:"Plus",onClick:le,size:"small",style:{"margin-left":"8px"}},{default:a(()=>e[14]||(e[14]=[N("新增节点")])),_:1,__:[14]})]),o(c(Se),{ref_key:"nodeTree",ref:J,data:U.value,props:X,"filter-node-method":W,onNodeClick:ee,onNodeContextmenu:oe,"node-key":"bomStructureId","default-expand-all":"","highlight-current":!0},{default:a(({node:n,data:me})=>[u("div",Qe,[u("span",null,_e(n.label),1),o(c(Ne),{onCommand:ce=>te(ce,me)},{dropdown:a(()=>[o(c(Ie),null,{default:a(()=>[o(c(O),{command:"addChild"},{default:a(()=>e[15]||(e[15]=[N("新增子节点")])),_:1,__:[15]}),o(c(O),{command:"edit"},{default:a(()=>e[16]||(e[16]=[N("编辑节点")])),_:1,__:[16]}),o(c(O),{command:"delete"},{default:a(()=>e[17]||(e[17]=[N("删除节点")])),_:1,__:[17]})]),_:1})]),default:a(()=>[u("span",$e,[o(y,{class:"more-icon"},{default:a(()=>[o(c(ge))]),_:1})])]),_:2},1032,["onCommand"])])]),_:1},8,["data"])]),u("div",Ge,[r.value?(h(),D("div",Ke,[u("div",Xe,[o(i,{type:"primary",onClick:de},{default:a(()=>e[18]||(e[18]=[N("保存节点信息")])),_:1,__:[18]})]),o(ue,{modelValue:F.value,"onUpdate:modelValue":e[1]||(e[1]=n=>F.value=n),type:"border-card"},{default:a(()=>[o(S,{label:"节点信息",name:"nodeInfo"},{default:a(()=>[o(Ee,{"bom-id":g.bomId,"bom-structure-id":r.value.bomStructureId,"selected-node":r.value,onNodeUpdated:re},null,8,["bom-id","bom-structure-id","selected-node"])]),_:1}),o(S,{label:"属性信息",name:"attributes"},{default:a(()=>[o(Ue,{"bom-id":g.bomId,"node-name":r.value.nodeName,"bom-structure-id":r.value.bomStructureId},null,8,["bom-id","node-name","bom-structure-id"])]),_:1}),o(S,{label:"关联产品",name:"products"},{default:a(()=>[o(Me,{"bom-id":g.bomId,"bom-structure-id":r.value.bomStructureId},null,8,["bom-id","bom-structure-id"])]),_:1}),o(S,{label:"动态属性",name:"dynamicProps"},{default:a(()=>[o(Oe,{"bom-id":g.bomId,"bom-structure-id":r.value.bomStructureId},null,8,["bom-id","bom-structure-id"])]),_:1}),o(S,{label:"其他",name:"other"},{default:a(()=>[o(Je,{"bom-id":g.bomId,"bom-structure-id":r.value.bomStructureId},null,8,["bom-id","bom-structure-id"])]),_:1})]),_:1},8,["modelValue"])])):(h(),D("div",He,[o(x,{description:"请选择或新增一个节点"})]))])]),ye(u("div",{class:"context-menu",style:ke({left:L.value+"px",top:A.value+"px"}),onClick:e[2]||(e[2]=Ce(()=>{},["stop"]))},[u("div",{class:"menu-item",onClick:j},[o(y,null,{default:a(()=>[o(c(xe))]),_:1}),e[19]||(e[19]=u("span",null,"新增子节点",-1))]),u("div",{class:"menu-item",onClick:z},[o(y,null,{default:a(()=>[o(c(he))]),_:1}),e[20]||(e[20]=u("span",null,"编辑节点",-1))]),u("div",{class:"menu-item",onClick:ae},[o(y,null,{default:a(()=>[o(c(we))]),_:1}),e[21]||(e[21]=u("span",null,"删除节点",-1))])],4),[[Ve,I.value]]),o(ie,{title:k.value,modelValue:v.value,"onUpdate:modelValue":e[13]||(e[13]=n=>v.value=n),width:"600px","append-to-body":""},{footer:a(()=>[u("span",Ye,[o(i,{onClick:e[12]||(e[12]=n=>v.value=!1)},{default:a(()=>e[22]||(e[22]=[N("取消")])),_:1,__:[22]}),o(i,{type:"primary",onClick:ne},{default:a(()=>e[23]||(e[23]=[N("确定")])),_:1,__:[23]})])]),default:a(()=>[o(se,{ref_key:"dialogFormRef",ref:E,model:l,rules:Y,"label-width":"120px"},{default:a(()=>[o(b,{label:"节点编码",prop:"nodeCode"},{default:a(()=>[o(d,{modelValue:l.nodeCode,"onUpdate:modelValue":e[3]||(e[3]=n=>l.nodeCode=n),placeholder:"自动生成",disabled:""},null,8,["modelValue"])]),_:1}),o(b,{label:"节点名称",prop:"nodeName"},{default:a(()=>[o(d,{modelValue:l.nodeName,"onUpdate:modelValue":e[4]||(e[4]=n=>l.nodeName=n),placeholder:"请输入节点名称"},null,8,["modelValue"])]),_:1}),o(b,{label:"节点类型",prop:"nodeType"},{default:a(()=>[o(M,{modelValue:l.nodeType,"onUpdate:modelValue":e[5]||(e[5]=n=>l.nodeType=n),placeholder:"请选择节点类型"},{default:a(()=>[o(_,{label:"物料",value:"0"}),o(_,{label:"组件",value:"1"}),o(_,{label:"服务",value:"2"}),o(_,{label:"参数要求",value:"3"})]),_:1},8,["modelValue"])]),_:1}),o(b,{label:"父节点",prop:"parentNodeId"},{default:a(()=>[o(M,{modelValue:l.parentNodeId,"onUpdate:modelValue":e[6]||(e[6]=n=>l.parentNodeId=n),placeholder:"请选择父节点",disabled:T.value},{default:a(()=>[(h(!0),D(Te,null,Be(P(),n=>(h(),De(_,{key:n.bomStructureId,label:n.nodeName,value:n.bomStructureId},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),o(b,{label:"数量",prop:"quantity"},{default:a(()=>[o(G,{modelValue:l.quantity,"onUpdate:modelValue":e[7]||(e[7]=n=>l.quantity=n),min:0,step:1,placeholder:"请输入数量"},null,8,["modelValue"])]),_:1}),o(b,{label:"单位",prop:"unit"},{default:a(()=>[o(d,{modelValue:l.unit,"onUpdate:modelValue":e[8]||(e[8]=n=>l.unit=n),placeholder:"请输入单位"},null,8,["modelValue"])]),_:1}),o(b,{label:"状态",prop:"status"},{default:a(()=>[o(M,{modelValue:l.status,"onUpdate:modelValue":e[9]||(e[9]=n=>l.status=n),placeholder:"请选择状态"},{default:a(()=>[o(_,{label:"启用",value:"enabled"}),o(_,{label:"禁用",value:"disabled"})]),_:1},8,["modelValue"])]),_:1}),o(b,{label:"优先级",prop:"priority"},{default:a(()=>[o(G,{modelValue:l.priority,"onUpdate:modelValue":e[10]||(e[10]=n=>l.priority=n),min:1,max:10,step:1,placeholder:"请输入优先级"},null,8,["modelValue"])]),_:1}),o(b,{label:"描述",prop:"description"},{default:a(()=>[o(d,{modelValue:l.description,"onUpdate:modelValue":e[11]||(e[11]=n=>l.description=n),type:"textarea",placeholder:"请输入节点描述",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue"])])}}},co=pe(We,[["__scopeId","data-v-5d7c9449"]]);export{co as default};
