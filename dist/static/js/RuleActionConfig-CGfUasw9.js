import{x as O,_ as X,r as R,h as D,i as Z,a as N,c as S,o as v,b as a,w as t,q as M,N as e,ap as aa,e as y,am as ea,t as A,aq as la,f as P,ar as U,G as $,ah as ta,ai as oa,as as ua,k as F,at as c,au as C,av as d,aw as f,v as B,ax as w,ay as sa,m as I,F as da,ag as na,E as b}from"./index-a6CENfl-.js";import{d as ra}from"./vuedraggable.umd-Bj5WI46O.js";import"./sortable.esm-FPj9zfT8.js";function ca(g){return O({url:`/cpq/ruleAction/listByRuleId/${g}`,method:"get"})}function ia(g){return O({url:"/cpq/ruleAction",method:"post",data:g})}function pa(g){return O({url:"/cpq/ruleAction",method:"put",data:g})}function ma(g){return O({url:`/cpq/ruleAction/${g}`,method:"delete"})}function fa(g,J){return O({url:`/cpq/ruleAction/saveRuleActions/${g}`,method:"post",data:J})}const _a={class:"rule-action-config"},va={class:"card-header"},ga={class:"header-buttons"},Va={key:0,class:"empty-actions"},ya={class:"action-item"},ba=["onClick"],ha={class:"action-index"},Pa={class:"action-type-tag"},Ia={class:"action-name"},Sa={class:"action-description"},Ua={class:"item-actions"},ka={key:0,class:"action-content"},Na={key:0,class:"structured-params"},Ca={key:1,class:"params-placeholder"},wa={class:"form-actions"},Oa={__name:"RuleActionConfig",props:{modelValue:{type:Array,default:()=>[]},ruleType:{type:String,default:"validation"},ruleId:{type:[String,Number],default:null}},emits:["update:modelValue","update:actions"],setup(g,{emit:J}){const h=g,E=J,p=R([...h.modelValue]),V=R(null),x=R(null);D(()=>h.modelValue,u=>{JSON.stringify(u)!==JSON.stringify(p.value)&&(p.value=[...u])},{deep:!0}),D(()=>h.ruleId,u=>{actionForm.value.ruleId=u,u&&q(u)});const q=async u=>{var s,i;try{const n=await ca(u);p.value=n.data||[],k()}catch(n){console.error("加载动作失败:",n),b.error("加载动作失败："+(((i=(s=n.response)==null?void 0:s.data)==null?void 0:i.message)||n.message||"未知错误"))}};Z(()=>{h.ruleId&&q(h.ruleId)});const j=u=>({enable:"启用",disable:"禁用",required:"必选",recommend:"推荐",show:"显示",hide:"隐藏",exclude:"排除",reset:"重置",focus:"聚焦",linkSelect:"联动选中",applyDiscount:"应用折扣",applyFullReduction:"应用满减",setPrice:"设置价格",adjustPrice:"价格调整",showMessage:"显示消息",sendNotification:"发送通知",triggerWarning:"触发警告",setVariable:"设置变量",callApi:"调用API",triggerRule:"触发规则",calculate:"计算",validate:"验证",notify:"通知",data:"数据操作",redirect:"跳转"})[u]||u,z=u=>({enable:"success",disable:"danger",required:"warning",recommend:"info",show:"primary",hide:"default",exclude:"danger",reset:"warning",focus:"info",linkSelect:"primary",applyDiscount:"success",applyFullReduction:"warning",setPrice:"primary",adjustPrice:"info",showMessage:"info",sendNotification:"success",triggerWarning:"warning",setVariable:"primary",callApi:"info",triggerRule:"success",calculate:"primary",validate:"success",notify:"warning",data:"info",redirect:"danger"})[u]||"default",_=(u,s,i)=>{u.actionParams||(u.actionParams="{}");try{const n=JSON.parse(u.actionParams);n[s]=i,u.actionParams=JSON.stringify(n,null,2)}catch(n){console.error("更新动作参数失败:",n),b.error("更新动作参数失败："+n.message)}},W=u=>{switch(u.actionType){case"enable":case"disable":case"required":case"recommend":case"show":case"hide":case"exclude":case"reset":case"focus":case"linkSelect":u.actionParams='{"target": ""}';break;case"applyDiscount":u.actionParams='{"type": "rate", "value": 0.9}';break;case"applyFullReduction":u.actionParams='{"threshold": 1000, "reduce": 100}';break;case"setPrice":u.actionParams='{"value": 100, "currency": "CNY"}';break;case"adjustPrice":u.actionParams='{"operator": "+", "value": 50}';break;case"showMessage":u.actionParams='{"level": "info", "title": "提示", "content": ""}';break;case"sendNotification":u.actionParams='{"type": "email", "recipient": "", "content": ""}';break;case"triggerWarning":u.actionParams='{"level": "warning", "message": ""}';break;case"setVariable":u.actionParams='{"variable": "", "value": ""}';break;case"callApi":u.actionParams='{"endpoint": "", "method": "POST", "headers": {}, "requestBody": {}, "onSuccess": {}, "onFailure": {}}';break;case"triggerRule":u.actionParams='{"ruleId": "", "params": {}}';break;case"calculate":u.actionParams='{"formula": ""}';break;case"validate":u.actionParams='{"rule": ""}';break;case"notify":u.actionParams='{"message": "", "type": "info"}';break;case"data":u.actionParams='{"operation": "", "data": {}}';break;case"redirect":u.actionParams='{"url": "", "target": "_self"}';break;default:u.actionParams=""}},Y=()=>{const u={actionId:null,ruleId:h.ruleId,actionType:"",actionName:"",actionCode:"",targetType:"",targetId:"",actionParams:"",actionPriority:1,parentActionId:null,actionSequence:p.value.length+1,executeCondition:'{"type": "always"}',actionStatus:"0",description:""};p.value.push(u),V.value=null,x.value=p.value.length-1,k()},G=async u=>{var s,i;try{if(u.actionId)await pa(u),b.success("动作更新成功"),V.value=null;else{const n=await ia(u),r=p.value.findIndex(m=>m===u);r!==-1&&(p.value[r]=n.data),b.success("动作添加成功"),V.value=null,x.value=null}k()}catch(n){console.error("保存动作失败:",n),b.error("保存动作失败："+(((i=(s=n.response)==null?void 0:s.data)==null?void 0:i.message)||n.message||"未知错误"))}},H=async u=>{var s,i;try{const n=p.value[u];n.actionId&&await ma(n.actionId),p.value.splice(u,1),b.success("动作删除成功"),k()}catch(n){console.error("删除动作失败:",n),b.error("删除动作失败："+(((i=(s=n.response)==null?void 0:s.data)==null?void 0:i.message)||n.message||"未知错误"))}},K=()=>{p.value.forEach((u,s)=>{u.actionSequence=s+1}),k(),b.success("动作顺序已更新")},L=async()=>{var u,s;if(!h.ruleId){b.warning("规则ID不能为空，无法保存动作列表");return}try{const i=await fa(h.ruleId,p.value);b.success(`动作列表保存成功，共${i.data}个动作`)}catch(i){console.error("保存动作列表失败:",i),b.error("保存动作列表失败："+(((s=(u=i.response)==null?void 0:u.data)==null?void 0:s.message)||i.message||"未知错误"))}},k=()=>{E("update:modelValue",p.value),E("update:actions",p.value)};return(u,s)=>{const i=N("Check"),n=N("el-icon"),r=N("el-col"),m=N("el-row"),Q=N("el-card");return v(),S("div",_a,[a(Q,{class:"action-chain",shadow:"hover"},{header:t(()=>[y("div",va,[s[4]||(s[4]=y("span",null,"动作执行链",-1)),y("div",ga,[a(e(U),{type:"success",size:"small",onClick:L,disabled:!h.ruleId},{default:t(()=>[a(n,null,{default:t(()=>[a(i)]),_:1}),s[2]||(s[2]=P(" 保存动作列表 "))]),_:1,__:[2]},8,["disabled"]),a(e(U),{type:"primary",size:"small",onClick:Y},{default:t(()=>[a(n,null,{default:t(()=>[a(e(na))]),_:1}),s[3]||(s[3]=P(" 添加动作 "))]),_:1,__:[3]})])])]),default:t(()=>[p.value.length===0?(v(),S("div",Va,[a(e(aa),{description:"暂无动作"})])):M("",!0),a(e(ra),{modelValue:p.value,"onUpdate:modelValue":s[1]||(s[1]=l=>p.value=l),"item-key":"actionId",handle:".drag-handle","ghost-class":"ghost",onEnd:K},{item:t(({element:l,index:T})=>[y("div",ya,[y("div",{class:"item-header",onClick:o=>V.value===l.actionId?V.value=null:V.value=l.actionId},[a(n,{class:"drag-handle"},{default:t(()=>[a(e(ea))]),_:1}),y("span",ha,A(T+1),1),y("div",Pa,[a(e(la),{type:z(l.actionType)},{default:t(()=>[P(A(j(l.actionType)),1)]),_:2},1032,["type"])]),y("div",Ia,A(l.actionName||"未命名动作"),1),y("div",Sa,A(l.description||"无描述"),1)],8,ba),y("div",Ua,[a(e(U),{type:"primary",size:"small",onClick:$(o=>V.value===l.actionId?V.value=null:V.value=l.actionId,["stop"])},{default:t(()=>[a(n,null,{default:t(()=>[a(e(ta))]),_:1}),s[5]||(s[5]=P(" 编辑 "))]),_:2,__:[5]},1032,["onClick"]),a(e(U),{type:"danger",size:"small",onClick:$(o=>H(T),["stop"])},{default:t(()=>[a(n,null,{default:t(()=>[a(e(oa))]),_:1}),s[6]||(s[6]=P(" 删除 "))]),_:2,__:[6]},1032,["onClick"])]),V.value===l.actionId||l.actionId===null&&x.value===T?(v(),S("div",ka,[a(e(ua),{model:l,"label-position":"top","label-width":"100px"},{default:t(()=>[a(m,{gutter:20},{default:t(()=>[a(r,{span:12},{default:t(()=>[a(e(c),{label:"动作类型"},{default:t(()=>[a(e(C),{modelValue:l.actionType,"onUpdate:modelValue":o=>l.actionType=o,placeholder:"请选择动作类型",onChange:o=>W(l)},{default:t(()=>[a(e(d),{label:"启用",value:"enable"}),a(e(d),{label:"禁用",value:"disable"}),a(e(d),{label:"必选",value:"required"}),a(e(d),{label:"推荐",value:"recommend"}),a(e(d),{label:"显示",value:"show"}),a(e(d),{label:"隐藏",value:"hide"}),a(e(d),{label:"排除",value:"exclude"}),a(e(d),{label:"重置",value:"reset"}),a(e(d),{label:"聚焦",value:"focus"}),a(e(d),{label:"联动选中",value:"linkSelect"}),a(e(d),{label:"应用折扣",value:"applyDiscount"}),a(e(d),{label:"应用满减",value:"applyFullReduction"}),a(e(d),{label:"设置价格",value:"setPrice"}),a(e(d),{label:"价格调整",value:"adjustPrice"}),a(e(d),{label:"显示消息",value:"showMessage"}),a(e(d),{label:"发送通知",value:"sendNotification"}),a(e(d),{label:"触发警告",value:"triggerWarning"}),a(e(d),{label:"设置变量",value:"setVariable"}),a(e(d),{label:"调用API",value:"callApi"}),a(e(d),{label:"触发规则",value:"triggerRule"})]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1024)]),_:2},1024),F(a(r,{span:12},{default:t(()=>[a(e(c),{label:"动作名称"},{default:t(()=>[a(e(f),{modelValue:l.actionName,"onUpdate:modelValue":o=>l.actionName=o,placeholder:"请输入动作名称"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1536),[[B,!1]])]),_:2},1024),a(m,{gutter:20},{default:t(()=>[F(a(r,{span:12},{default:t(()=>[a(e(c),{label:"动作编码"},{default:t(()=>[a(e(f),{modelValue:l.actionCode,"onUpdate:modelValue":o=>l.actionCode=o,placeholder:"请输入动作编码"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1536),[[B,!1]]),a(r,{span:12},{default:t(()=>[a(e(c),{label:"目标类型"},{default:t(()=>[a(e(C),{modelValue:l.targetType,"onUpdate:modelValue":o=>l.targetType=o,placeholder:"请选择目标类型"},{default:t(()=>[a(e(d),{label:"节点",value:"node"}),a(e(d),{label:"产品",value:"product"}),a(e(d),{label:"变量",value:"variable"}),a(e(d),{label:"全局",value:"global"})]),_:2},1032,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024),a(m,{gutter:20},{default:t(()=>[a(r,{span:12},{default:t(()=>[a(e(c),{label:"目标ID"},{default:t(()=>[a(e(f),{modelValue:l.targetId,"onUpdate:modelValue":o=>l.targetId=o,placeholder:"请输入目标ID"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024),a(r,{span:12},{default:t(()=>[a(e(c),{label:"动作优先级"},{default:t(()=>[a(e(w),{modelValue:l.actionPriority,"onUpdate:modelValue":o=>l.actionPriority=o,min:1,max:100,step:1,placeholder:"请输入优先级"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024),a(m,{gutter:20},{default:t(()=>[a(r,{span:12},{default:t(()=>[a(e(c),{label:"动作状态"},{default:t(()=>[a(e(sa),{modelValue:l.actionStatus,"onUpdate:modelValue":o=>l.actionStatus=o,"active-value":"0","inactive-value":"1"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024),a(r,{span:12},{default:t(()=>[a(e(c),{label:"动作序列"},{default:t(()=>[a(e(w),{modelValue:l.actionSequence,"onUpdate:modelValue":o=>l.actionSequence=o,min:1,max:100,step:1,placeholder:"请输入动作序列"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024),a(m,{gutter:20},{default:t(()=>[a(r,{span:24},{default:t(()=>[a(e(c),{label:"动作参数"},{default:t(()=>[l.actionType&&l.actionParams?(v(),S("div",Na,[["enable","disable","required","recommend","show","hide","exclude","reset","focus","linkSelect"].includes(l.actionType)?(v(),I(m,{key:0,gutter:20},{default:t(()=>[a(r,{span:12},{default:t(()=>[a(e(c),{label:"目标对象"},{default:t(()=>[a(e(f),{modelValue:JSON.parse(l.actionParams).target,"onUpdate:modelValue":o=>JSON.parse(l.actionParams).target=o,onInput:o=>_(l,"target",o),placeholder:"请输入目标对象"},null,8,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1024)]),_:2},1024)]),_:2},1024)):l.actionType==="triggerRule"?(v(),I(m,{key:1,gutter:20},{default:t(()=>[a(r,{span:12},{default:t(()=>[a(e(c),{label:"规则ID"},{default:t(()=>[a(e(f),{modelValue:JSON.parse(l.actionParams).ruleId,"onUpdate:modelValue":o=>JSON.parse(l.actionParams).ruleId=o,onInput:o=>_(l,"ruleId",o),placeholder:"请输入规则ID"},null,8,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1024)]),_:2},1024),a(r,{span:12},{default:t(()=>[a(e(c),{label:"规则参数"},{default:t(()=>[a(e(f),{modelValue:l.actionParams,"onUpdate:modelValue":o=>l.actionParams=o,type:"textarea",rows:2,placeholder:"请输入规则参数(JSON格式)"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024)):l.actionType==="applyDiscount"?(v(),I(m,{key:2,gutter:20},{default:t(()=>[a(r,{span:12},{default:t(()=>[a(e(c),{label:"折扣类型"},{default:t(()=>[a(e(C),{modelValue:JSON.parse(l.actionParams).type,"onUpdate:modelValue":o=>JSON.parse(l.actionParams).type=o,onChange:o=>_(l,"type",o)},{default:t(()=>[a(e(d),{label:"固定折扣",value:"rate"}),a(e(d),{label:"动态变量",value:"variable"})]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1024)]),_:2},1024),a(r,{span:12},{default:t(()=>[a(e(c),{label:"折扣值"},{default:t(()=>[a(e(f),{modelValue:JSON.parse(l.actionParams).value,"onUpdate:modelValue":o=>JSON.parse(l.actionParams).value=o,onInput:o=>_(l,"value",o),placeholder:"请输入折扣值，如0.9或$折扣率$"},null,8,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1024)]),_:2},1024)]),_:2},1024)):l.actionType==="applyFullReduction"?(v(),I(m,{key:3,gutter:20},{default:t(()=>[a(r,{span:12},{default:t(()=>[a(e(c),{label:"满减阈值"},{default:t(()=>[a(e(w),{modelValue:JSON.parse(l.actionParams).threshold,"onUpdate:modelValue":o=>JSON.parse(l.actionParams).threshold=o,onChange:o=>_(l,"threshold",o),min:0,step:100,placeholder:"请输入满减阈值"},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1024)]),_:2},1024),a(r,{span:12},{default:t(()=>[a(e(c),{label:"减免金额"},{default:t(()=>[a(e(w),{modelValue:JSON.parse(l.actionParams).reduce,"onUpdate:modelValue":o=>JSON.parse(l.actionParams).reduce=o,onChange:o=>_(l,"reduce",o),min:0,step:50,placeholder:"请输入减免金额"},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1024)]),_:2},1024)]),_:2},1024)):l.actionType==="setPrice"?(v(),I(m,{key:4,gutter:20},{default:t(()=>[a(r,{span:12},{default:t(()=>[a(e(c),{label:"价格"},{default:t(()=>[a(e(w),{modelValue:JSON.parse(l.actionParams).value,"onUpdate:modelValue":o=>JSON.parse(l.actionParams).value=o,onChange:o=>_(l,"value",o),min:0,step:10,placeholder:"请输入价格"},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1024)]),_:2},1024),a(r,{span:12},{default:t(()=>[a(e(c),{label:"货币"},{default:t(()=>[a(e(C),{modelValue:JSON.parse(l.actionParams).currency,"onUpdate:modelValue":o=>JSON.parse(l.actionParams).currency=o,onChange:o=>_(l,"currency",o)},{default:t(()=>[a(e(d),{label:"人民币",value:"CNY"}),a(e(d),{label:"美元",value:"USD"}),a(e(d),{label:"欧元",value:"EUR"})]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1024)]),_:2},1024)]),_:2},1024)):l.actionType==="showMessage"?(v(),S(da,{key:5},[a(m,{gutter:20},{default:t(()=>[a(r,{span:8},{default:t(()=>[a(e(c),{label:"消息级别"},{default:t(()=>[a(e(C),{modelValue:JSON.parse(l.actionParams).level,"onUpdate:modelValue":o=>JSON.parse(l.actionParams).level=o,onChange:o=>_(l,"level",o)},{default:t(()=>[a(e(d),{label:"信息",value:"info"}),a(e(d),{label:"成功",value:"success"}),a(e(d),{label:"警告",value:"warning"}),a(e(d),{label:"错误",value:"error"})]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"])]),_:2},1024)]),_:2},1024),a(r,{span:16},{default:t(()=>[a(e(c),{label:"消息标题"},{default:t(()=>[a(e(f),{modelValue:JSON.parse(l.actionParams).title,"onUpdate:modelValue":o=>JSON.parse(l.actionParams).title=o,onInput:o=>_(l,"title",o),placeholder:"请输入消息标题"},null,8,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1024)]),_:2},1024)]),_:2},1024),a(m,{gutter:20},{default:t(()=>[a(r,{span:24},{default:t(()=>[a(e(c),{label:"消息内容"},{default:t(()=>[a(e(f),{modelValue:JSON.parse(l.actionParams).content,"onUpdate:modelValue":o=>JSON.parse(l.actionParams).content=o,onInput:o=>_(l,"content",o),type:"textarea",rows:2,placeholder:"请输入消息内容"},null,8,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1024)]),_:2},1024)]),_:2},1024)],64)):l.actionType==="setVariable"?(v(),I(m,{key:6,gutter:20},{default:t(()=>[a(r,{span:12},{default:t(()=>[a(e(c),{label:"变量名称"},{default:t(()=>[a(e(f),{modelValue:JSON.parse(l.actionParams).variable,"onUpdate:modelValue":o=>JSON.parse(l.actionParams).variable=o,onInput:o=>_(l,"variable",o),placeholder:"请输入变量名称"},null,8,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1024)]),_:2},1024),a(r,{span:12},{default:t(()=>[a(e(c),{label:"变量值"},{default:t(()=>[a(e(f),{modelValue:JSON.parse(l.actionParams).value,"onUpdate:modelValue":o=>JSON.parse(l.actionParams).value=o,onInput:o=>_(l,"value",o),placeholder:"请输入变量值"},null,8,["modelValue","onUpdate:modelValue","onInput"])]),_:2},1024)]),_:2},1024)]),_:2},1024)):(v(),I(e(f),{key:7,modelValue:l.actionParams,"onUpdate:modelValue":o=>l.actionParams=o,type:"textarea",rows:4,placeholder:"请输入动作参数（JSON格式）"},null,8,["modelValue","onUpdate:modelValue"]))])):(v(),S("div",Ca," 请先选择动作类型，系统会自动生成默认参数结构 "))]),_:2},1024)]),_:2},1024)]),_:2},1024),a(m,{gutter:20},{default:t(()=>[a(r,{span:24},{default:t(()=>[a(e(c),{label:"执行条件"},{default:t(()=>[a(e(f),{modelValue:l.executeCondition,"onUpdate:modelValue":o=>l.executeCondition=o,type:"textarea",rows:3,placeholder:"请输入执行条件（JSON格式）"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024),a(m,{gutter:20},{default:t(()=>[a(r,{span:24},{default:t(()=>[a(e(c),{label:"描述"},{default:t(()=>[a(e(f),{modelValue:l.description,"onUpdate:modelValue":o=>l.description=o,type:"textarea",rows:2,placeholder:"请输入动作描述"},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024)]),_:2},1024),y("div",wa,[a(e(U),{type:"primary",onClick:o=>G(l)},{default:t(()=>s[7]||(s[7]=[P("保存")])),_:2,__:[7]},1032,["onClick"]),a(e(U),{onClick:s[0]||(s[0]=o=>V.value=null)},{default:t(()=>s[8]||(s[8]=[P("取消")])),_:1,__:[8]})])]),_:2},1032,["model"])])):M("",!0)])]),_:1},8,["modelValue"])]),_:1})])}}},Ta=X(Oa,[["__scopeId","data-v-ff86422f"]]);export{Ta as default};
