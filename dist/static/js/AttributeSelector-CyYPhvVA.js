import{_ as O,r as v,g as x,H as q,a as k,c as V,o as s,m as y,k as U,w as f,b as A,F as S,n as h,E as p}from"./index-DgigFOm-.js";import{q as E,i as $}from"./bom-CjuVRwkz.js";import{g as F}from"./superBomDynamicAttribute-6n4Uab6m.js";import{g as H}from"./superBomProductRelation-c5nmns4w.js";import{d as B}from"./index-DAib79Lj.js";const J={class:"attribute-selector"},M={__name:"AttributeSelector",props:{modelValue:{type:[String,Number,Array],default:""},attributeType:{type:String,required:!0,validator:u=>["static","dynamic","attributeValue","product"].includes(u)},bomId:{type:[String,Number],default:""},nodeId:{type:[String,Number],default:""},structureId:{type:[String,Number],default:""},attributeId:{type:[String,Number],default:""},attrInfo:{type:Object,default:null},dynamicValues:{type:Array,default:()=>[]},label:{type:String,default:"选择"},placeholder:{type:String,default:"请选择"},multiple:{type:Boolean,default:!0},required:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1}},emits:["update:modelValue","change"],setup(u,{emit:N}){const e=u,T=N,c=v(!1),i=v([]),n=v([]),m=v([]),b=x({get:()=>{if(e.modelValue===void 0||e.modelValue===null||e.modelValue==="")return e.multiple?[]:"";if(Array.isArray(e.modelValue))return e.modelValue.filter(t=>t!=null&&t!=="").map(t=>typeof t=="string"?t:String(t));const l=typeof e.modelValue=="string"?e.modelValue:String(e.modelValue);return l.trim()===""?e.multiple?[]:"":e.multiple&&l.includes(",")?l.split(",").map(t=>t.trim()).filter(t=>t!==""):e.multiple?[l]:l},set:l=>T("update:modelValue",l)}),L=B(async()=>{if(!(!e.nodeId||!e.bomId)){c.value=!0;try{const l=await $({bomId:e.bomId,bomStructureId:e.nodeId});l.code===200?(i.value=l.rows,i.value=i.value.map(a=>({...a,attributeType:a.attributeType||"selector"})),console.log("静态属性列表:",l),g()):p.error("加载静态属性失败")}catch(l){console.error("加载静态属性失败:",l),p.error("加载静态属性失败")}finally{c.value=!1}}},300),D=B(async()=>{if(e.nodeId){c.value=!0;try{const l=await F(e.nodeId);l.code===200?(i.value=l.data,i.value=i.value.map(a=>({...a,attributeType:a.attributeType||"selector"})),g()):p.error("加载动态属性失败")}catch(l){console.error("加载动态属性失败:",l),p.error("加载动态属性失败")}finally{c.value=!1}}},300),C=B(async()=>{if(!e.attributeId)return;console.log("props.attributeType:",e.attributeType),console.log("props.dynamicValues:",e.dynamicValues),console.log("props.attrInfo:",e.attrInfo);const l=e.attributeType==="attributeValue"&&e.attrInfo&&e.attrInfo.attributeValues&&e.dynamicValues;if(l){console.log("使用传入的dynamicValues:",e.dynamicValues),console.log("dynamicValues类型:",typeof e.dynamicValues),console.log("是否为数组:",Array.isArray(e.dynamicValues));let t=[];if(Array.isArray(e.dynamicValues))t=e.dynamicValues;else if(typeof e.dynamicValues=="string"){const d=e.dynamicValues.trim();try{const o=JSON.parse(d);if(Array.isArray(o))t=o;else{n.value=[],console.log("dynamicValues解析后不是数组，返回空数组");return}}catch{t=d.split(",").map(j=>j.trim())}}else{n.value=[],console.log("dynamicValues不是数组，返回空数组");return}const r=t.filter(d=>d!=null&&d!=="");if(r.length===0){n.value=[],console.log("没有有效的dynamicValues，返回空数组");return}typeof r[0]=="string"?n.value=r.map((d,o)=>({valueId:o+1,valueName:d})):typeof r[0]=="object"?n.value=r:n.value=[],console.log("转换后的dynamicValues:",n.value),g();return}const a=e.structureId||e.nodeId;if(console.log("加载属性值：参数信息"),console.log("props.attributeType:",e.attributeType),console.log("props.structureId:",e.structureId),console.log("props.nodeId:",e.nodeId),console.log("effectiveStructureId:",a),console.log("props.attributeId:",e.attributeId),console.log("props.attrInfo:",e.attrInfo),console.log("isDynamicAttr:",l),!a||!e.attributeId){console.log("结构ID或属性ID为空，不调用API"),n.value=[];return}c.value=!0;try{console.log("调用API获取属性值:",a,e.attributeId);const t=await E(a,e.attributeId);console.log("API返回结果:",t),t.code===200?(n.value=t.rows||t.data,console.log("处理后的属性值列表:",n.value),g()):p.error("加载属性值失败")}catch(t){console.error("加载属性值失败:",t),p.error("加载属性值失败")}finally{c.value=!1}},300),P=B(async()=>{if(m.value=[],console.log("当前modelValue:",e.modelValue),console.log("modelValue类型:",typeof e.modelValue),console.log("bomId:",e.bomId),console.log("nodeId:",e.nodeId),!e.nodeId||!e.bomId){console.log("产品选择：nodeId或bomId为空，无法加载产品列表");return}c.value=!0;try{const l=await H({bomId:e.bomId,structureId:e.nodeId});if(l.code===200){let a=[];Array.isArray(l.data)?a=l.data:l.data&&Array.isArray(l.data.rows)?a=l.data.rows:l.rows&&(a=l.rows),console.log("原始产品数据:",a),m.value=a.map(t=>{const r=t.relationObjectId;return console.log("产品relationObjectId:",r),{...t,productId:r}}),console.log("处理后的产品列表:",m.value),console.log("产品列表长度:",m.value.length),g()}else p.error("加载产品失败")}catch(l){console.error("加载产品失败:",l),p.error("加载产品失败")}finally{c.value=!1}},300),g=()=>{if(!e.modelValue)return;let l=null,a=[];switch(typeof e.modelValue=="string"?e.modelValue.includes(",")?a=e.modelValue.split(",").map(t=>t.trim()):a=[e.modelValue]:Array.isArray(e.modelValue)?a=e.modelValue:a=[e.modelValue],console.log("处理后的modelValues:",a),e.attributeType){case"static":l=a.map(t=>i.value.find(r=>String(r.id)===String(t))).filter(Boolean),l.length===1&&!Array.isArray(e.modelValue)&&(l=l[0]);break;case"dynamic":l=a.map(t=>i.value.find(r=>String(r.id)===String(t))).filter(Boolean),l.length===1&&!Array.isArray(e.modelValue)&&(l=l[0]);break;case"attributeValue":l=a.map(t=>n.value.find(r=>String(r.valueId)===String(t))).filter(Boolean),l.length===1&&!Array.isArray(e.modelValue)&&(l=l[0]);break;case"product":l=a.map(t=>m.value.find(r=>String(r.productId)===String(t))).filter(Boolean),l.length===1&&!Array.isArray(e.modelValue)&&(l=l[0]);break}console.log(`初始化选中的${e.attributeType}属性:`,l),T("change",e.modelValue,l)},I=l=>{let a=null;e.attributeType==="static"?Array.isArray(l)?a=l.map(t=>i.value.find(r=>String(r.id)===t)).filter(Boolean):a=i.value.find(t=>String(t.id)===l):e.attributeType==="dynamic"?Array.isArray(l)?a=l.map(t=>i.value.find(r=>String(r.id)===t)).filter(Boolean):a=i.value.find(t=>String(t.id)===l):e.attributeType==="attributeValue"?Array.isArray(l)?a=l.map(t=>n.value.find(r=>String(r.valueId)===t)).filter(Boolean):a=n.value.find(t=>String(t.valueId)===l):e.attributeType==="product"&&(console.log("产品选择值:",l),console.log("产品列表:",m.value),Array.isArray(l)?(a=l.map(t=>{const r=m.value.find(d=>String(d.productId)===t);return console.log("找到的产品:",r),r}).filter(Boolean),console.log("多选时选中的产品:",a)):(a=m.value.find(t=>String(t.productId)===l),console.log("单选时选中的产品:",a))),T("change",l,a)},w=()=>{switch(e.attributeType){case"static":L();break;case"dynamic":D();break;case"attributeValue":C();break;case"product":console.log("产品选择参数:",e),P();break}};return q(()=>[e.attributeType,e.nodeId,e.attributeId,e.dynamicValues],()=>{w()},{immediate:!0,deep:!0}),q(()=>e.modelValue,l=>{console.log("modelValue变化:",l),w()},{immediate:!0}),(l,a)=>{const t=k("el-option"),r=k("el-select"),d=k("el-form-item");return s(),V("div",J,[u.attributeType==="static"?(s(),y(d,{key:0,label:u.label,required:u.required},{default:f(()=>[A(r,{modelValue:b.value,"onUpdate:modelValue":a[0]||(a[0]=o=>b.value=o),multiple:u.multiple,placeholder:u.placeholder,loading:c.value,disabled:u.disabled,clearable:"",filterable:"",style:{width:"100%"},onChange:I},{default:f(()=>[(s(!0),V(S,null,h(i.value,o=>(s(),y(t,{key:o.id,label:o.attributeName,value:String(o.id)},null,8,["label","value"]))),128))]),_:1},8,["modelValue","multiple","placeholder","loading","disabled"])]),_:1},8,["label","required"])):u.attributeType==="dynamic"?(s(),y(d,{key:1,label:u.label,required:u.required},{default:f(()=>[A(r,{modelValue:b.value,"onUpdate:modelValue":a[1]||(a[1]=o=>b.value=o),multiple:u.multiple,placeholder:u.placeholder,loading:c.value,disabled:u.disabled,clearable:"",filterable:"",style:{width:"100%"},onChange:I},{default:f(()=>[(s(!0),V(S,null,h(i.value,o=>(s(),y(t,{key:o.id,label:o.attributeName,value:String(o.id)},null,8,["label","value"]))),128))]),_:1},8,["modelValue","multiple","placeholder","loading","disabled"])]),_:1},8,["label","required"])):u.attributeType==="attributeValue"?(s(),y(d,{key:2,label:u.label,required:u.required},{default:f(()=>[A(r,{modelValue:b.value,"onUpdate:modelValue":a[2]||(a[2]=o=>b.value=o),multiple:u.multiple,placeholder:u.placeholder,loading:c.value,disabled:u.disabled,clearable:"",filterable:"",style:{width:"100%"},onChange:I},{default:f(()=>[(s(!0),V(S,null,h(n.value,o=>(s(),y(t,{key:o.valueId,label:o.valueName,value:String(o.valueId)},null,8,["label","value"]))),128))]),_:1},8,["modelValue","multiple","placeholder","loading","disabled"])]),_:1},8,["label","required"])):u.attributeType==="product"?(s(),y(d,{key:3,label:u.label,required:u.required},{default:f(()=>[A(r,{modelValue:b.value,"onUpdate:modelValue":a[3]||(a[3]=o=>b.value=o),multiple:u.multiple,placeholder:u.placeholder,loading:c.value,disabled:u.disabled,clearable:"",filterable:"",style:{width:"100%"},onChange:I},{default:f(()=>[(s(!0),V(S,null,h(m.value,o=>(s(),y(t,{key:o.productId,label:`${o.relationTypeName} / ${o.relationObjectName||""}`,value:String(o.productId)},null,8,["label","value"]))),128))]),_:1},8,["modelValue","multiple","placeholder","loading","disabled"])]),_:1},8,["label","required"])):U("",!0)])}}},_=O(M,[["__scopeId","data-v-78de6ed9"]]);export{_ as default};
