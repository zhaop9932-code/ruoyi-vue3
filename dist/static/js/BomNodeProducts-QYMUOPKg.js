import{x as $,_ as He,r as i,g as R,B as W,h as Je,i as We,a as m,j as Xe,c as C,o as u,e as s,k as Ye,b as o,w as l,f as v,m as g,q as X,t as _,F as L,s as F,E as y,n as Ce}from"./index-kbfDsxmo.js";import{listProduct as Ze}from"./product-CAJLpTLf.js";import{b as et}from"./series-Bcmj16bf.js";import{l as Ne}from"./catalog-BurGbDor.js";function tt(I){return $({url:"/cpq/superBomProductRelation/getByBomId",method:"post",data:I})}function at(I){return $({url:"/cpq/superBomProductRelation/getByBomIdAndStructureId",method:"post",data:I})}function lt(I){return $({url:"/cpq/superBomProductRelation/edit",method:"post",data:I})}function ke(I){return $({url:"/cpq/superBomProductRelation/remove",method:"post",data:I})}function ot(I){return $({url:"/cpq/superBomProductRelation/batchAdd",method:"post",data:I})}const rt={class:"bom-node-products"},nt={class:"management-header"},st={class:"header-buttons"},dt={class:"tab-content"},ut={class:"selection-list"},ct={class:"selection-header"},it={class:"selected-count"},pt={class:"item-info"},mt={class:"item-name"},gt={class:"item-desc"},ft={key:0,class:"empty-tip"},vt={class:"tab-content"},bt={class:"series-selection-container"},_t={class:"catalog-tree-section"},yt={class:"series-list-section"},ht={class:"section-header"},It={class:"selected-count"},wt={class:"item-info"},Ct={class:"item-name"},Nt={class:"item-desc"},kt={key:0,class:"empty-tip"},St={class:"tab-content"},Vt={class:"selection-list"},Tt={class:"selection-header"},Pt={class:"selected-count"},xt={style:{height:"300px","overflow-y":"auto"}},Bt={class:"tree-node-content"},jt={class:"dialog-footer"},Ot={__name:"BomNodeProducts",props:{bomId:{type:[String,Number],required:!0},bomStructureId:{type:[String,Number],default:null}},setup(I){const p=I,q=i(!1),P=i([]),x=i(!1),Y=i("新增关联产品"),Z=i(null),h=i([]),A=i([]),ee=i(!1),D=i([]),te=i(!1),ae=i([]),U=i(!1),z=R({pageNum:1,pageSize:100,productName:"",productCode:""}),k=R({pageNum:1,pageSize:100,seriesName:"",seriesCode:"",brandName:"",catalogId:null}),le=R({pageNum:1,pageSize:100,catalogName:""}),b=R({seriesCode:"",seriesName:"",brandName:""}),Se=i(null),oe=i(null),S=i([]),pe={label:"catalogName",children:"children"},me=i(null),d=R({relationId:null,bomId:p.bomId,structureId:p.bomStructureId,relationType:"",relationObjectId:"",relationObjectIds:[]}),Ve=R({relationObjectIds:[{required:!0,message:"请选择关联对象",trigger:"change"},{type:"array",min:1,message:"请至少选择一个关联对象",trigger:"change"}]}),Q=i("product"),T=i(""),re=i(""),V=i(""),B=i([]),j=i([]),O=i([]),ge=W(()=>{if(!T.value)return A.value;const t=T.value.toLowerCase();return A.value.filter(e=>e.productCode.toLowerCase().includes(t)||e.productName.toLowerCase().includes(t))}),fe=W(()=>{if(!re.value)return D.value;const t=re.value.toLowerCase();return D.value.filter(e=>e.seriesName.toLowerCase().includes(t))}),ne=t=>{switch(t){case"product":return B.value.length;case"series":return j.value.length;case"catalog":return O.value.length;default:return 0}};Je([()=>p.bomId,()=>p.bomStructureId],([t,e])=>{t&&(d.bomId=t,d.structureId=e,M())});const Te=t=>({1:"具体型号",2:"产品系列",3:"产品类目"})[t]||t,Pe=t=>({1:"primary",2:"success",3:"warning"})[t]||"default",xe=()=>{d.relationObjectId="",d.relationObjectIds=[]},Be=t=>{Q.value=t,t==="product"&&A.value.length===0?se():t==="series"?(D.value.length===0&&K(),S.value.length===0&&de()):t==="catalog"&&ae.value.length===0&&G()},se=async()=>{ee.value=!0;try{const t=await Ze(z);A.value=t.rows||[]}catch(t){console.error("加载产品列表失败:",t),y.error("加载产品列表失败")}finally{ee.value=!1}},K=async()=>{te.value=!0;try{k.seriesName=b.seriesName,k.seriesCode=b.seriesCode,k.brandName=b.brandName;const t=await et(k);D.value=t.rows||[]}catch(t){console.error("加载系列列表失败:",t),y.error("加载系列列表失败")}finally{te.value=!1}};let G=async()=>{U.value=!0;try{const t=await Ne(le);ae.value=t.rows||[]}catch(t){console.error("加载分类列表失败:",t),y.error("加载分类列表失败")}finally{U.value=!1}};const de=async()=>{try{U.value=!0,console.log("开始加载分类树数据...");const t=await Ne();console.log("listCatalog API返回数据:",t);let e=[];t&&Array.isArray(t.rows)?e=t.rows:t&&Array.isArray(t.data)&&(e=t.data),console.log("获取到分类列表，共",e.length,"条数据"),e.length===0&&(console.warn("分类列表为空，使用简化默认数据"),e=[{catalogId:1,catalogName:"默认分类",parentId:0}]);const r=je(e);console.log("分类列表转树状结构成功，共",r.length,"个根节点"),S.value=r}catch(t){console.error("加载分类树失败:",t),S.value=[{catalogId:1,catalogName:"默认分类",parentId:0}],y.error("加载分类树失败，使用默认数据")}finally{U.value=!1}},je=t=>{if(!Array.isArray(t)||t.length===0)return[];const e=[],r=new Map;return t.forEach(n=>{r.set(n.catalogId,{catalogId:n.catalogId,catalogName:n.catalogName,parentId:n.parentId||0,children:[]})}),t.forEach(n=>{const c=r.get(n.catalogId),f=n.parentId||0;f===0||!r.has(f)?e.push(c):r.get(f).children.push(c)}),e},ve=async()=>{z.productName=T.value,z.productCode=T.value,z.pageNum=1,await se()},H=async()=>{k.pageNum=1,await K()},Oe=async()=>{b.seriesCode="",b.seriesName="",b.brandName="",k.catalogId=null,me.value=null,await K()},Re=t=>{me.value=t.catalogId,k.catalogId=t.catalogId,k.pageNum=1,K()},be=async()=>{le.catalogName=V.value,le.pageNum=1,await G()},Le=(t,e,r)=>{if(console.log("分类树勾选事件:",t,e,r),oe.value){const n=oe.value.getCheckedKeys();console.log("获取到选中的分类ID:",n),O.value=n}},Ae=W(()=>{if(!V.value)return S.value;const t=V.value.toLowerCase(),e=r=>r.reduce((n,c)=>{const f=c.catalogName.toLowerCase().includes(t);let w=[];return c.children&&c.children.length>0&&(w=e(c.children)),(f||w.length>0)&&n.push({...c,children:w}),n},[]);return e(S.value)});W(()=>{const t=n=>{let c=[];return n.forEach(f=>{c.push({catalogId:f.catalogId,catalogName:f.catalogName,parentId:f.parentId}),f.children&&f.children.length>0&&(c=c.concat(t(f.children)))}),c},e=t(S.value);if(!V.value)return e;const r=V.value.toLowerCase();return e.filter(n=>n.catalogName.toLowerCase().includes(r))});const De=G;G=async()=>{await De(),S.value.length===0&&await de()};const M=async()=>{q.value=!0;try{let t;p.bomStructureId?t=await at({bomId:p.bomId,structureId:p.bomStructureId}):t=await tt(p.bomId);let e=[];return Array.isArray(t)?e=t:t&&typeof t=="object"&&(e=t.rows||t.data||[]),h.value=e,q.value=!1,e}catch(t){return console.error("加载关联产品列表失败:",t),y.error("加载关联产品列表失败"),q.value=!1,[]}},Ue=t=>{P.value=t},Me=()=>{_e(),Y.value="新增关联产品",x.value=!0,se(),de()},Ee=t=>{const e={...t,relationType:t.relationType.toString(),relationObjectIds:[t.relationObjectId]};Object.assign(d,e),Y.value="编辑关联产品",x.value=!0},Fe=async t=>{try{await Ce.confirm(`确定要删除与${Te(t.relationType)} "${t.relationObjectName}" 的关联吗？`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await ke([t.relationId]),h.value=h.value.filter(e=>e.relationId!==t.relationId),y.success("关联产品删除成功")}catch(e){e!=="cancel"&&(y.error("删除失败"),console.error("删除关联产品失败:",e))}},$e=async()=>{if(P.value.length!==0)try{await Ce.confirm(`确定要删除选中的 ${P.value.length} 个关联产品吗？`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=P.value.map(e=>e.relationId);await ke(t),h.value=h.value.filter(e=>!t.includes(e.relationId)),P.value=[],y.success("批量删除成功")}catch(t){t!=="cancel"&&(y.error("批量删除失败"),console.error("批量删除关联产品失败:",t))}},qe=async()=>{try{const t=[];if(d.relationId){await Z.value.validate(),console.log("productForm",d);const e={...d,relationType:parseInt(d.relationType),relationObjectId:parseInt(d.relationObjectIds[0])};p.bomStructureId&&(e.structureId=p.bomStructureId),await lt(e);const r=h.value.findIndex(n=>n.relationId===d.relationId);r!==-1&&(h.value[r]={...e}),y.success("关联产品更新成功")}else{if(B.value.length>0){const r=B.value.map(n=>{const c={bomId:p.bomId,relationType:1,relationObjectId:parseInt(n)};return p.bomStructureId&&(c.structureId=p.bomStructureId),c});t.push(...r)}if(j.value.length>0){const r=j.value.map(n=>{const c={bomId:p.bomId,relationType:2,relationObjectId:parseInt(n)};return p.bomStructureId&&(c.structureId=p.bomStructureId),c});t.push(...r)}if(O.value.length>0){const r=O.value.map(n=>{const c={bomId:p.bomId,relationType:3,relationObjectId:parseInt(n)};return p.bomStructureId&&(c.structureId=p.bomStructureId),c});t.push(...r)}if(t.length===0){y.warning("请至少选择一个关联对象");return}const e=await ot(t);if(e&&Array.isArray(e))h.value.push(...e);else if(e&&e.code===200){const r=e.rows||e.data||[];r.length>0?h.value.push(...r):await M()}else await M();y.success(`成功新增 ${t.length} 个关联产品`)}x.value=!1,_e()}catch(t){console.error("提交关联产品表单失败:",t),t!==!1&&y.error("操作失败，请检查表单数据")}},_e=()=>{var t;d.relationId=null,d.bomId=p.bomId,d.structureId=p.bomStructureId,d.relationType="",d.relationObjectId="",d.relationObjectIds=[],T.value="",re.value="",V.value="",B.value=[],j.value=[],O.value=[],Q.value="product",(t=Z.value)==null||t.resetFields()};return We(async()=>{console.log("组件挂载，开始加载关联产品列表，bomId:",p.bomId),await M(),console.log("初始加载完成，关联产品列表:",h.value)}),(t,e)=>{const r=m("el-button"),n=m("el-table-column"),c=m("el-tag"),f=m("el-table"),w=m("el-option"),J=m("el-select"),N=m("el-form-item"),E=m("el-input"),ue=m("el-skeleton"),ye=m("el-checkbox"),he=m("el-checkbox-group"),ce=m("el-scrollbar"),ie=m("el-tab-pane"),Ie=m("el-form"),we=m("el-tree"),ze=m("el-tabs"),Qe=m("el-dialog"),Ke=Xe("loading");return u(),C("div",rt,[s("div",nt,[e[17]||(e[17]=s("h3",null,"关联产品管理",-1)),s("div",st,[o(r,{type:"primary",icon:"Plus",onClick:Me},{default:l(()=>e[14]||(e[14]=[v("新增关联产品")])),_:1,__:[14]}),o(r,{type:"danger",icon:"Delete",onClick:$e,disabled:P.value.length===0},{default:l(()=>e[15]||(e[15]=[v("批量删除")])),_:1,__:[15]},8,["disabled"]),o(r,{type:"info",icon:"Refresh",onClick:M},{default:l(()=>e[16]||(e[16]=[v("刷新列表")])),_:1,__:[16]})])]),Ye((u(),g(f,{data:h.value,stripe:"",style:{width:"100%"}},{default:l(()=>[o(n,{type:"selection",width:"55",align:"center",onSelectionChange:Ue}),o(n,{label:"关联类型",align:"center",prop:"relationTypeName",width:"120"},{default:l(a=>[o(c,{type:Pe(a.row.relationType)},{default:l(()=>[v(_(a.row.relationTypeName),1)]),_:2},1032,["type"])]),_:1}),o(n,{label:"产品名称",align:"center",prop:"productName","min-width":"150"},{default:l(a=>[v(_(a.row.productName||a.row.relationObjectName||"无"),1)]),_:1}),h.value.some(a=>a.relationType===1)?(u(),g(n,{key:0,label:"产品型号",align:"center","min-width":"150"},{default:l(a=>[v(_(a.row.relationType===1?a.row.productModel||a.row.modelName||"无":"-"),1)]),_:1})):X("",!0),o(n,{label:"操作",align:"center",width:"150",fixed:"right"},{default:l(a=>[o(r,{size:"small",type:"primary",icon:"Edit",onClick:Ge=>Ee(a.row)},{default:l(()=>e[18]||(e[18]=[v(" 编辑 ")])),_:2,__:[18]},1032,["onClick"]),o(r,{size:"small",type:"danger",icon:"Delete",onClick:Ge=>Fe(a.row)},{default:l(()=>e[19]||(e[19]=[v(" 删除 ")])),_:2,__:[19]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[Ke,q.value]]),o(Qe,{title:Y.value,modelValue:x.value,"onUpdate:modelValue":e[13]||(e[13]=a=>x.value=a),width:"800px","append-to-body":""},{footer:l(()=>[s("span",jt,[o(r,{onClick:e[12]||(e[12]=a=>x.value=!1)},{default:l(()=>e[28]||(e[28]=[v("取消")])),_:1,__:[28]}),o(r,{type:"primary",onClick:qe},{default:l(()=>e[29]||(e[29]=[v("确定")])),_:1,__:[29]})])]),default:l(()=>[o(Ie,{ref_key:"productFormRef",ref:Z,model:d,rules:Ve,"label-width":"120px"},{default:l(()=>[d.relationId?(u(),C(L,{key:0},[o(N,{label:"关联类型",prop:"relationType"},{default:l(()=>[o(J,{modelValue:d.relationType,"onUpdate:modelValue":e[0]||(e[0]=a=>d.relationType=a),placeholder:"请选择关联类型",onChange:xe},{default:l(()=>[o(w,{label:"具体型号",value:"1"}),o(w,{label:"产品系列",value:"2"}),o(w,{label:"产品类目",value:"3"})]),_:1},8,["modelValue"])]),_:1}),d.relationType==="1"?(u(),g(N,{key:0,label:"产品型号",prop:"relationObjectIds"},{default:l(()=>[o(J,{modelValue:d.relationObjectIds,"onUpdate:modelValue":e[1]||(e[1]=a=>d.relationObjectIds=a),placeholder:"请选择产品型号",filterable:"","collapse-tags":""},{default:l(()=>[(u(!0),C(L,null,F(A.value,a=>(u(),g(w,{key:a.productId,label:`${a.productCode} - ${a.productName}`,value:a.productId},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):d.relationType==="2"?(u(),g(N,{key:1,label:"产品系列",prop:"relationObjectIds"},{default:l(()=>[o(J,{modelValue:d.relationObjectIds,"onUpdate:modelValue":e[2]||(e[2]=a=>d.relationObjectIds=a),placeholder:"请选择产品系列",filterable:"","collapse-tags":""},{default:l(()=>[(u(!0),C(L,null,F(D.value,a=>(u(),g(w,{key:a.seriesId,label:a.seriesName,value:a.seriesId},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):d.relationType==="3"?(u(),g(N,{key:2,label:"产品类目",prop:"relationObjectIds"},{default:l(()=>[o(J,{modelValue:d.relationObjectIds,"onUpdate:modelValue":e[3]||(e[3]=a=>d.relationObjectIds=a),placeholder:"请选择产品类目",filterable:"","collapse-tags":""},{default:l(()=>[(u(!0),C(L,null,F(ae.value,a=>(u(),g(w,{key:a.catalogId,label:a.catalogName,value:a.catalogId},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):X("",!0)],64)):(u(),g(ze,{key:1,modelValue:Q.value,"onUpdate:modelValue":e[11]||(e[11]=a=>Q.value=a),type:"card",onTabChange:Be},{default:l(()=>[o(ie,{label:"产品",name:"product"},{default:l(()=>[s("div",dt,[o(N,{label:"产品搜索",prop:"productSearch"},{default:l(()=>[o(E,{modelValue:T.value,"onUpdate:modelValue":e[4]||(e[4]=a=>T.value=a),placeholder:"请输入产品名称或编码",clearable:"",onInput:ve},{append:l(()=>[o(r,{type:"primary",icon:"Search",onClick:ve},{default:l(()=>e[20]||(e[20]=[v("搜索")])),_:1,__:[20]})]),_:1},8,["modelValue"])]),_:1}),s("div",ut,[s("div",ct,[e[21]||(e[21]=s("span",null,"产品列表",-1)),s("span",it,"已选择: "+_(ne("product")),1)]),o(ce,{height:"250px"},{default:l(()=>[ee.value?(u(),g(ue,{key:0,rows:5,animated:""})):(u(),g(he,{key:1,modelValue:B.value,"onUpdate:modelValue":e[5]||(e[5]=a=>B.value=a)},{default:l(()=>[(u(!0),C(L,null,F(ge.value,a=>(u(),C("div",{key:a.productId,class:"selection-item"},[o(ye,{label:a.productId},{default:l(()=>[s("div",pt,[s("div",mt,_(a.productCode)+" - "+_(a.productName),1),s("div",gt,"型号: "+_(a.modelName||a.productModel||"无"),1)])]),_:2},1032,["label"])]))),128)),ge.value.length===0?(u(),C("div",ft," 暂无产品数据 ")):X("",!0)]),_:1},8,["modelValue"]))]),_:1})])])]),_:1}),o(ie,{label:"系列",name:"series"},{default:l(()=>[s("div",vt,[o(Ie,{inline:!0,model:b,class:"search-form"},{default:l(()=>[o(N,{label:"系列编码"},{default:l(()=>[o(E,{modelValue:b.seriesCode,"onUpdate:modelValue":e[6]||(e[6]=a=>b.seriesCode=a),placeholder:"请输入系列编码",clearable:"",onInput:H,style:{width:"180px"}},null,8,["modelValue"])]),_:1}),o(N,{label:"系列名称"},{default:l(()=>[o(E,{modelValue:b.seriesName,"onUpdate:modelValue":e[7]||(e[7]=a=>b.seriesName=a),placeholder:"请输入系列名称",clearable:"",onInput:H,style:{width:"180px"}},null,8,["modelValue"])]),_:1}),o(N,{label:"品牌"},{default:l(()=>[o(E,{modelValue:b.brandName,"onUpdate:modelValue":e[8]||(e[8]=a=>b.brandName=a),placeholder:"请输入品牌名称",clearable:"",onInput:H,style:{width:"180px"}},null,8,["modelValue"])]),_:1}),o(N,null,{default:l(()=>[o(r,{type:"primary",icon:"Search",onClick:H},{default:l(()=>e[22]||(e[22]=[v("搜索")])),_:1,__:[22]}),o(r,{icon:"RefreshRight",onClick:Oe},{default:l(()=>e[23]||(e[23]=[v("重置")])),_:1,__:[23]})]),_:1})]),_:1},8,["model"]),s("div",bt,[s("div",_t,[e[24]||(e[24]=s("div",{class:"section-header"},"分类树",-1)),o(ce,{height:"300px"},{default:l(()=>[o(we,{ref_key:"catalogTreeRef",ref:Se,data:S.value,props:pe,"node-key":"catalogId","default-expand-all":"",onNodeClick:Re},null,8,["data"])]),_:1})]),s("div",yt,[s("div",ht,[e[25]||(e[25]=s("span",null,"产品系列列表",-1)),s("span",It,"已选择: "+_(ne("series")),1)]),o(ce,{height:"300px"},{default:l(()=>[te.value?(u(),g(ue,{key:0,rows:5,animated:""})):(u(),g(he,{key:1,modelValue:j.value,"onUpdate:modelValue":e[9]||(e[9]=a=>j.value=a)},{default:l(()=>[(u(!0),C(L,null,F(fe.value,a=>(u(),C("div",{key:a.seriesId,class:"selection-item"},[o(ye,{label:a.seriesId},{default:l(()=>[s("div",wt,[s("div",Ct,_(a.seriesCode||"")+" - "+_(a.seriesName),1),s("div",Nt,"品牌: "+_(a.brandName||"无"),1)])]),_:2},1032,["label"])]))),128)),fe.value.length===0?(u(),C("div",kt," 暂无产品系列数据 ")):X("",!0)]),_:1},8,["modelValue"]))]),_:1})])])])]),_:1}),o(ie,{label:"分类",name:"catalog"},{default:l(()=>[s("div",St,[o(N,{label:"分类搜索",prop:"catalogSearch"},{default:l(()=>[o(E,{modelValue:V.value,"onUpdate:modelValue":e[10]||(e[10]=a=>V.value=a),placeholder:"请输入产品类目名称",clearable:"",onInput:be},{append:l(()=>[o(r,{type:"primary",icon:"Search",onClick:be},{default:l(()=>e[26]||(e[26]=[v("搜索")])),_:1,__:[26]})]),_:1},8,["modelValue"])]),_:1}),s("div",Vt,[s("div",Tt,[e[27]||(e[27]=s("span",null,"产品类目树",-1)),s("span",Pt,"已选择: "+_(ne("catalog")),1)]),s("div",xt,[U.value?(u(),g(ue,{key:0,rows:10,animated:""})):(u(),g(we,{key:1,ref_key:"catalogSelectTreeRef",ref:oe,data:Ae.value,props:pe,"node-key":"catalogId","show-checkbox":"","default-expand-all":"","default-checked-keys":O.value,onCheck:Le},{default:l(({node:a})=>[s("div",Bt,[s("span",null,_(a.label),1)])]),_:1},8,["data","default-checked-keys"]))])])])]),_:1})]),_:1},8,["modelValue"]))]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue"])])}}},Ut=He(Ot,[["__scopeId","data-v-532a9297"]]);export{Ut as default};
