import{_ as ee,r as y,w as te,h as b,d as p,e as a,l as h,k as u,i as s,n as B,au as R,j as n,m as C,Y as A,t as d,K as k,L as V,av as oe,q as I,ai as ae,a3 as re,V as q,aw as ue,ax as ne}from"./index-CwdKQqOf.js";import{u as le}from"./configurator-DAu3_4Je.js";import{q as se}from"./bom-DdrUuB8x.js";import{g as ce}from"./superBomProductRelation-e2EKVMIZ.js";import"./superBomRuleRelation-Cz_bCmLL.js";import"./rule-nChVW3Ks.js";import"./superBomVariable-gMrvMuGl.js";const de={class:"attribute-config"},ie={key:1,class:"config-content"},me={class:"node-info"},pe={class:"info-header"},fe={class:"info-text"},be={class:"node-code"},ve={key:0,class:"node-desc"},_e={class:"form-section"},ye={class:"quantity-hint"},he={class:"product-option"},ge={class:"product-price"},Ne={class:"section-header"},Ce={key:0,class:"section-desc"},Ie={class:"section-content"},xe={key:0,class:"attr-help"},ke={key:1,class:"attr-error"},Ve={class:"config-actions"},qe={__name:"AttributeConfig",props:{currentNode:{type:Object,default:null}},emits:["config-confirm"],setup(c,{emit:T}){const i=c,E=T,v=le(),w=y(),o=y({quantity:1,selectedProductId:null,attrs:{}}),P=y({}),g=y({}),D=y([]),x=y([]),M=y(!1),$=e=>({0:R,1:ne,2:ue})[e.nodeType]||R,G=e=>({text:"el-input",number:"el-input-number",select:"el-select",multi:"el-select",radio:"el-radio-group",checkbox:"el-checkbox-group",date:"el-date-picker",datetime:"el-date-picker",textarea:"el-input",slider:"el-slider",switch:"el-switch",color:"el-color-picker"})[e]||"el-input",H=e=>({select:"el-option",multi:"el-option",radio:"el-radio",checkbox:"el-checkbox"})[e]||"el-option",L=e=>{const t={placeholder:e.attributePlaceholder||`请输入${e.attributeName}`,disabled:e.isReadonly==="0",clearable:!0};switch(e.attributeType){case"number":return{...t,min:e.minValue?Number(e.minValue):void 0,max:e.maxValue?Number(e.maxValue):void 0,step:e.step?Number(e.step):1,controls:!0};case"select":return{...t,filterable:!0};case"multi":return{...t,multiple:!0,filterable:!0,"collapse-tags":!0};case"textarea":return{...t,type:"textarea",rows:4,maxlength:e.maxLength?Number(e.maxLength):void 0,"show-word-limit":!0};case"date":return{...t,type:"date",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"};case"datetime":return{...t,type:"datetime",format:"YYYY-MM-DD HH:mm:ss","value-format":"YYYY-MM-DD HH:mm:ss"};case"slider":return{min:e.minValue?Number(e.minValue):0,max:e.maxValue?Number(e.maxValue):100,step:e.step?Number(e.step):1,"show-input":!0};default:return t}},U=async()=>{if(i.currentNode)try{const t=(await se(i.currentNode.bomStructureId)).data||[],f=new Map;t.forEach(m=>{const N=m.attributeGroupId||0,Y=m.attributeGroupName||"基本属性";f.has(N)||f.set(N,{groupId:N,groupName:Y,groupDesc:m.attributeGroupDesc||"",attributes:[]}),f.get(N).attributes.push(m),o.value.attrs[m.attributeCode]=m.defaultValue||null,m.isRequired==="0"&&(P.value[`attrs.${m.attributeCode}`]=[{required:!0,message:`${m.attributeName}不能为空`,trigger:"blur"}])}),D.value=Array.from(f.values())}catch(e){console.error("加载属性配置失败:",e),q.error("加载属性配置失败")}},j=async()=>{if(i.currentNode)try{const e=await ce({bomId:v.currentBom.bomId,structureId:i.currentNode.bomStructureId});x.value=e.data||[]}catch(e){console.error("加载关联产品失败:",e)}},O=async e=>{delete g.value[e.attributeCode],await v.validateAttribute(i.currentNode.bomStructureId,e.attributeCode,o.value.attrs[e.attributeCode])},z=async e=>{await v.updateNodeQuantity(i.currentNode.bomStructureId,e)},F=async e=>{await v.selectNodeProduct(i.currentNode.bomStructureId,e)},K=()=>{w.value.resetFields(),g.value={},o.value.quantity=i.currentNode.defaultQuantity||1,o.value.selectedProductId=null},J=async()=>{M.value=!0;try{if(await w.value.validate(),!await v.validateNodeConfiguration(i.currentNode.bomStructureId,{quantity:o.value.quantity,selectedProductId:o.value.selectedProductId,...o.value.attrs})){g.value=v.validationErrors,q.warning("配置不符合规则要求，请检查");return}await v.saveNodeConfiguration(i.currentNode.bomStructureId,{quantity:o.value.quantity,selectedProductId:o.value.selectedProductId,...o.value.attrs}),q.success("配置保存成功"),E("config-confirm")}catch(e){console.error("配置保存失败:",e),q.error("配置验证失败")}finally{M.value=!1}};return te(()=>i.currentNode,async e=>{e&&(o.value={quantity:e.defaultQuantity||1,selectedProductId:e.selectedProductId||null,attrs:{}},P.value={},g.value={},D.value=[],x.value=[],await Promise.all([U(),j()]),e.configuration&&Object.assign(o.value,e.configuration))},{immediate:!0}),(e,t)=>{const f=b("el-icon"),m=b("el-empty"),N=b("el-card"),Y=b("el-input-number"),S=b("el-form-item"),W=b("el-option"),X=b("el-select"),Z=b("el-form"),Q=b("el-button");return a(),p("div",de,[c.currentNode?(a(),p("div",ie,[n("div",me,[n("div",pe,[s(f,{size:24},{default:u(()=>[(a(),h(A($(c.currentNode))))]),_:1}),n("div",fe,[n("h3",null,d(c.currentNode.nodeName),1),n("p",be,"节点编码: "+d(c.currentNode.nodeCode),1)])]),c.currentNode.nodeDesc?(a(),p("p",ve,d(c.currentNode.nodeDesc),1)):C("",!0)]),s(Z,{ref_key:"formRef",ref:w,model:o.value,rules:P.value,"label-width":"120px",class:"attribute-form"},{default:u(()=>[n("div",_e,[t[2]||(t[2]=n("div",{class:"section-header"},[n("h4",null,"基本配置")],-1)),s(S,{label:"数量",prop:"quantity",required:""},{default:u(()=>[s(Y,{modelValue:o.value.quantity,"onUpdate:modelValue":t[0]||(t[0]=l=>o.value.quantity=l),min:c.currentNode.minQuantity||1,max:c.currentNode.maxQuantity||9999,step:1,onChange:z},null,8,["modelValue","min","max"]),n("span",ye," 可选范围: "+d(c.currentNode.minQuantity||1)+" - "+d(c.currentNode.maxQuantity||"无限制"),1)]),_:1}),x.value.length>0?(a(),h(S,{key:0,label:"选择产品",prop:"selectedProductId",required:c.currentNode.isRequired},{default:u(()=>[s(X,{modelValue:o.value.selectedProductId,"onUpdate:modelValue":t[1]||(t[1]=l=>o.value.selectedProductId=l),placeholder:"请选择产品",filterable:"",clearable:"",onChange:F},{default:u(()=>[(a(!0),p(k,null,V(x.value,l=>(a(),h(W,{key:l.productId,label:l.productName,value:l.productId},{default:u(()=>[n("div",he,[n("span",null,d(l.productName),1),n("span",ge,"¥"+d(l.price||0),1)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["required"])):C("",!0)]),(a(!0),p(k,null,V(D.value,l=>(a(),p("div",{key:l.groupId,class:"form-section"},[n("div",Ne,[n("h4",null,d(l.groupName),1),l.groupDesc?(a(),p("span",Ce,d(l.groupDesc),1)):C("",!0)]),n("div",Ie,[(a(!0),p(k,null,V(l.attributes,r=>(a(),h(S,{key:r.attributeId,label:r.attributeName,prop:`attrs.${r.attributeCode}`,required:r.isRequired==="0"},{default:u(()=>[(a(),h(A(G(r.attributeType)),oe({modelValue:o.value.attrs[r.attributeCode],"onUpdate:modelValue":_=>o.value.attrs[r.attributeCode]=_},{ref_for:!0},L(r),{onChange:_=>O(r)}),{default:u(()=>[["select","multi","radio","checkbox"].includes(r.attributeType)?(a(!0),p(k,{key:0},V(r.attributeValues,_=>(a(),h(A(H(r.attributeType)),{key:_.valueId,label:_.valueName,value:_.valueCode},{default:u(()=>[I(d(_.valueName),1)]),_:2},1032,["label","value"]))),128)):C("",!0)]),_:2},1040,["modelValue","onUpdate:modelValue","onChange"])),r.attributeDesc?(a(),p("div",xe,[s(f,null,{default:u(()=>[s(B(ae))]),_:1}),I(" "+d(r.attributeDesc),1)])):C("",!0),g.value[r.attributeCode]?(a(),p("div",ke,[s(f,null,{default:u(()=>[s(B(re))]),_:1}),I(" "+d(g.value[r.attributeCode]),1)])):C("",!0)]),_:2},1032,["label","prop","required"]))),128))])]))),128))]),_:1},8,["model","rules"]),n("div",Ve,[s(Q,{onClick:K},{default:u(()=>t[3]||(t[3]=[I("重置")])),_:1,__:[3]}),s(Q,{type:"primary",loading:M.value,onClick:J},{default:u(()=>t[4]||(t[4]=[I(" 确认配置 ")])),_:1,__:[4]},8,["loading"])])])):(a(),h(N,{key:0,class:"empty-state",shadow:"never"},{default:u(()=>[s(m,{description:"请在左侧选择要配置的节点"},{default:u(()=>[s(f,{size:80,color:"#c0c4cc"},{default:u(()=>[s(B(R))]),_:1})]),_:1})]),_:1}))])}}},Re=ee(qe,[["__scopeId","data-v-a2ae4c99"]]);export{Re as default};
