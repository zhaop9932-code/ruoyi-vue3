import{a9 as N,_ as ge,r as b,$,g as C,h as ye,a as r,i as Ve,c as we,o as J,b as e,j as B,w as o,U as W,f as n,a0 as X,t as g,m as Ne,e as E,E as f}from"./index-DgigFOm-.js";function Se(p){return N({url:"/cpq/quote/list",method:"get",params:p})}function Ae(p){return N({url:"/cpq/quote",method:"post",data:p})}function xe(p){return N({url:"/cpq/quote",method:"put",data:p})}function Ue(p){return N({url:`/cpq/quote/${p}`,method:"delete"})}function Y(p){return N({url:`/cpq/quote/submit/${p}`,method:"post"})}const ke={class:"app-container"},Pe={class:"quote-items-container"},Ce={class:"price-details"},Ie={class:"dialog-footer"},he={__name:"index",setup(p){const S=b(!0),A=b(!0),I=b(0),T=b([]),h=b([]),z=b(""),y=b(!1),x=b("basic"),d=$({pageNum:1,pageSize:10,quoteNumber:"",customerName:"",quoteStatus:""}),a=$({quoteId:null,quoteNumber:"",customerName:"",contactPerson:"",contactPhone:"",quoteDate:"",validUntil:"",quoteStatus:"draft",totalAmount:0,discountAmount:0,freightAmount:0,taxAmount:0,finalAmount:0,remark:"",quoteItems:[]}),j=$({quoteNumber:[{required:!0,message:"报价单号不能为空",trigger:"blur"}],customerName:[{required:!0,message:"客户名称不能为空",trigger:"blur"}],quoteDate:[{required:!0,message:"报价日期不能为空",trigger:"change"}],validUntil:[{required:!0,message:"有效期至不能为空",trigger:"change"}]}),v=b([]),U=C(()=>v.value.reduce((u,t)=>u+(t.quantity*t.unitPrice||0),0)),k=C(()=>v.value.reduce((u,t)=>u+(t.quantity*t.unitPrice*(t.discount/100)||0),0)),D=C(()=>(U.value-k.value)*.13),R=C(()=>U.value-k.value+a.freightAmount+D.value),V=async()=>{S.value=!0;try{const u=await Se(d);T.value=u.rows,I.value=u.total,S.value=!1}catch{S.value=!1,f.error("获取报价单列表失败")}},P=()=>{d.pageNum=1,V()},Z=()=>{d.quoteNumber="",d.customerName="",d.quoteStatus="",P()},ee=()=>{A.value=!A.value},te=u=>{h.value=u},le=()=>{a.quoteId=null,a.quoteNumber="",a.customerName="",a.contactPerson="",a.contactPhone="",a.quoteDate="",a.validUntil="",a.quoteStatus="draft",a.totalAmount=0,a.discountAmount=0,a.freightAmount=0,a.taxAmount=0,a.finalAmount=0,a.remark="",v.value=[],z.value="新增报价单",x.value="basic",y.value=!0},ae=u=>{a.quoteId=u.quoteId,a.quoteNumber=u.quoteNumber,a.customerName=u.customerName,a.contactPerson=u.contactPerson,a.contactPhone=u.contactPhone,a.quoteDate=u.quoteDate,a.validUntil=u.validUntil,a.quoteStatus=u.quoteStatus,a.totalAmount=u.totalAmount,a.discountAmount=u.discountAmount,a.freightAmount=u.freightAmount,a.taxAmount=u.taxAmount,a.finalAmount=u.finalAmount,a.remark=u.remark,v.value=[{itemId:1,productName:"产品1",productCode:"PROD001",quantity:2,unitPrice:1e3,discount:10},{itemId:2,productName:"产品2",productCode:"PROD002",quantity:1,unitPrice:2e3,discount:5}],z.value="修改报价单",x.value="basic",y.value=!0},K=async u=>{const t=u.quoteId?[u.quoteId]:h.value.map(m=>m.quoteId);await ElMessageBox.confirm("确定要删除选中的报价单吗？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});try{await Ue(t),f.success("删除成功"),V()}catch{f.error("删除失败")}},oe=u=>{router.push({path:"/cpq/quote/detail",query:{quoteId:u.quoteId}})},ue=u=>{Y(u.quoteId).then(()=>{f.success("提交成功"),V()}).catch(t=>{f.error("提交失败")})},ne=()=>{v.value.push({itemId:null,productName:"",productCode:"",quantity:1,unitPrice:0,discount:0})},re=u=>{const t=v.value.findIndex(m=>m.itemId===u.itemId);t!==-1&&v.value.splice(t,1)},de=async()=>{await validate(a,j);try{a.totalAmount=U.value,a.discountAmount=k.value,a.taxAmount=D.value,a.finalAmount=R.value,a.quoteId?(await xe(a),f.success("修改成功")):(await Ae(a),f.success("新增成功")),y.value=!1,V()}catch{f.error("操作失败")}},ie=async()=>{try{await Y(a.quoteId),f.success("提交审批成功"),y.value=!1,V()}catch{f.error("提交审批失败")}},se=()=>{y.value=!1,resetForm()};return ye(()=>{V()}),(u,t)=>{const m=r("el-input"),c=r("el-form-item"),q=r("el-option"),M=r("el-select"),s=r("el-button"),L=r("el-form"),me=r("el-card"),Q=r("el-col"),ce=r("el-row"),i=r("el-table-column"),pe=r("el-tag"),O=r("el-table"),_e=r("pagination"),G=r("el-date-picker"),F=r("el-tab-pane"),H=r("el-input-number"),w=r("el-descriptions-item"),fe=r("el-descriptions"),be=r("el-tabs"),ve=r("el-dialog"),qe=Ve("loading");return J(),we("div",ke,[e(me,{shadow:"never",class:"search-card"},{default:o(()=>[B(e(L,{model:d,ref:"queryForm",inline:!0,"label-width":"80px"},{default:o(()=>[e(c,{label:"报价单号",prop:"quoteNumber"},{default:o(()=>[e(m,{modelValue:d.quoteNumber,"onUpdate:modelValue":t[0]||(t[0]=l=>d.quoteNumber=l),placeholder:"请输入报价单号",clearable:"",size:"small",onKeyup:W(P,["enter"])},null,8,["modelValue"])]),_:1}),e(c,{label:"客户名称",prop:"customerName"},{default:o(()=>[e(m,{modelValue:d.customerName,"onUpdate:modelValue":t[1]||(t[1]=l=>d.customerName=l),placeholder:"请输入客户名称",clearable:"",size:"small",onKeyup:W(P,["enter"])},null,8,["modelValue"])]),_:1}),e(c,{label:"报价状态",prop:"quoteStatus"},{default:o(()=>[e(M,{modelValue:d.quoteStatus,"onUpdate:modelValue":t[2]||(t[2]=l=>d.quoteStatus=l),placeholder:"请选择报价状态",clearable:"",size:"small"},{default:o(()=>[e(q,{label:"草稿",value:"draft"}),e(q,{label:"已提交",value:"submitted"}),e(q,{label:"审批中",value:"approving"}),e(q,{label:"已通过",value:"approved"}),e(q,{label:"已拒绝",value:"rejected"}),e(q,{label:"已失效",value:"expired"})]),_:1},8,["modelValue"])]),_:1}),e(c,null,{default:o(()=>[e(s,{type:"primary",icon:"Search",size:"small",onClick:P},{default:o(()=>t[15]||(t[15]=[n("搜索")])),_:1,__:[15]}),e(s,{icon:"RefreshRight",size:"small",onClick:Z},{default:o(()=>t[16]||(t[16]=[n("重置")])),_:1,__:[16]})]),_:1})]),_:1},8,["model"]),[[X,A.value]])]),_:1}),e(ce,{gutter:10,class:"mb8"},{default:o(()=>[e(Q,{span:1.5},{default:o(()=>[e(s,{type:"primary",icon:"Plus",size:"small",onClick:le},{default:o(()=>t[17]||(t[17]=[n(" 新增报价单 ")])),_:1,__:[17]})]),_:1}),e(Q,{span:1.5},{default:o(()=>[e(s,{type:"danger",icon:"Delete",size:"small",disabled:h.value.length===0,onClick:K},{default:o(()=>t[18]||(t[18]=[n(" 批量删除 ")])),_:1,__:[18]},8,["disabled"])]),_:1}),e(Q,{span:21},{default:o(()=>[e(s,{type:"info",icon:"Search",size:"small",onClick:ee,style:{float:"right"}},{default:o(()=>[n(g(A.value?"收起":"展开")+"搜索 ",1)]),_:1})]),_:1})]),_:1}),B((J(),Ne(O,{data:T.value,onSelectionChange:te},{default:o(()=>[e(i,{type:"selection",width:"55",align:"center"}),e(i,{label:"报价单号",align:"center",prop:"quoteNumber"}),e(i,{label:"客户名称",align:"center",prop:"customerName"}),e(i,{label:"报价金额",align:"center",prop:"totalAmount"}),e(i,{label:"报价状态",align:"center",prop:"quoteStatus"},{default:o(l=>[e(pe,{type:l.row.quoteStatus==="draft"?"info":l.row.quoteStatus==="submitted"?"warning":l.row.quoteStatus==="approving"?"primary":l.row.quoteStatus==="approved"?"success":l.row.quoteStatus==="rejected"?"danger":"warning",size:"small"},{default:o(()=>[n(g(l.row.quoteStatus==="draft"?"草稿":l.row.quoteStatus==="submitted"?"已提交":l.row.quoteStatus==="approving"?"审批中":l.row.quoteStatus==="approved"?"已通过":l.row.quoteStatus==="rejected"?"已拒绝":"已失效"),1)]),_:2},1032,["type"])]),_:1}),e(i,{label:"创建人",align:"center",prop:"createBy"}),e(i,{label:"创建时间",align:"center",prop:"createTime",width:"180"}),e(i,{label:"操作",align:"center","class-name":"small-padding fixed-width",width:"250"},{default:o(l=>[e(s,{size:"small",type:"primary",icon:"Edit",onClick:_=>ae(l.row)},{default:o(()=>t[19]||(t[19]=[n(" 编辑 ")])),_:2,__:[19]},1032,["onClick"]),e(s,{size:"small",type:"success",icon:"Document",onClick:_=>oe(l.row)},{default:o(()=>t[20]||(t[20]=[n(" 查看 ")])),_:2,__:[20]},1032,["onClick"]),e(s,{size:"small",type:"warning",icon:"Upload",onClick:_=>ue(l.row),disabled:l.row.quoteStatus!=="draft"},{default:o(()=>t[21]||(t[21]=[n(" 提交审批 ")])),_:2,__:[21]},1032,["onClick","disabled"]),e(s,{size:"small",type:"danger",icon:"Delete",onClick:_=>K(l.row)},{default:o(()=>t[22]||(t[22]=[n(" 删除 ")])),_:2,__:[22]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[qe,S.value]]),B(e(_e,{total:I.value,page:d.pageNum,"onUpdate:page":t[3]||(t[3]=l=>d.pageNum=l),limit:d.pageSize,"onUpdate:limit":t[4]||(t[4]=l=>d.pageSize=l),onPagination:V},null,8,["total","page","limit"]),[[X,I.value>0]]),e(ve,{title:z.value,modelValue:y.value,"onUpdate:modelValue":t[14]||(t[14]=l=>y.value=l),width:"800px","append-to-body":""},{footer:o(()=>[E("span",Ie,[e(s,{onClick:se},{default:o(()=>t[25]||(t[25]=[n("取消")])),_:1,__:[25]}),e(s,{type:"primary",onClick:de},{default:o(()=>t[26]||(t[26]=[n("保存")])),_:1,__:[26]}),e(s,{type:"success",onClick:ie,disabled:!a.quoteId},{default:o(()=>t[27]||(t[27]=[n("提交审批")])),_:1,__:[27]},8,["disabled"])])]),default:o(()=>[e(be,{modelValue:x.value,"onUpdate:modelValue":t[13]||(t[13]=l=>x.value=l)},{default:o(()=>[e(F,{label:"基本信息",name:"basic"},{default:o(()=>[e(L,{ref:"form",model:a,rules:j,"label-width":"120px"},{default:o(()=>[e(c,{label:"报价单号",prop:"quoteNumber"},{default:o(()=>[e(m,{modelValue:a.quoteNumber,"onUpdate:modelValue":t[5]||(t[5]=l=>a.quoteNumber=l),placeholder:"请输入报价单号",disabled:a.quoteId},null,8,["modelValue","disabled"])]),_:1}),e(c,{label:"客户名称",prop:"customerName"},{default:o(()=>[e(m,{modelValue:a.customerName,"onUpdate:modelValue":t[6]||(t[6]=l=>a.customerName=l),placeholder:"请输入客户名称"},null,8,["modelValue"])]),_:1}),e(c,{label:"联系人",prop:"contactPerson"},{default:o(()=>[e(m,{modelValue:a.contactPerson,"onUpdate:modelValue":t[7]||(t[7]=l=>a.contactPerson=l),placeholder:"请输入联系人"},null,8,["modelValue"])]),_:1}),e(c,{label:"联系电话",prop:"contactPhone"},{default:o(()=>[e(m,{modelValue:a.contactPhone,"onUpdate:modelValue":t[8]||(t[8]=l=>a.contactPhone=l),placeholder:"请输入联系电话"},null,8,["modelValue"])]),_:1}),e(c,{label:"报价日期",prop:"quoteDate"},{default:o(()=>[e(G,{modelValue:a.quoteDate,"onUpdate:modelValue":t[9]||(t[9]=l=>a.quoteDate=l),type:"date",placeholder:"请选择报价日期"},null,8,["modelValue"])]),_:1}),e(c,{label:"有效期至",prop:"validUntil"},{default:o(()=>[e(G,{modelValue:a.validUntil,"onUpdate:modelValue":t[10]||(t[10]=l=>a.validUntil=l),type:"date",placeholder:"请选择有效期至"},null,8,["modelValue"])]),_:1}),e(c,{label:"报价状态",prop:"quoteStatus"},{default:o(()=>[e(M,{modelValue:a.quoteStatus,"onUpdate:modelValue":t[11]||(t[11]=l=>a.quoteStatus=l),placeholder:"请选择报价状态"},{default:o(()=>[e(q,{label:"草稿",value:"draft"}),e(q,{label:"已提交",value:"submitted"})]),_:1},8,["modelValue"])]),_:1}),e(c,{label:"报价备注",prop:"remark"},{default:o(()=>[e(m,{modelValue:a.remark,"onUpdate:modelValue":t[12]||(t[12]=l=>a.remark=l),type:"textarea",placeholder:"请输入报价备注",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1}),e(F,{label:"报价项",name:"items"},{default:o(()=>[E("div",Pe,[e(s,{type:"primary",icon:"Plus",size:"small",onClick:ne,style:{"margin-bottom":"10px"}},{default:o(()=>t[23]||(t[23]=[n(" 新增报价项 ")])),_:1,__:[23]}),e(O,{data:v.value,border:""},{default:o(()=>[e(i,{label:"产品名称",align:"center",prop:"productName"}),e(i,{label:"产品编码",align:"center",prop:"productCode"}),e(i,{label:"数量",align:"center",prop:"quantity"},{default:o(l=>[e(H,{modelValue:l.row.quantity,"onUpdate:modelValue":_=>l.row.quantity=_,min:1,size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),e(i,{label:"单价",align:"center",prop:"unitPrice"},{default:o(l=>[e(m,{modelValue:l.row.unitPrice,"onUpdate:modelValue":_=>l.row.unitPrice=_,type:"number",size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),e(i,{label:"折扣",align:"center",prop:"discount"},{default:o(l=>[e(H,{modelValue:l.row.discount,"onUpdate:modelValue":_=>l.row.discount=_,min:0,max:100,size:"small"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),e(i,{label:"金额",align:"center",prop:"itemAmount"},{default:o(l=>[n(g((l.row.quantity*l.row.unitPrice*(1-l.row.discount/100)).toFixed(2)),1)]),_:1}),e(i,{label:"操作",align:"center",width:"100"},{default:o(l=>[e(s,{size:"small",type:"danger",icon:"Delete",onClick:_=>re(l.row)},{default:o(()=>t[24]||(t[24]=[n(" 删除 ")])),_:2,__:[24]},1032,["onClick"])]),_:1})]),_:1},8,["data"])])]),_:1}),e(F,{label:"价格明细",name:"price"},{default:o(()=>[E("div",Ce,[e(fe,{column:1,border:""},{default:o(()=>[e(w,{label:"商品总价"},{default:o(()=>[n(g(U.value.toFixed(2)),1)]),_:1}),e(w,{label:"折扣金额"},{default:o(()=>[n(g(k.value.toFixed(2)),1)]),_:1}),e(w,{label:"运费"},{default:o(()=>[n(g(a.freightAmount.toFixed(2)),1)]),_:1}),e(w,{label:"税费"},{default:o(()=>[n(g(D.value.toFixed(2)),1)]),_:1}),e(w,{label:"最终总价"},{default:o(()=>[n(g(R.value.toFixed(2)),1)]),_:1})]),_:1})])]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["title","modelValue"])])}}},De=ge(he,[["__scopeId","data-v-1e46bc28"]]);export{De as default};
