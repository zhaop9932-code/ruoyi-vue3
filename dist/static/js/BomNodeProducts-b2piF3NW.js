import{g as Je,a as We,r as we,u as Xe,b as Ye}from"./superBomProductRelation-e2EKVMIZ.js";import{listProduct as Ze}from"./product-CtyH2BmW.js";import{l as et}from"./series-CECqxvZD.js";import{l as Ce}from"./catalog-CV4btQTA.js";import{_ as tt,r as p,C as R,z as H,w as lt,V as y,o as at,h as f,G as ot,d as C,e as u,j as c,H as rt,i as r,k as o,q as b,l as v,m as J,t as h,K as A,L as $,E as ke}from"./index-CwdKQqOf.js";const nt={class:"bom-node-products"},st={class:"management-header"},dt={class:"header-buttons"},ct={class:"tab-content"},ut={class:"selection-list"},it={class:"selection-header"},pt={class:"selected-count"},mt={class:"item-info"},gt={class:"item-name"},ft={class:"item-desc"},vt={key:0,class:"empty-tip"},It={class:"tab-content"},bt={class:"series-selection-container"},_t={class:"catalog-tree-section"},yt={class:"series-list-section"},ht={class:"section-header"},wt={class:"selected-count"},Ct={class:"item-info"},kt={class:"item-name"},Nt={class:"item-desc"},St={key:0,class:"empty-tip"},Tt={class:"tab-content"},Vt={class:"selection-list"},jt={class:"selection-header"},Pt={class:"selected-count"},xt={style:{height:"300px","overflow-y":"auto"}},Ot={class:"tree-node-content"},Lt={class:"dialog-footer"},Bt={__name:"BomNodeProducts",props:{bomId:{type:[String,Number],required:!0},bomStructureId:{type:[String,Number],default:null}},setup(Ne){const i=Ne,M=p(!1),P=p([]),x=p(!1),W=p("新增关联产品"),X=p(null),I=p([]),E=p([]),Y=p(!1),Z=p([]),ee=p(!1),pe=p([]),U=p(!1),F=R({pageNum:1,pageSize:100,productName:"",productCode:""}),S=R({pageNum:1,pageSize:100,seriesName:"",seriesCode:"",brandName:"",catalogId:null}),te=R({pageNum:1,pageSize:100,catalogName:""}),_=R({seriesCode:"",seriesName:"",brandName:""}),Se=p(null),le=p(null),V=p([]),me={label:"catalogName",children:"children"},ge=p(null),d=R({relationId:null,bomId:i.bomId,structureId:i.bomStructureId,relationType:"",relationObjectId:"",relationObjectIds:[]}),Te=R({relationObjectIds:[{required:!0,message:"请选择关联对象",trigger:"change"},{type:"array",min:1,message:"请至少选择一个关联对象",trigger:"change"}]}),z=p("product"),j=p(""),ae=p(""),T=p(""),O=p([]),L=p([]),B=p([]),q=t=>{const e=Number(t),a=String(t),n=I.value.filter(s=>{const m=s.relationType,g=m===e||m===a||String(m)===a||Number(m)===e;return console.log(`检查产品 ${s.relationObjectId} 的类型匹配:`,{itemType:m,type:t,typeNum:e,typeStr:a,typeMatch:g}),g&&s.relationId!==d.relationId}).map(s=>s.relationObjectId);return console.log(`获取类型 ${t} 的已关联ID:`,n),console.log("当前产品列表:",I.value),n},oe=H(()=>{const t=q("1");console.log("已关联的产品ID列表:",t),console.log("可选产品列表:",E.value);let e=E.value.filter(a=>{const n=t.includes(a.productId)||t.includes(String(a.productId))||t.includes(Number(a.productId));return console.log(`产品 ${a.productId} (${a.productName}) 是否已关联:`,n),!n});if(j.value){const a=j.value.toLowerCase();e=e.filter(n=>n.productCode.toLowerCase().includes(a)||n.productName.toLowerCase().includes(a))}return console.log("过滤后的产品列表:",e),e}),re=H(()=>{const t=q("2");let e=Z.value.filter(a=>!t.includes(a.seriesId));if(ae.value){const a=ae.value.toLowerCase();e=e.filter(n=>n.seriesName.toLowerCase().includes(a))}return e}),Ve=H(()=>{const t=q("3"),e=n=>n.filter(s=>!t.includes(s.catalogId)).map(s=>({...s,children:s.children?e(s.children):[]}));let a=e(V.value);if(T.value){const n=T.value.toLowerCase(),s=m=>m.reduce((g,k)=>{const w=k.catalogName.toLowerCase().includes(n);let N=[];return k.children&&k.children.length>0&&(N=s(k.children)),(w||N.length>0)&&g.push({...k,children:N}),g},[]);a=s(a)}return a}),ne=t=>{switch(t){case"product":return O.value.length;case"series":return L.value.length;case"catalog":return B.value.length;default:return 0}};lt([()=>i.bomId,()=>i.bomStructureId],([t,e])=>{t&&(d.bomId=t,d.structureId=e,D())});const je=t=>({1:"具体型号",2:"产品系列",3:"产品类目"})[t]||t,Pe=t=>({1:"primary",2:"success",3:"warning"})[t]||"default",xe=()=>{d.relationObjectId="",d.relationObjectIds=[]},Oe=t=>{z.value=t,t==="product"&&E.value.length===0?se():t==="series"?(Z.value.length===0&&K(),V.value.length===0&&de()):t==="catalog"&&pe.value.length===0&&Q()},se=async()=>{Y.value=!0;try{const t=await Ze(F);E.value=t.rows||[]}catch(t){console.error("加载产品列表失败:",t),y.error("加载产品列表失败")}finally{Y.value=!1}},K=async()=>{ee.value=!0;try{S.seriesName=_.seriesName,S.seriesCode=_.seriesCode,S.brandName=_.brandName;const t=await et(S);Z.value=t.rows||[]}catch(t){console.error("加载系列列表失败:",t),y.error("加载系列列表失败")}finally{ee.value=!1}};let Q=async()=>{U.value=!0;try{const t=await Ce(te);pe.value=t.rows||[]}catch(t){console.error("加载分类列表失败:",t),y.error("加载分类列表失败")}finally{U.value=!1}};const de=async()=>{try{U.value=!0,console.log("开始加载分类树数据...");const t=await Ce();console.log("listCatalog API返回数据:",t);let e=[];t&&Array.isArray(t.rows)?e=t.rows:t&&Array.isArray(t.data)&&(e=t.data),console.log("获取到分类列表，共",e.length,"条数据"),e.length===0&&(console.warn("分类列表为空，使用简化默认数据"),e=[{catalogId:1,catalogName:"默认分类",parentId:0}]);const a=Le(e);console.log("分类列表转树状结构成功，共",a.length,"个根节点"),V.value=a}catch(t){console.error("加载分类树失败:",t),V.value=[{catalogId:1,catalogName:"默认分类",parentId:0}],y.error("加载分类树失败，使用默认数据")}finally{U.value=!1}},Le=t=>{if(!Array.isArray(t)||t.length===0)return[];const e=[],a=new Map;return t.forEach(n=>{a.set(n.catalogId,{catalogId:n.catalogId,catalogName:n.catalogName,parentId:n.parentId||0,children:[]})}),t.forEach(n=>{const s=a.get(n.catalogId),m=n.parentId||0;m===0||!a.has(m)?e.push(s):a.get(m).children.push(s)}),e},fe=async()=>{F.productName=j.value,F.productCode=j.value,F.pageNum=1,await se()},G=async()=>{S.pageNum=1,await K()},Be=async()=>{_.seriesCode="",_.seriesName="",_.brandName="",S.catalogId=null,ge.value=null,await K()},De=t=>{ge.value=t.catalogId,S.catalogId=t.catalogId,S.pageNum=1,K()},ve=async()=>{te.catalogName=T.value,te.pageNum=1,await Q()},Re=(t,e,a)=>{if(console.log("分类树勾选事件:",t,e,a),le.value){const n=le.value.getCheckedKeys();console.log("获取到选中的分类ID:",n),B.value=n}},Ae=H(()=>{const t=s=>{let m=[];return s.forEach(g=>{m.push({catalogId:g.catalogId,catalogName:g.catalogName,parentId:g.parentId}),g.children&&g.children.length>0&&(m=m.concat(t(g.children)))}),m},e=t(V.value),a=q("3");let n=e.filter(s=>!a.includes(s.catalogId));if(T.value){const s=T.value.toLowerCase();n=n.filter(m=>m.catalogName.toLowerCase().includes(s))}return n}),Ue=Q;Q=async()=>{await Ue(),V.value.length===0&&await de()};const D=async()=>{M.value=!0;try{console.log("开始加载关联产品列表，bomId:",i.bomId,"bomStructureId:",i.bomStructureId);let t;i.bomStructureId?(console.log("使用带结构ID的API"),t=await Je({bomId:i.bomId,structureId:i.bomStructureId})):(console.log("使用不带结构ID的API"),t=await We(i.bomId)),console.log("API响应:",t);let e=[];return Array.isArray(t)?e=t:t&&typeof t=="object"&&(e=t.rows||t.data||[]),console.log("解析后的数据:",e),I.value=e,M.value=!1,console.log("关联产品列表加载完成，数据量:",e.length),e}catch(t){return console.error("加载关联产品列表失败:",t),y.error("加载关联产品列表失败"),M.value=!1,[]}},$e=t=>{P.value=t},Me=()=>{Ie(),W.value="新增关联产品",x.value=!0,se(),de(),D()},Ee=t=>{const e={...t,relationType:t.relationType.toString(),relationObjectIds:[t.relationObjectId]};Object.assign(d,e),W.value="编辑关联产品",x.value=!0},Fe=async t=>{try{await ke.confirm(`确定要删除与${je(t.relationType)} "${t.relationObjectName}" 的关联吗？`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await we([t.relationId]),I.value=I.value.filter(e=>e.relationId!==t.relationId),y.success("关联产品删除成功")}catch(e){e!=="cancel"&&(y.error("删除失败"),console.error("删除关联产品失败:",e))}},ze=async()=>{if(P.value.length!==0)try{await ke.confirm(`确定要删除选中的 ${P.value.length} 个关联产品吗？`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=P.value.map(e=>e.relationId);await we(t),I.value=I.value.filter(e=>!t.includes(e.relationId)),P.value=[],y.success("批量删除成功")}catch(t){t!=="cancel"&&(y.error("批量删除失败"),console.error("批量删除关联产品失败:",t))}},qe=async()=>{try{const t=[];if(d.relationId){await X.value.validate(),console.log("productForm",d);const e={...d,relationType:parseInt(d.relationType),relationObjectId:parseInt(d.relationObjectIds[0])};i.bomStructureId&&(e.structureId=i.bomStructureId),await Xe(e);const a=I.value.findIndex(n=>n.relationId===d.relationId);a!==-1&&(I.value[a]={...e}),y.success("关联产品更新成功")}else{if(O.value.length>0){const a=O.value.map(n=>{const s={bomId:i.bomId,relationType:1,relationObjectId:parseInt(n)};return i.bomStructureId&&(s.structureId=i.bomStructureId),s});t.push(...a)}if(L.value.length>0){const a=L.value.map(n=>{const s={bomId:i.bomId,relationType:2,relationObjectId:parseInt(n)};return i.bomStructureId&&(s.structureId=i.bomStructureId),s});t.push(...a)}if(B.value.length>0){const a=B.value.map(n=>{const s={bomId:i.bomId,relationType:3,relationObjectId:parseInt(n)};return i.bomStructureId&&(s.structureId=i.bomStructureId),s});t.push(...a)}if(t.length===0){y.warning("请至少选择一个关联对象");return}const e=await Ye(t);if(e&&Array.isArray(e))I.value.push(...e);else if(e&&e.code===200){const a=e.rows||e.data||[];a.length>0?I.value.push(...a):await D()}else await D();y.success(`成功新增 ${t.length} 个关联产品`)}x.value=!1,Ie()}catch(t){console.error("提交关联产品表单失败:",t),t!==!1&&y.error("操作失败，请检查表单数据")}},Ie=()=>{var t;d.relationId=null,d.bomId=i.bomId,d.structureId=i.bomStructureId,d.relationType="",d.relationObjectId="",d.relationObjectIds=[],j.value="",ae.value="",T.value="",O.value=[],L.value=[],B.value=[],z.value="product",(t=X.value)==null||t.resetFields()};return at(async()=>{console.log("组件挂载，开始加载关联产品列表，bomId:",i.bomId),await D(),console.log("初始加载完成，关联产品列表:",I.value)}),(t,e)=>{const a=f("el-button"),n=f("el-table-column"),s=f("el-tag"),m=f("el-table"),g=f("el-option"),k=f("el-select"),w=f("el-form-item"),N=f("el-input"),ce=f("el-skeleton"),be=f("el-checkbox"),_e=f("el-checkbox-group"),ue=f("el-scrollbar"),ie=f("el-tab-pane"),ye=f("el-form"),he=f("el-tree"),Ke=f("el-tabs"),Qe=f("el-dialog"),Ge=ot("loading");return u(),C("div",nt,[c("div",st,[e[17]||(e[17]=c("h3",null,"关联产品管理",-1)),c("div",dt,[r(a,{type:"primary",icon:"Plus",onClick:Me},{default:o(()=>e[14]||(e[14]=[b("新增关联产品")])),_:1,__:[14]}),r(a,{type:"danger",icon:"Delete",onClick:ze,disabled:P.value.length===0},{default:o(()=>e[15]||(e[15]=[b("批量删除")])),_:1,__:[15]},8,["disabled"]),r(a,{type:"info",icon:"Refresh",onClick:D},{default:o(()=>e[16]||(e[16]=[b("刷新列表")])),_:1,__:[16]})])]),rt((u(),v(m,{data:I.value,stripe:"",style:{width:"100%"}},{default:o(()=>[r(n,{type:"selection",width:"55",align:"center",onSelectionChange:$e}),r(n,{label:"关联类型",align:"center",prop:"relationTypeName",width:"120"},{default:o(l=>[r(s,{type:Pe(l.row.relationType)},{default:o(()=>[b(h(l.row.relationTypeName),1)]),_:2},1032,["type"])]),_:1}),r(n,{label:"产品名称",align:"center",prop:"productName","min-width":"150"},{default:o(l=>[b(h(l.row.productName||l.row.relationObjectName||"无"),1)]),_:1}),I.value.some(l=>l.relationType===1)?(u(),v(n,{key:0,label:"产品型号",align:"center","min-width":"150"},{default:o(l=>[b(h(l.row.relationType===1?l.row.productModel||l.row.modelName||"无":"-"),1)]),_:1})):J("",!0),r(n,{label:"操作",align:"center",width:"150",fixed:"right"},{default:o(l=>[r(a,{size:"small",type:"primary",icon:"Edit",onClick:He=>Ee(l.row)},{default:o(()=>e[18]||(e[18]=[b(" 编辑 ")])),_:2,__:[18]},1032,["onClick"]),r(a,{size:"small",type:"danger",icon:"Delete",onClick:He=>Fe(l.row)},{default:o(()=>e[19]||(e[19]=[b(" 删除 ")])),_:2,__:[19]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[Ge,M.value]]),r(Qe,{title:W.value,modelValue:x.value,"onUpdate:modelValue":e[13]||(e[13]=l=>x.value=l),width:"800px","append-to-body":""},{footer:o(()=>[c("span",Lt,[r(a,{onClick:e[12]||(e[12]=l=>x.value=!1)},{default:o(()=>e[28]||(e[28]=[b("取消")])),_:1,__:[28]}),r(a,{type:"primary",onClick:qe},{default:o(()=>e[29]||(e[29]=[b("确定")])),_:1,__:[29]})])]),default:o(()=>[r(ye,{ref_key:"productFormRef",ref:X,model:d,rules:Te,"label-width":"120px"},{default:o(()=>[d.relationId?(u(),C(A,{key:0},[r(w,{label:"关联类型",prop:"relationType"},{default:o(()=>[r(k,{modelValue:d.relationType,"onUpdate:modelValue":e[0]||(e[0]=l=>d.relationType=l),placeholder:"请选择关联类型",onChange:xe},{default:o(()=>[r(g,{label:"具体型号",value:"1"}),r(g,{label:"产品系列",value:"2"}),r(g,{label:"产品类目",value:"3"})]),_:1},8,["modelValue"])]),_:1}),d.relationType==="1"?(u(),v(w,{key:0,label:"产品型号",prop:"relationObjectIds"},{default:o(()=>[r(k,{modelValue:d.relationObjectIds,"onUpdate:modelValue":e[1]||(e[1]=l=>d.relationObjectIds=l),placeholder:"请选择产品型号",filterable:"","collapse-tags":""},{default:o(()=>[(u(!0),C(A,null,$(oe.value,l=>(u(),v(g,{key:l.productId,label:`${l.productCode} - ${l.productName}`,value:l.productId},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):d.relationType==="2"?(u(),v(w,{key:1,label:"产品系列",prop:"relationObjectIds"},{default:o(()=>[r(k,{modelValue:d.relationObjectIds,"onUpdate:modelValue":e[2]||(e[2]=l=>d.relationObjectIds=l),placeholder:"请选择产品系列",filterable:"","collapse-tags":""},{default:o(()=>[(u(!0),C(A,null,$(re.value,l=>(u(),v(g,{key:l.seriesId,label:l.seriesName,value:l.seriesId},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):d.relationType==="3"?(u(),v(w,{key:2,label:"产品类目",prop:"relationObjectIds"},{default:o(()=>[r(k,{modelValue:d.relationObjectIds,"onUpdate:modelValue":e[3]||(e[3]=l=>d.relationObjectIds=l),placeholder:"请选择产品类目",filterable:"","collapse-tags":""},{default:o(()=>[(u(!0),C(A,null,$(Ae.value,l=>(u(),v(g,{key:l.catalogId,label:l.catalogName,value:l.catalogId},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})):J("",!0)],64)):(u(),v(Ke,{key:1,modelValue:z.value,"onUpdate:modelValue":e[11]||(e[11]=l=>z.value=l),type:"card",onTabChange:Oe},{default:o(()=>[r(ie,{label:"产品",name:"product"},{default:o(()=>[c("div",ct,[r(w,{label:"产品搜索",prop:"productSearch"},{default:o(()=>[r(N,{modelValue:j.value,"onUpdate:modelValue":e[4]||(e[4]=l=>j.value=l),placeholder:"请输入产品名称或编码",clearable:"",onInput:fe},{append:o(()=>[r(a,{type:"primary",icon:"Search",onClick:fe},{default:o(()=>e[20]||(e[20]=[b("搜索")])),_:1,__:[20]})]),_:1},8,["modelValue"])]),_:1}),c("div",ut,[c("div",it,[e[21]||(e[21]=c("span",null,"产品列表",-1)),c("span",pt,"已选择: "+h(ne("product")),1)]),r(ue,{height:"250px"},{default:o(()=>[Y.value?(u(),v(ce,{key:0,rows:5,animated:""})):(u(),v(_e,{key:1,modelValue:O.value,"onUpdate:modelValue":e[5]||(e[5]=l=>O.value=l)},{default:o(()=>[(u(!0),C(A,null,$(oe.value,l=>(u(),C("div",{key:l.productId,class:"selection-item"},[r(be,{label:l.productId},{default:o(()=>[c("div",mt,[c("div",gt,h(l.productCode)+" - "+h(l.productName),1),c("div",ft,"型号: "+h(l.modelName||l.productModel||"无"),1)])]),_:2},1032,["label"])]))),128)),oe.value.length===0?(u(),C("div",vt," 暂无产品数据 ")):J("",!0)]),_:1},8,["modelValue"]))]),_:1})])])]),_:1}),r(ie,{label:"系列",name:"series"},{default:o(()=>[c("div",It,[r(ye,{inline:!0,model:_,class:"search-form"},{default:o(()=>[r(w,{label:"系列编码"},{default:o(()=>[r(N,{modelValue:_.seriesCode,"onUpdate:modelValue":e[6]||(e[6]=l=>_.seriesCode=l),placeholder:"请输入系列编码",clearable:"",onInput:G,style:{width:"180px"}},null,8,["modelValue"])]),_:1}),r(w,{label:"系列名称"},{default:o(()=>[r(N,{modelValue:_.seriesName,"onUpdate:modelValue":e[7]||(e[7]=l=>_.seriesName=l),placeholder:"请输入系列名称",clearable:"",onInput:G,style:{width:"180px"}},null,8,["modelValue"])]),_:1}),r(w,{label:"品牌"},{default:o(()=>[r(N,{modelValue:_.brandName,"onUpdate:modelValue":e[8]||(e[8]=l=>_.brandName=l),placeholder:"请输入品牌名称",clearable:"",onInput:G,style:{width:"180px"}},null,8,["modelValue"])]),_:1}),r(w,null,{default:o(()=>[r(a,{type:"primary",icon:"Search",onClick:G},{default:o(()=>e[22]||(e[22]=[b("搜索")])),_:1,__:[22]}),r(a,{icon:"RefreshRight",onClick:Be},{default:o(()=>e[23]||(e[23]=[b("重置")])),_:1,__:[23]})]),_:1})]),_:1},8,["model"]),c("div",bt,[c("div",_t,[e[24]||(e[24]=c("div",{class:"section-header"},"分类树",-1)),r(ue,{height:"300px"},{default:o(()=>[r(he,{ref_key:"catalogTreeRef",ref:Se,data:V.value,props:me,"node-key":"catalogId","default-expand-all":"",onNodeClick:De},null,8,["data"])]),_:1})]),c("div",yt,[c("div",ht,[e[25]||(e[25]=c("span",null,"产品系列列表",-1)),c("span",wt,"已选择: "+h(ne("series")),1)]),r(ue,{height:"300px"},{default:o(()=>[ee.value?(u(),v(ce,{key:0,rows:5,animated:""})):(u(),v(_e,{key:1,modelValue:L.value,"onUpdate:modelValue":e[9]||(e[9]=l=>L.value=l)},{default:o(()=>[(u(!0),C(A,null,$(re.value,l=>(u(),C("div",{key:l.seriesId,class:"selection-item"},[r(be,{label:l.seriesId},{default:o(()=>[c("div",Ct,[c("div",kt,h(l.seriesCode||"")+" - "+h(l.seriesName),1),c("div",Nt,"品牌: "+h(l.brandName||"无"),1)])]),_:2},1032,["label"])]))),128)),re.value.length===0?(u(),C("div",St," 暂无产品系列数据 ")):J("",!0)]),_:1},8,["modelValue"]))]),_:1})])])])]),_:1}),r(ie,{label:"分类",name:"catalog"},{default:o(()=>[c("div",Tt,[r(w,{label:"分类搜索",prop:"catalogSearch"},{default:o(()=>[r(N,{modelValue:T.value,"onUpdate:modelValue":e[10]||(e[10]=l=>T.value=l),placeholder:"请输入产品类目名称",clearable:"",onInput:ve},{append:o(()=>[r(a,{type:"primary",icon:"Search",onClick:ve},{default:o(()=>e[26]||(e[26]=[b("搜索")])),_:1,__:[26]})]),_:1},8,["modelValue"])]),_:1}),c("div",Vt,[c("div",jt,[e[27]||(e[27]=c("span",null,"产品类目树",-1)),c("span",Pt,"已选择: "+h(ne("catalog")),1)]),c("div",xt,[U.value?(u(),v(ce,{key:0,rows:10,animated:""})):(u(),v(he,{key:1,ref_key:"catalogSelectTreeRef",ref:le,data:Ve.value,props:me,"node-key":"catalogId","show-checkbox":"","default-expand-all":"","default-checked-keys":B.value,onCheck:Re},{default:o(({node:l})=>[c("div",Ot,[c("span",null,h(l.label),1)])]),_:1},8,["data","default-checked-keys"]))])])])]),_:1})]),_:1},8,["modelValue"]))]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue"])])}}},Mt=tt(Bt,[["__scopeId","data-v-da0beda3"]]);export{Mt as default};
