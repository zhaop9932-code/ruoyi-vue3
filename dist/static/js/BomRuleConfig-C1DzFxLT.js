import{x as O,_ as Re,r as m,B as we,g as xe,i as ke,a as r,c as R,o as g,e as u,k as Ie,b as l,q as X,w as n,f,F as Te,s as Ne,z as Ue,t as I,G as M,N as b,ad as he,ae as A,ab as Be,m as Ee,v as De,ah as Me,aj as Ae,ai as Oe,A as Se,E as p,n as $e}from"./index-kbfDsxmo.js";import ze from"./RuleConditionConfig-BqZ8r2HV.js";import je from"./RuleActionConfig-va3O5bJR.js";import qe from"./RuleAdvancedConfig-DlueG-wr.js";/* empty css                                                                     */import{u as Y,b as Le,d as Fe}from"./rule-CEcLc8TF.js";import"./vuedraggable.umd-CWWwxWVR.js";import"./sortable.esm-DysyInFf.js";const Ge=v=>O({url:"/cpq/superBomRuleRelation/getByBomId",method:"post",data:typeof v=="object"?v:{bomId:v}}),Z=v=>O({url:"/cpq/superBomRuleRelation/edit",method:"post",data:v}),Je=v=>O({url:"/cpq/superBomRuleRelation/remove",method:"post",data:v}),Pe={class:"bom-rule-config"},He={class:"rule-content"},We={class:"rule-main"},Ke={class:"rule-list-container"},Qe={class:"list-header"},Xe={class:"list-actions"},Ye={class:"rule-list"},Ze=["onClick"],el={class:"rule-item-header"},ll={class:"rule-item-info"},tl={class:"rule-name"},al={class:"rule-meta"},ol={key:0,class:"rule-item-description"},nl={key:0,class:"empty-rules"},sl={class:"rule-detail-container"},ul={key:0,class:"empty-detail"},il={class:"rule-basic-info"},rl={class:"form-actions"},dl={class:"dialog-footer"},pl={__name:"BomRuleConfig",props:{bomId:{type:[String,Number],required:!0}},setup(v,{expose:ee}){const S=v,$=m(!1),T=m(""),B=m([]),o=m(null),N=m("basic"),w=m(!1),le=m(0),te=m(0),_=m(null),z=we(()=>T.value?B.value.filter(t=>t.ruleName.includes(T.value)):B.value),ae=t=>({1:"验证规则",2:"计算规则",3:"条件规则",4:"跳转规则"})[t]||t,oe=t=>({1:"primary",2:"success",3:"warning",4:"info"})[t]||"default",x=m(!1),j=m(null),i=xe({ruleName:"",ruleType:"1",priority:1,description:""}),ne={ruleName:[{required:!0,message:"请输入规则名称",trigger:"blur"}],ruleType:[{required:!0,message:"请选择规则类型",trigger:"change"}]},V=async()=>{try{$.value=!0;const e=(await Ge(S.bomId)).data||[];B.value=e.map(s=>({ruleId:s.ruleId,ruleName:s.ruleName,ruleCode:s.ruleCode,ruleType:s.ruleType,relationId:s.relationId,bomId:s.bomId,ruleOrder:s.ruleOrder,relationType:s.relationType,status:s.status===0||s.status==="0"?"enabled":"disabled",remark:s.remark,ruleExpression:"",conditions:[],actions:[],advancedConfig:{}}))}catch(t){console.error("加载规则列表失败:",t),p.error("加载规则列表失败")}finally{$.value=!1}},se=t=>{o.value=t,N.value="basic"},ue=(t,e)=>{switch(t){case"edit":q(e);break;case"toggle":E(e);break;case"delete":L(e);break}},ie=()=>{x.value=!0,Object.assign(i,{ruleName:"",ruleType:"1",priority:1,description:""})},q=t=>{o.value=t,N.value="basic"},E=async(t,e)=>{try{if(t.status=e,await Y(t),t.relationId){const s={relationId:t.relationId,status:e==="enabled"?0:1};await Z(s)}p.success(`规则及关联关系${e==="enabled"?"启用":"禁用"}成功`),await V()}catch(s){t.status=t.status==="enabled"?"disabled":"enabled",console.error("切换规则状态失败:",s),p.error("切换规则状态失败")}},L=async t=>{var e;try{await $e.confirm(`确定删除规则"${t.ruleName}"及关联关系吗？`,"提示",{type:"warning"}),t.relationId&&await Je([t.relationId]),await Fe(t.ruleId),await V(),((e=o.value)==null?void 0:e.ruleId)===t.ruleId&&(o.value=null),p.success("删除规则及关联关系成功")}catch(s){s!=="cancel"&&(console.error("删除规则失败:",s),p.error("删除规则失败"))}},re=()=>{_.value&&(q(_.value),w.value=!1)},de=()=>{_.value&&(E(_.value,_.value.status==="enabled"?"disabled":"enabled"),w.value=!1)},pe=()=>{_.value&&(L(_.value),w.value=!1)},me=async()=>{try{await j.value.validate();const t={bomId:S.bomId,rule:{ruleCode:`RULE_${Date.now()}`,ruleName:i.ruleName,ruleType:i.ruleType,conditionType:"simple",triggerCondition:"onSelect",conditionConfig:JSON.stringify(i.conditions||[]),ruleAction:"showMessage",actionType:"simple",actionConfig:JSON.stringify(i.actions||[]),rulePriority:i.priority,effectiveDate:null,expireDate:null,ruleStatus:"0",description:i.description,ruleOrder:i.priority||1,remark:""}};await Le(t),x.value=!1,await V(),p.success("新增规则及关联关系成功")}catch(t){t!=="cancel"&&(console.error("新增规则失败:",t),p.error("新增规则失败"))}},ce=async()=>{try{if(!o.value)return;if(await Y(o.value),o.value.relationId){const t={relationId:o.value.relationId,ruleOrder:o.value.ruleOrder||o.value.priority||1,status:o.value.status==="enabled"?0:1,remark:o.value.remark};await Z(t)}p.success("保存规则及关联关系成功"),await V()}catch(t){console.error("保存规则失败:",t),p.error("保存规则失败")}},ve=()=>{o.value=null},U=()=>{if(!o.value)return;const t=o.value.conditions||[],e=o.value.actions||[];let s="";t.length>0&&(s+="IF "+t.map(d=>`${d.field} ${d.operator} ${d.value}`).join(" AND ")+" THEN "),e.length>0&&(s+=e.map(d=>`${d.type}: ${d.target}`).join("; ")),o.value.ruleExpression=s},fe=t=>{o.value&&(Object.assign(o.value,t),U(),p.success("AI生成规则成功"))},_e=t=>{o.value&&(Object.assign(o.value,t),U(),p.success("AI优化规则成功"))},ye=t=>{t.length>0?p.warning(`检测到${t.length}个冲突，请检查规则配置`):p.success("未检测到冲突")};return document.addEventListener("click",()=>{w.value=!1}),ke(()=>{V()}),ee({loadRuleList:V}),(t,e)=>{var K;const s=r("el-input"),d=r("el-button"),be=r("el-tag"),F=r("el-switch"),G=r("el-empty"),c=r("el-form-item"),h=r("el-col"),y=r("el-option"),J=r("el-select"),P=r("el-row"),H=r("el-input-number"),W=r("el-form"),k=r("el-tab-pane"),ge=r("rule-ai-assist"),Ve=r("el-tabs"),D=r("el-icon"),Ce=r("el-dialog");return g(),R("div",Pe,[u("div",He,[u("div",We,[u("div",Ke,[u("div",Qe,[u("div",Xe,[l(s,{modelValue:T.value,"onUpdate:modelValue":e[0]||(e[0]=a=>T.value=a),placeholder:"搜索规则名称","prefix-icon":"Search",clearable:"",size:"small",style:{width:"200px","margin-right":"16px"}},null,8,["modelValue"]),l(d,{type:"primary",icon:"Plus",onClick:ie,size:"small"},{default:n(()=>e[20]||(e[20]=[f("新增规则")])),_:1,__:[20]})])]),u("div",Ye,[(g(!0),R(Te,null,Ne(z.value,a=>{var Q;return g(),R("div",{key:a.ruleId,class:Ue(["rule-item",{"rule-item-selected":((Q=o.value)==null?void 0:Q.ruleId)===a.ruleId}]),onClick:C=>se(a)},[u("div",el,[u("div",ll,[u("div",tl,I(a.ruleName),1),u("div",al,[l(be,{type:oe(a.ruleType)},{default:n(()=>[f(I(ae(a.ruleType)),1)]),_:2},1032,["type"]),l(F,{modelValue:a.status,"onUpdate:modelValue":C=>a.status=C,"active-value":"enabled","inactive-value":"disabled",onChange:C=>E(a,C),size:"small",onClick:e[1]||(e[1]=M(()=>{},["stop"]))},null,8,["modelValue","onUpdate:modelValue","onChange"])])]),l(b(Be),{onCommand:C=>ue(C,a),onClick:e[2]||(e[2]=M(()=>{},["stop"]))},{dropdown:n(()=>[l(b(he),null,{default:n(()=>[l(b(A),{command:"edit"},{default:n(()=>e[21]||(e[21]=[f("编辑规则")])),_:1,__:[21]}),l(b(A),{command:"toggle"},{default:n(()=>[f(I(a.status==="enabled"?"禁用":"启用"),1)]),_:2},1024),l(b(A),{command:"delete"},{default:n(()=>e[22]||(e[22]=[f("删除规则")])),_:1,__:[22]})]),_:2},1024)]),default:n(()=>[l(d,{type:"text",icon:"More",size:"small"})]),_:2},1032,["onCommand"])]),a.description?(g(),R("div",ol,I(a.description),1)):X("",!0)],10,Ze)}),128))]),z.value.length===0?(g(),R("div",nl,[l(G,{description:"暂无规则"})])):X("",!0)]),u("div",sl,[o.value?(g(),Ee(Ve,{key:1,modelValue:N.value,"onUpdate:modelValue":e[12]||(e[12]=a=>N.value=a),type:"border-card"},{default:n(()=>[l(k,{label:"规则基本信息",name:"basic"},{default:n(()=>[u("div",il,[l(W,{model:o.value,"label-width":"120px"},{default:n(()=>[l(P,{gutter:20},{default:n(()=>[l(h,{span:12},{default:n(()=>[l(c,{label:"规则名称"},{default:n(()=>[l(s,{modelValue:o.value.ruleName,"onUpdate:modelValue":e[3]||(e[3]=a=>o.value.ruleName=a),placeholder:"规则名称"},null,8,["modelValue"])]),_:1})]),_:1}),l(h,{span:12},{default:n(()=>[l(c,{label:"规则类型"},{default:n(()=>[l(J,{modelValue:o.value.ruleType,"onUpdate:modelValue":e[4]||(e[4]=a=>o.value.ruleType=a),placeholder:"规则类型"},{default:n(()=>[l(y,{label:"验证规则",value:"1"}),l(y,{label:"计算规则",value:"2"}),l(y,{label:"条件规则",value:"3"}),l(y,{label:"跳转规则",value:"4"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(P,{gutter:20},{default:n(()=>[l(h,{span:12},{default:n(()=>[l(c,{label:"优先级"},{default:n(()=>[l(H,{modelValue:o.value.priority,"onUpdate:modelValue":e[5]||(e[5]=a=>o.value.priority=a),min:1,max:10,step:1},null,8,["modelValue"])]),_:1})]),_:1}),l(h,{span:12},{default:n(()=>[l(c,{label:"状态"},{default:n(()=>[l(F,{modelValue:o.value.status,"onUpdate:modelValue":e[6]||(e[6]=a=>o.value.status=a),"active-value":"enabled","inactive-value":"disabled"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(c,{label:"规则表达式"},{default:n(()=>[l(s,{modelValue:o.value.ruleExpression,"onUpdate:modelValue":e[7]||(e[7]=a=>o.value.ruleExpression=a),type:"textarea",rows:4,readonly:""},null,8,["modelValue"])]),_:1}),l(c,{label:"描述"},{default:n(()=>[l(s,{modelValue:o.value.description,"onUpdate:modelValue":e[8]||(e[8]=a=>o.value.description=a),type:"textarea",rows:3,placeholder:"规则描述"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]),u("div",rl,[l(d,{type:"primary",onClick:ce},{default:n(()=>e[23]||(e[23]=[f("保存")])),_:1,__:[23]}),l(d,{onClick:ve},{default:n(()=>e[24]||(e[24]=[f("取消")])),_:1,__:[24]})])])]),_:1}),l(k,{label:"条件配置",name:"condition"},{default:n(()=>[l(ze,{modelValue:o.value.conditions,"onUpdate:modelValue":e[9]||(e[9]=a=>o.value.conditions=a),"rule-type":o.value.ruleType,"onUpdate:conditions":U},null,8,["modelValue","rule-type"])]),_:1}),l(k,{label:"动作配置",name:"action"},{default:n(()=>[l(je,{modelValue:o.value.actions,"onUpdate:modelValue":e[10]||(e[10]=a=>o.value.actions=a),"rule-type":o.value.ruleType,"onUpdate:actions":U},null,8,["modelValue","rule-type"])]),_:1}),l(k,{label:"高级配置",name:"advanced"},{default:n(()=>[l(qe,{modelValue:o.value.advancedConfig,"onUpdate:modelValue":e[11]||(e[11]=a=>o.value.advancedConfig=a),"rule-type":o.value.ruleType},null,8,["modelValue","rule-type"])]),_:1}),l(k,{label:"AI辅助",name:"ai"},{default:n(()=>[l(ge,{onGenerateRule:fe,onOptimizeRule:_e,onDetectConflicts:ye})]),_:1})]),_:1},8,["modelValue"])):(g(),R("div",ul,[l(G,{description:"请选择或新增一个规则"})]))])])]),Ie(u("div",{class:"context-menu",style:Se({left:le.value+"px",top:te.value+"px"}),onClick:e[13]||(e[13]=M(()=>{},["stop"]))},[u("div",{class:"menu-item",onClick:re},[l(D,null,{default:n(()=>[l(b(Me))]),_:1}),e[25]||(e[25]=u("span",null,"编辑规则",-1))]),u("div",{class:"menu-item",onClick:de},[l(D,null,{default:n(()=>[l(b(Ae))]),_:1}),u("span",null,I(((K=_.value)==null?void 0:K.status)==="enabled"?"禁用规则":"启用规则"),1)]),u("div",{class:"menu-item",onClick:pe},[l(D,null,{default:n(()=>[l(b(Oe))]),_:1}),e[26]||(e[26]=u("span",null,"删除规则",-1))])],4),[[De,w.value]]),l(Ce,{title:"新增规则",modelValue:x.value,"onUpdate:modelValue":e[19]||(e[19]=a=>x.value=a),width:"600px","append-to-body":""},{footer:n(()=>[u("span",dl,[l(d,{onClick:e[18]||(e[18]=a=>x.value=!1)},{default:n(()=>e[27]||(e[27]=[f("取消")])),_:1,__:[27]}),l(d,{type:"primary",onClick:me},{default:n(()=>e[28]||(e[28]=[f("确定")])),_:1,__:[28]})])]),default:n(()=>[l(W,{ref_key:"dialogFormRef",ref:j,model:i,rules:ne,"label-width":"120px"},{default:n(()=>[l(c,{label:"规则名称",prop:"ruleName"},{default:n(()=>[l(s,{modelValue:i.ruleName,"onUpdate:modelValue":e[14]||(e[14]=a=>i.ruleName=a),placeholder:"请输入规则名称"},null,8,["modelValue"])]),_:1}),l(c,{label:"规则类型",prop:"ruleType"},{default:n(()=>[l(J,{modelValue:i.ruleType,"onUpdate:modelValue":e[15]||(e[15]=a=>i.ruleType=a),placeholder:"请选择规则类型"},{default:n(()=>[l(y,{label:"验证规则",value:"1"}),l(y,{label:"计算规则",value:"2"}),l(y,{label:"条件规则",value:"3"}),l(y,{label:"跳转规则",value:"4"})]),_:1},8,["modelValue"])]),_:1}),l(c,{label:"优先级",prop:"priority"},{default:n(()=>[l(H,{modelValue:i.priority,"onUpdate:modelValue":e[16]||(e[16]=a=>i.priority=a),min:1,max:10,step:1,placeholder:"请输入优先级"},null,8,["modelValue"])]),_:1}),l(c,{label:"描述",prop:"description"},{default:n(()=>[l(s,{modelValue:i.description,"onUpdate:modelValue":e[17]||(e[17]=a=>i.description=a),type:"textarea",placeholder:"请输入规则描述",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Vl=Re(pl,[["__scopeId","data-v-d9bc43d2"]]);export{Vl as default};
