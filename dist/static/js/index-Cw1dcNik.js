import{_ as ze,f as $,r as _,C as B,o as Ue,h as u,G as Ae,d as S,e as I,j as f,H as q,i as a,k as o,q as p,t as K,I as j,p as Q,K as E,L as O,l as D,m as Be,n as De,at as Te,V as g,E as G}from"./index-CwdKQqOf.js";import{b as Fe,l as Le,d as H,u as qe,c as Ee}from"./series-CECqxvZD.js";import{l as Oe}from"./catalog-CV4btQTA.js";const Pe={class:"series-management"},Re={class:"header-wrapper"},Me={class:"action-bar"},$e={class:"primary-actions"},Ke={class:"search-section"},je={class:"table-container"},Qe={class:"pagination-container"},Ge={key:0,class:"el-form-item__help",style:{color:"#909399"}},He={class:"dialog-footer"},Je={class:"el-upload__tip text-center"},We={class:"el-upload__tip"},Xe={class:"dialog-footer"},Ye={__name:"index",setup(Ze){const{proxy:J}=$(),N=_(!0),k=_(!0),T=_(0),P=_([]),V=_([]),w=_([]),W=_([]),z=_([]),F=_(""),C=_(!1),x=_(),i=B({open:!1,title:"导入系列",url:"/prod-api/cpq/series/import",headers:{Authorization:"Bearer "+localStorage.getItem("token")},isUploading:!1,isUpdateSupport:0,updateSupport:0,fileList:[],successMsg:""}),U=_(),X=()=>{J.download("cpq/series/importTemplate",{},`series_import_template_${new Date().getTime()}.xlsx`)},s=B({seriesId:null,seriesCode:"",seriesName:"",brandId:null,catalogId:null,status:"0",sortOrder:0}),d=B({pageNum:1,pageSize:10,seriesCode:"",seriesName:"",brandId:"",catalogId:"",status:""}),Y=B({seriesName:[{required:!0,message:"系列名称不能为空",trigger:"blur"},{min:2,max:128,message:"系列名称长度在 2 到 128 个字符",trigger:"blur"}],brandId:[{required:!0,message:"请选择所属品牌",trigger:"change"}],catalogId:[{required:!0,message:"请选择归属产品目录",trigger:"change"}],status:[{required:!0,message:"系列状态不能为空",trigger:"change"}]}),h=async()=>{N.value=!0;try{const l=await Le(d);P.value=l.rows,T.value=l.total,N.value=!1}catch{N.value=!1,g.error("获取系列列表失败")}},L=async()=>{try{const l=await Oe();console.log("listCatalog API返回数据:",l);let e=[];l&&l.data&&Array.isArray(l.data)?e=l.data:l&&l.rows?e=l.rows:Array.isArray(l)?e=l:l&&l.data&&typeof l.data=="object"?e=l.data.rows||[]:e=l||[],console.log("处理后的目录数据:",e);const r=Z(e);console.log("转换后的树形结构:",r),w.value=r,console.log("最终目录树数据:",w.value)}catch(l){console.error("获取目录树失败:",l),w.value=[],g.error("获取目录树失败: "+(l.message||"未知错误"))}},Z=l=>{const e=[],r={},v=Array.isArray(l)?l:[];v.forEach(n=>{const c=String(n.catalogId||n.id||n.CatalogId),b=String(n.parentId||n.parent_id||n.ParentId||0),y=n.catalogName||n.name||n.CatalogName||"未命名目录";r[c]={...n,catalogId:c,parentId:b,catalogName:y,children:[]}}),v.forEach(n=>{const c=String(n.catalogId||n.id||n.CatalogId),b=String(n.parentId||n.parent_id||n.ParentId||0);r[c]&&(b==="0"||!b?e.push(r[c]):r[b]?r[b].children.push(r[c]):e.push(r[c]))});const m=n=>{n.children&&n.children.length>0&&(n.children.sort((c,b)=>(c.catalogSort||c.sortOrder||0)-(b.catalogSort||b.sortOrder||0)),n.children.forEach(c=>m(c)))};return e.forEach(n=>m(n)),e},ee=async()=>{try{const l=await Fe();console.log("listBrand API返回数据:",l);let e=[];l&&l.data&&Array.isArray(l.data)?e=l.data:l&&l.rows?e=l.rows:(Array.isArray(l),e=l),console.log("处理后的品牌数据:",e),V.value=Array.isArray(e)?e.map(r=>{const v={...r,brandId:String(r.brandId||r.id||""),brandName:r.brandName||r.name||"未命名品牌"};return console.log("转换后的品牌数据项:",v),v}):[],console.log("最终品牌列表:",V.value)}catch(l){console.error("获取品牌列表失败:",l),V.value=[],g.error("获取品牌列表失败")}},A=()=>{d.pageNum=1,h()},le=()=>{d.seriesCode="",d.seriesName="",d.brandId="",d.catalogId="",d.status="",A()},ae=()=>{k.value=!k.value},te=l=>{z.value=l},oe=async()=>{s.seriesId=null,s.seriesCode="",s.seriesName="",s.brandId=null,s.catalogId=null,s.status="0",s.sortOrder=0,F.value="新增系列",w.value.length===0&&(console.log("目录数据为空，重新加载目录数据..."),await L()),C.value=!0},se=async l=>{console.log("=== 开始处理修改系列 ==="),console.log("传入的row数据:",l),s.seriesId=l.seriesId,s.seriesCode=l.seriesCode,s.seriesName=l.seriesName,console.log("原始row.brandId:",l.brandId,"类型:",typeof l.brandId),s.brandId=String(l.brandId||""),console.log("设置form.brandId:",s.brandId,"类型:",typeof s.brandId),console.log("原始row.catalogId:",l.catalogId,"类型:",typeof l.catalogId),s.catalogId=String(l.catalogId||""),console.log("设置form.catalogId:",s.catalogId,"类型:",typeof s.catalogId),s.status=l.status,s.sortOrder=l.sortOrder,console.log("当前brandList:",V.value),console.log("当前treeSelectData:",w.value);const e=V.value.find(r=>r.brandId===s.brandId);console.log("找到的品牌:",e),w.value.length===0&&(console.log("目录数据为空，重新加载..."),await L(),console.log("重新加载后的treeSelectData:",w.value)),console.log("打开弹窗前的form数据:",s),F.value="修改系列",C.value=!0,console.log("=== 处理修改系列结束 ===")},re=async l=>{await G.confirm("确定要删除该系列吗？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});try{await H(l.seriesId),g.success("删除成功"),h()}catch{g.error("删除失败")}},ne=async()=>{if(z.value.length===0){g.warning("请选择要删除的系列");return}await G.confirm("确定要删除选中的系列吗？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});try{const l=z.value.map(e=>e.seriesId).join(",");await H(l),g.success("删除成功"),h()}catch{g.error("删除失败")}},de=()=>{const{proxy:l}=$();l.download("cpq/series/export",{...d},`series_${new Date().getTime()}.xlsx`)},ie=()=>{i.title="导入系列",i.open=!0},ue=()=>{U.value&&U.value.uploadFiles.length>0?U.value.submit():g.warning("请选择要上传的文件")},pe=(l,e,r)=>{i.isUploading=!0},ce=(l,e,r)=>{i.isUploading=!1,l.code===200?(i.successMsg=l.msg,g.success(l.msg),i.open=!1,h()):g.error(l.msg)},me=(l,e)=>{i.updateSupport=e.length>0},ge=(l,e)=>{i.updateSupport=e.length>0},fe=async()=>{x.value&&await x.value.validate().then(async()=>{try{s.seriesId?(await qe(s),g.success("修改成功")):(await Ee(s),g.success("新增成功")),C.value=!1,h()}catch(l){g.error("操作失败: "+(l.message||"未知错误"))}}).catch(()=>{g.error("表单验证失败，请检查填写内容")})},_e=()=>{C.value=!1,x.value&&x.value.resetFields()};return _({form:null}),Ue(async()=>{console.log("组件挂载，开始加载初始数据..."),await ee(),await L(),h(),console.log("初始数据加载完成")}),(l,e)=>{const r=u("el-button"),v=u("el-input"),m=u("el-form-item"),n=u("el-option"),c=u("el-select"),b=u("el-form"),y=u("el-table-column"),be=u("el-tag"),ve=u("el-table"),ye=u("pagination"),Ie=u("el-tree-select"),R=u("el-radio"),we=u("el-radio-group"),Ve=u("el-input-number"),M=u("el-dialog"),he=u("el-icon"),Ce=u("el-checkbox"),xe=u("el-link"),Se=u("el-upload"),Ne=Ae("loading");return I(),S("div",Pe,[f("div",Re,[e[21]||(e[21]=f("h2",{class:"page-title"},"系列管理",-1)),f("div",Me,[f("div",$e,[a(r,{type:"primary",size:"default",icon:"Plus",onClick:oe},{default:o(()=>e[17]||(e[17]=[p(" 新增系列 ")])),_:1,__:[17]}),a(r,{type:"danger",size:"default",icon:"Delete",disabled:z.value.length===0,onClick:ne},{default:o(()=>e[18]||(e[18]=[p(" 批量删除 ")])),_:1,__:[18]},8,["disabled"]),a(r,{type:"warning",size:"default",icon:"Download",onClick:de},{default:o(()=>e[19]||(e[19]=[p(" 导出 ")])),_:1,__:[19]}),a(r,{type:"success",size:"default",icon:"Upload",onClick:ie},{default:o(()=>e[20]||(e[20]=[p(" 导入 ")])),_:1,__:[20]}),a(r,{type:"info",size:"default",icon:"Search",onClick:ae},{default:o(()=>[p(K(k.value?"收起":"展开")+"搜索 ",1)]),_:1})])])]),q(f("div",Ke,[a(b,{model:d,ref:"queryForm",inline:!0,"label-width":"80px",class:"search-form"},{default:o(()=>[a(m,{label:"系列编码",prop:"seriesCode"},{default:o(()=>[a(v,{modelValue:d.seriesCode,"onUpdate:modelValue":e[0]||(e[0]=t=>d.seriesCode=t),placeholder:"请输入系列编码",clearable:"",size:"small",onKeyup:Q(A,["enter"])},null,8,["modelValue"])]),_:1}),a(m,{label:"系列名称",prop:"seriesName"},{default:o(()=>[a(v,{modelValue:d.seriesName,"onUpdate:modelValue":e[1]||(e[1]=t=>d.seriesName=t),placeholder:"请输入系列名称",clearable:"",size:"small",onKeyup:Q(A,["enter"])},null,8,["modelValue"])]),_:1}),a(m,{label:"所属品牌",prop:"brandId"},{default:o(()=>[a(c,{modelValue:d.brandId,"onUpdate:modelValue":e[2]||(e[2]=t=>d.brandId=t),placeholder:"请选择所属品牌",clearable:"",size:"small"},{default:o(()=>[(I(!0),S(E,null,O(V.value,t=>(I(),D(n,{key:t.brandId,label:t.brandName,value:t.brandId},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(m,{label:"归属产品目录",prop:"catalogId"},{default:o(()=>[a(c,{modelValue:d.catalogId,"onUpdate:modelValue":e[3]||(e[3]=t=>d.catalogId=t),placeholder:"请选择归属产品目录",clearable:"",size:"small"},{default:o(()=>[(I(!0),S(E,null,O(W.value,t=>(I(),D(n,{key:t.catalogId,label:"─".repeat(t.level)+t.catalogName,value:t.catalogId},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(m,{label:"系列状态",prop:"status"},{default:o(()=>[a(c,{modelValue:d.status,"onUpdate:modelValue":e[4]||(e[4]=t=>d.status=t),placeholder:"请选择系列状态",clearable:"",size:"small"},{default:o(()=>[a(n,{label:"启用",value:"0"}),a(n,{label:"禁用",value:"1"})]),_:1},8,["modelValue"])]),_:1}),a(m,{class:"search-buttons"},{default:o(()=>[a(r,{type:"primary",icon:"Search",size:"small",onClick:A},{default:o(()=>e[22]||(e[22]=[p("搜索")])),_:1,__:[22]}),a(r,{icon:"RefreshRight",size:"small",onClick:le},{default:o(()=>e[23]||(e[23]=[p("重置")])),_:1,__:[23]})]),_:1})]),_:1},8,["model"])],512),[[j,k.value]]),f("div",je,[q((I(),D(ve,{data:P.value,onSelectionChange:te,border:"",style:{width:"100%"}},{default:o(()=>[a(y,{type:"selection",width:"50",align:"center"}),a(y,{label:"系列编码",align:"center",prop:"seriesCode","min-width":"110"}),a(y,{label:"系列名称",align:"center",prop:"seriesName","min-width":"140","show-overflow-tooltip":!0}),a(y,{label:"所属品牌",align:"center",prop:"brandName","min-width":"110"}),a(y,{label:"系列状态",align:"center",prop:"status",width:"90"},{default:o(t=>[a(be,{type:t.row.status==="0"?"success":"danger",size:"small"},{default:o(()=>[p(K(t.row.status==="0"?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),a(y,{label:"排序",align:"center",prop:"sortOrder",width:"70"}),a(y,{label:"创建时间",align:"center",prop:"createTime","min-width":"150"}),a(y,{label:"操作",align:"center","class-name":"small-padding fixed-width","min-width":"150"},{default:o(t=>[a(r,{size:"small",type:"primary",icon:"Edit",onClick:ke=>se(t.row),style:{"margin-right":"5px"}},{default:o(()=>e[24]||(e[24]=[p(" 修改 ")])),_:2,__:[24]},1032,["onClick"]),a(r,{size:"small",type:"danger",icon:"Delete",onClick:ke=>re(t.row)},{default:o(()=>e[25]||(e[25]=[p(" 删除 ")])),_:2,__:[25]},1032,["onClick"])]),_:1})]),_:1},8,["data"])),[[Ne,N.value]]),f("div",Qe,[q(a(ye,{total:T.value,page:d.pageNum,"onUpdate:page":e[5]||(e[5]=t=>d.pageNum=t),limit:d.pageSize,"onUpdate:limit":e[6]||(e[6]=t=>d.pageSize=t),onPagination:h},null,8,["total","page","limit"]),[[j,T.value>0]])])]),a(M,{title:F.value,modelValue:C.value,"onUpdate:modelValue":e[13]||(e[13]=t=>C.value=t),width:"600px","append-to-body":"",class:"dialog-wrapper"},{footer:o(()=>[f("span",He,[a(r,{size:"default",onClick:_e},{default:o(()=>e[28]||(e[28]=[p("取消")])),_:1,__:[28]}),a(r,{size:"default",type:"primary",onClick:fe},{default:o(()=>e[29]||(e[29]=[p("确定")])),_:1,__:[29]})])]),default:o(()=>[a(b,{ref_key:"formRef",ref:x,model:s,rules:Y,"label-width":"100px",class:"dialog-form"},{default:o(()=>[a(m,{label:"系列编码",prop:"seriesCode"},{default:o(()=>[a(v,{modelValue:s.seriesCode,"onUpdate:modelValue":e[7]||(e[7]=t=>s.seriesCode=t),placeholder:"由系统自动生成",readonly:!s.seriesId,disabled:!s.seriesId,size:"default"},null,8,["modelValue","readonly","disabled"]),s.seriesId?Be("",!0):(I(),S("div",Ge," 系列编码由系统自动生成，无需手动输入 "))]),_:1}),a(m,{label:"系列名称",prop:"seriesName"},{default:o(()=>[a(v,{modelValue:s.seriesName,"onUpdate:modelValue":e[8]||(e[8]=t=>s.seriesName=t),placeholder:"请输入系列名称",size:"default"},null,8,["modelValue"])]),_:1}),a(m,{label:"品牌",prop:"brandId"},{default:o(()=>[a(c,{modelValue:s.brandId,"onUpdate:modelValue":e[9]||(e[9]=t=>s.brandId=t),placeholder:"请选择品牌",size:"default"},{default:o(()=>[(I(!0),S(E,null,O(V.value,t=>(I(),D(n,{key:t.brandId,label:t.brandName,value:t.brandId},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(m,{label:"归属产品目录",prop:"catalogId"},{default:o(()=>[a(Ie,{modelValue:s.catalogId,"onUpdate:modelValue":e[10]||(e[10]=t=>s.catalogId=t),data:w.value,props:{value:"catalogId",label:"catalogName",children:"children"},placeholder:"请选择归属产品目录",clearable:"",style:{width:"100%"},size:"default"},null,8,["modelValue","data"])]),_:1}),a(m,{label:"系列状态",prop:"status"},{default:o(()=>[a(we,{modelValue:s.status,"onUpdate:modelValue":e[11]||(e[11]=t=>s.status=t)},{default:o(()=>[a(R,{label:"0"},{default:o(()=>e[26]||(e[26]=[p("启用")])),_:1,__:[26]}),a(R,{label:"1"},{default:o(()=>e[27]||(e[27]=[p("禁用")])),_:1,__:[27]})]),_:1},8,["modelValue"])]),_:1}),a(m,{label:"排序",prop:"sortOrder"},{default:o(()=>[a(Ve,{modelValue:s.sortOrder,"onUpdate:modelValue":e[12]||(e[12]=t=>s.sortOrder=t),min:0,placeholder:"请输入排序值",size:"default"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue"]),a(M,{title:i.title,modelValue:i.open,"onUpdate:modelValue":e[16]||(e[16]=t=>i.open=t),width:"400px","append-to-body":""},{footer:o(()=>[f("div",Xe,[a(r,{type:"primary",loading:i.isUploading,onClick:ue},{default:o(()=>e[34]||(e[34]=[p("确 定")])),_:1,__:[34]},8,["loading"]),a(r,{onClick:e[15]||(e[15]=t=>i.open=!1)},{default:o(()=>e[35]||(e[35]=[p("取 消")])),_:1,__:[35]})])]),default:o(()=>[a(Se,{ref_key:"uploadRef",ref:U,limit:1,accept:".xlsx, .xls",headers:i.headers,action:i.url+"?updateSupport="+i.updateSupport,disabled:i.isUploading,"on-progress":pe,"on-success":ce,"on-change":me,"on-remove":ge,"auto-upload":!1,drag:""},{tip:o(()=>[f("div",Je,[f("div",We,[a(Ce,{modelValue:i.updateSupport,"onUpdate:modelValue":e[14]||(e[14]=t=>i.updateSupport=t)},null,8,["modelValue"]),e[30]||(e[30]=p("是否更新已经存在的系列数据 "))]),e[32]||(e[32]=f("span",null,"仅允许导入xls、xlsx格式文件。",-1)),a(xe,{type:"primary",underline:!1,style:{"font-size":"12px","vertical-align":"baseline"},onClick:X},{default:o(()=>e[31]||(e[31]=[p("下载模板")])),_:1,__:[31]})])]),default:o(()=>[a(he,{class:"el-icon--upload"},{default:o(()=>[a(De(Te))]),_:1}),e[33]||(e[33]=f("div",{class:"el-upload__text"},[p("将文件拖到此处，或"),f("em",null,"点击上传")],-1))]),_:1,__:[33]},8,["headers","action","disabled"])]),_:1},8,["title","modelValue"])])}}},tl=ze(Ye,[["__scopeId","data-v-86295fde"]]);export{tl as default};
