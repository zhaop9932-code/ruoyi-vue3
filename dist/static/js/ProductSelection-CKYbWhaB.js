import{_ as xe,r as m,g as F,H as Re,a as n,i as ze,c as p,o as d,m as I,e as s,b as o,w as a,k as U,f as h,F as j,n as D,a4 as Pe,af as Se,l as N,L as Ae,j as W,t as _,b8 as Be,b9 as Ue,a3 as X,ba as je,x as Y,D as Z,E as ee}from"./index-DgigFOm-.js";import{g as De}from"./superBomProductRelation-c5nmns4w.js";import{c as Le}from"./bom-CjuVRwkz.js";const Ee={class:"product-selection"},Fe={key:1,class:"selection-container"},$e={class:"filter-section"},Oe={class:"card-header"},Te={key:0,class:"dynamic-filters"},qe={class:"products-section"},He={class:"section-header"},Ge={class:"header-left"},Je={class:"header-right"},Ke={key:0,class:"products-grid"},Qe=["onClick"],We={class:"product-image"},Xe={class:"image-slot"},Ye={class:"product-info"},Ze=["title"],et={class:"product-model"},tt={class:"product-attrs"},lt={class:"product-footer"},ot={class:"price"},at={class:"price-value"},rt={key:1,class:"products-list"},nt={class:"price-text"},st={key:2,class:"pagination"},ct={__name:"ProductSelection",props:{currentNode:{type:Object,default:null},bomId:{type:[String,Number],required:!0},currentFilters:{type:Object,default:()=>({})}},emits:["product-select"],setup($,{emit:te}){const v=$,le=te,R=m(!1),z=m([]),P=m([]),f=m(null),L=m("grid"),E=m("recommend"),c=m({productName:"",productModel:"",priceRange:[0,1e4],dynamicAttrs:{}}),g=m(1),V=m(12),O=F(()=>z.value.length===0?1e4:Math.ceil(Math.max(...z.value.map(e=>e.price||0))/1e3)*1e3),M=F(()=>{let e=[...z.value];if(c.value.productName){const t=c.value.productName.toLowerCase();e=e.filter(r=>r.productName.toLowerCase().includes(t))}if(c.value.productModel){const t=c.value.productModel.toLowerCase();e=e.filter(r=>{var u;return(u=r.productModel)==null?void 0:u.toLowerCase().includes(t)})}return e=e.filter(t=>t.price>=c.value.priceRange[0]&&t.price<=c.value.priceRange[1]),Object.keys(c.value.dynamicAttrs).forEach(t=>{const r=c.value.dynamicAttrs[t];r&&(e=e.filter(u=>{var y;return((y=u.attributes)==null?void 0:y[t])===r}))}),e=oe(e),e}),T=F(()=>{const e=(g.value-1)*V.value,t=e+V.value;return M.value.slice(e,t)}),oe=e=>{switch(E.value){case"price_asc":return e.sort((r,u)=>r.price-u.price);case"price_desc":return e.sort((r,u)=>u.price-r.price);case"match_desc":return e.sort((r,u)=>u.matchRate-r.matchRate);case"recommend":default:const t=Math.max(...e.map(r=>r.price));return e.sort((r,u)=>{const b=r.matchRate*.7+(1-r.price/t)*30;return u.matchRate*.7+(1-u.price/t)*30-b})}},ae=e=>({select:"el-select",radio:"el-select",number:"el-input-number",text:"el-input"})[e]||"el-input",re=e=>({placeholder:`请选择${e.attributeName}`,clearable:!0,size:"small"}),ne=e=>`¥${e}`,se=e=>e>=80?"high":e>=60?"medium":"low",ce=e=>e>=80?"#67c23a":e>=60?"#e6a23c":"#f56c6c",ue=e=>{const t=e.attributes||{},r=Object.entries(t).slice(0,3);return Object.fromEntries(r)},de=async()=>{if(v.currentNode){R.value=!0;try{const e=await De({bomId:v.bomId,structureId:v.currentNode.bomStructureId});z.value=(e.data||[]).map(t=>({...t,matchRate:pe(t)}))}catch(e){console.error("加载产品列表失败:",e),ee.error("加载产品列表失败")}finally{R.value=!1}}},ie=async()=>{if(!(!v.currentNode||!v.bomId))try{const e=await Le(v.bomId,v.currentNode.bomStructureId);P.value=e.data||[],P.value.forEach(t=>{c.value.dynamicAttrs[t.attributeCode]=null})}catch(e){console.error("加载动态属性失败:",e)}},pe=e=>Math.floor(Math.random()*40)+60,S=()=>{g.value=1},me=()=>{c.value={productName:"",productModel:"",priceRange:[0,O.value],dynamicAttrs:{}},g.value=1},_e=()=>{g.value=1},q=e=>{f.value=e},H=e=>{f.value=e,le("product-select",e),ee.success("产品选择成功")},ve=()=>{g.value=1},fe=()=>{var e;(e=document.querySelector(".products-section"))==null||e.scrollTo({top:0,behavior:"smooth"})};return Re(()=>v.currentNode,async e=>{e&&(f.value=null,g.value=1,await Promise.all([de(),ie()]))},{immediate:!0}),(e,t)=>{const r=n("el-empty"),u=n("el-icon"),b=n("el-button"),y=n("el-input"),A=n("el-form-item"),B=n("el-col"),ge=n("el-slider"),G=n("el-row"),he=n("el-divider"),x=n("el-option"),be=n("el-form"),ye=n("el-card"),J=n("el-tag"),K=n("el-radio-button"),Ce=n("el-radio-group"),we=n("el-select"),ke=n("el-image"),C=n("el-table-column"),Ie=n("el-progress"),Ne=n("el-table"),Ve=n("el-pagination"),Q=ze("loading");return d(),p("div",Ee,[$.currentNode?(d(),p("div",Fe,[s("div",$e,[o(ye,{shadow:"never",class:"filter-card"},{header:a(()=>[s("div",Oe,[t[8]||(t[8]=s("span",null,"筛选条件",-1)),o(b,{text:"",type:"primary",onClick:me},{default:a(()=>[o(u,null,{default:a(()=>[o(N(Ae))]),_:1}),t[7]||(t[7]=h(" 重置 "))]),_:1,__:[7]})])]),default:a(()=>[o(be,{model:c.value,"label-width":"80px",size:"small"},{default:a(()=>[o(G,{gutter:16},{default:a(()=>[o(B,{span:8},{default:a(()=>[o(A,{label:"产品名称"},{default:a(()=>[o(y,{modelValue:c.value.productName,"onUpdate:modelValue":t[0]||(t[0]=l=>c.value.productName=l),placeholder:"请输入产品名称",clearable:"",onInput:S},null,8,["modelValue"])]),_:1})]),_:1}),o(B,{span:8},{default:a(()=>[o(A,{label:"产品型号"},{default:a(()=>[o(y,{modelValue:c.value.productModel,"onUpdate:modelValue":t[1]||(t[1]=l=>c.value.productModel=l),placeholder:"请输入产品型号",clearable:"",onInput:S},null,8,["modelValue"])]),_:1})]),_:1}),o(B,{span:8},{default:a(()=>[o(A,{label:"价格范围"},{default:a(()=>[o(ge,{modelValue:c.value.priceRange,"onUpdate:modelValue":t[2]||(t[2]=l=>c.value.priceRange=l),range:"",min:0,max:O.value,"format-tooltip":ne,onChange:S},null,8,["modelValue","max"])]),_:1})]),_:1})]),_:1}),P.value.length>0?(d(),p("div",Te,[o(he,{"content-position":"left"},{default:a(()=>t[9]||(t[9]=[h("动态属性筛选")])),_:1,__:[9]}),o(G,{gutter:16},{default:a(()=>[(d(!0),p(j,null,D(P.value,l=>(d(),I(B,{key:l.attributeId,span:8},{default:a(()=>[o(A,{label:l.attributeName},{default:a(()=>[(d(),I(Pe(ae(l.attributeType)),Se({modelValue:c.value.dynamicAttrs[l.attributeCode],"onUpdate:modelValue":i=>c.value.dynamicAttrs[l.attributeCode]=i},{ref_for:!0},re(l),{onChange:S}),{default:a(()=>[["select","radio"].includes(l.attributeType)?(d(!0),p(j,{key:0},D(l.attributeValues,i=>(d(),I(x,{key:i.valueId,label:i.valueName,value:i.valueCode},null,8,["label","value"]))),128)):U("",!0)]),_:2},1040,["modelValue","onUpdate:modelValue"]))]),_:2},1032,["label"])]),_:2},1024))),128))]),_:1})])):U("",!0)]),_:1},8,["model"])]),_:1})]),s("div",qe,[s("div",He,[s("div",Ge,[t[10]||(t[10]=s("h3",null,"产品列表",-1)),o(J,{type:"info",size:"small"},{default:a(()=>[h("共 "+_(M.value.length)+" 个产品",1)]),_:1})]),s("div",Je,[o(Ce,{modelValue:L.value,"onUpdate:modelValue":t[3]||(t[3]=l=>L.value=l),size:"small"},{default:a(()=>[o(K,{value:"grid"},{default:a(()=>[o(u,null,{default:a(()=>[o(N(Be))]),_:1}),t[11]||(t[11]=h(" 网格 "))]),_:1,__:[11]}),o(K,{value:"list"},{default:a(()=>[o(u,null,{default:a(()=>[o(N(Ue))]),_:1}),t[12]||(t[12]=h(" 列表 "))]),_:1,__:[12]})]),_:1},8,["modelValue"]),o(we,{modelValue:E.value,"onUpdate:modelValue":t[4]||(t[4]=l=>E.value=l),size:"small",style:{width:"150px"},onChange:_e},{default:a(()=>[o(x,{label:"推荐排序",value:"recommend"}),o(x,{label:"价格从低到高",value:"price_asc"}),o(x,{label:"价格从高到低",value:"price_desc"}),o(x,{label:"匹配度从高到低",value:"match_desc"})]),_:1},8,["modelValue"])])]),L.value==="grid"?W((d(),p("div",Ke,[(d(!0),p(j,null,D(T.value,l=>{var i,w;return d(),p("div",{key:l.productId,class:X(["product-card",{selected:((i=f.value)==null?void 0:i.productId)===l.productId}]),onClick:k=>q(l)},[s("div",We,[o(ke,{src:l.productImage||"/default-product.png",fit:"cover",lazy:""},{error:a(()=>[s("div",Xe,[o(u,null,{default:a(()=>[o(N(je))]),_:1})])]),_:2},1032,["src"]),s("div",{class:X(["match-badge",`match-${se(l.matchRate)}`])}," 匹配度 "+_(l.matchRate)+"% ",3)]),s("div",Ye,[s("h4",{class:"product-name",title:l.productName},_(l.productName),9,Ze),s("p",et,"型号: "+_(l.productModel),1),s("div",tt,[(d(!0),p(j,null,D(ue(l),(k,Me)=>(d(),I(J,{key:Me,size:"small",type:"info",effect:"plain"},{default:a(()=>[h(_(k),1)]),_:2},1024))),128))]),s("div",lt,[s("div",ot,[t[13]||(t[13]=s("span",{class:"price-label"},"¥",-1)),s("span",at,_(l.price),1)]),o(b,{type:"primary",size:"small",icon:((w=f.value)==null?void 0:w.productId)===l.productId?N(Z):null,onClick:Y(k=>H(l),["stop"])},{default:a(()=>{var k;return[h(_(((k=f.value)==null?void 0:k.productId)===l.productId?"已选择":"选择"),1)]}),_:2},1032,["icon","onClick"])])])],10,Qe)}),128)),M.value.length===0?(d(),I(r,{key:0,description:"暂无符合条件的产品"})):U("",!0)])),[[Q,R.value]]):W((d(),p("div",rt,[o(Ne,{data:T.value,border:"","highlight-current-row":"",onRowClick:q},{default:a(()=>[o(C,{type:"index",label:"序号",width:"60"}),o(C,{prop:"productName",label:"产品名称","min-width":"200","show-overflow-tooltip":""}),o(C,{prop:"productModel",label:"产品型号",width:"150"}),o(C,{label:"匹配度",width:"120",align:"center"},{default:a(({row:l})=>[o(Ie,{percentage:l.matchRate,color:ce(l.matchRate),"show-text":!0},null,8,["percentage","color"])]),_:1}),o(C,{prop:"price",label:"价格",width:"120",align:"right"},{default:a(({row:l})=>[s("span",nt,"¥"+_(l.price),1)]),_:1}),o(C,{label:"操作",width:"120",align:"center",fixed:"right"},{default:a(({row:l})=>{var i;return[o(b,{type:"primary",size:"small",icon:((i=f.value)==null?void 0:i.productId)===l.productId?N(Z):null,onClick:Y(w=>H(l),["stop"])},{default:a(()=>{var w;return[h(_(((w=f.value)==null?void 0:w.productId)===l.productId?"已选择":"选择"),1)]}),_:2},1032,["icon","onClick"])]}),_:1})]),_:1},8,["data"])])),[[Q,R.value]]),M.value.length>V.value?(d(),p("div",st,[o(Ve,{"current-page":g.value,"onUpdate:currentPage":t[5]||(t[5]=l=>g.value=l),"page-size":V.value,"onUpdate:pageSize":t[6]||(t[6]=l=>V.value=l),"page-sizes":[12,24,48,96],total:M.value.length,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:ve,onCurrentChange:fe},null,8,["current-page","page-size","total"])])):U("",!0)])])):(d(),I(r,{key:0,description:"请先选择要配置的节点"}))])}}},pt=xe(ct,[["__scopeId","data-v-9019ce9f"]]);export{pt as default};
