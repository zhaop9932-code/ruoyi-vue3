import{T as m,ay as b,az as S,V as u}from"./index-CwdKQqOf.js";import{k as v}from"./bom-DdrUuB8x.js";import{g as x}from"./superBomRuleRelation-Cz_bCmLL.js";import{c as N}from"./rule-nChVW3Ks.js";import{getSuperBomVariableByBomId as C}from"./superBomVariable-gMrvMuGl.js";function w(i){return m({url:`/cpq/configSession/${i}`,method:"get"})}function R(i){return m({url:"/cpq/configSession",method:"post",data:{sessionId:i.sessionId,bomId:i.bomId,sessionName:i.sessionName,sessionStatus:i.status||"draft",configurationData:JSON.stringify(i.configuration),pricingData:JSON.stringify(i.pricing),createdBy:i.createdBy,remark:i.remark}})}function T(i){return m({url:"/cpq/configSession",method:"put",data:{sessionId:i.sessionId,sessionName:i.sessionName,sessionStatus:i.status,configurationData:JSON.stringify(i.configuration),pricingData:JSON.stringify(i.pricing),remark:i.remark}})}function M(i){return m({url:`/cpq/configSession/complete/${i}`,method:"post"})}class O{constructor(){this.rules=[],this.context={},this.executionLog=[],this.validationErrors=[]}loadRules(e){this.rules=e.sort((t,s)=>(s.rulePriority||0)-(t.rulePriority||0))}setContext(e){this.context=b(e)}async evaluateAll(){this.executionLog=[],this.validationErrors=[];const e={passed:!0,executedRules:[],errors:[],actions:[]};for(const t of this.rules)if(t.ruleStatus==="0")try{const s=await this.evaluateRule(t);if(s.conditionMet){e.executedRules.push(t.ruleId);const r=await this.executeRuleActions(t);e.actions.push(...r),t.ruleType==="1"&&!s.valid&&(e.passed=!1,e.errors.push({ruleId:t.ruleId,ruleName:t.ruleName,message:s.message}))}this.executionLog.push({ruleId:t.ruleId,ruleName:t.ruleName,conditionMet:s.conditionMet,valid:s.valid,timestamp:new Date})}catch(s){console.error(`规则执行失败 [${t.ruleName}]:`,s),e.errors.push({ruleId:t.ruleId,ruleName:t.ruleName,message:s.message})}return e}async evaluateRule(e){const t=typeof e.conditionConfig=="string"?JSON.parse(e.conditionConfig):e.conditionConfig;if(!t||!t.conditions)return{conditionMet:!0,valid:!0};const s=this.evaluateConditions(t.conditions);let r=!0,n="";if(s&&e.ruleType==="1"){const o=this.validateRule(e);r=o.valid,n=o.message}return{conditionMet:s,valid:r,message:n}}evaluateConditions(e){if(!e||e.length===0)return!0;let t=null;for(let s=0;s<e.length;s++){const r=e[s],n=this.evaluateSingleCondition(r);if(s===0)t=n;else{const o=r.logic||"AND";o==="AND"?t=t&&n:o==="OR"&&(t=t||n)}}return t}evaluateSingleCondition(e){if(e.configType==="complex"&&e.children)return this.evaluateConditions(e.children);const t=this.getFieldValue(e),s=this.parseValue(e.value,e.type);return this.compareValues(t,e.operator,s,e.type)}getFieldValue(e){var n,o,a,h,l,c,d;const{judgeType:t,node:s,field:r}=e;switch(t){case"variable":return(n=this.context.variables)==null?void 0:n[r];case"nodeStaticAttr":case"nodeDynamicAttr":return(h=(a=(o=this.context.nodes)==null?void 0:o[s])==null?void 0:a.attributes)==null?void 0:h[r];case"nodeProduct":return(d=(c=(l=this.context.nodes)==null?void 0:l[s])==null?void 0:c.product)==null?void 0:d[r];default:return null}}parseValue(e,t){switch(t){case"number":return Number(e);case"boolean":return e==="true"||e===!0;case"select":case"multi":return Array.isArray(e)?e:[e];default:return e}}compareValues(e,t,s,r){if(t==="is_empty")return e==null||e==="";if(t==="is_not_empty")return e!=null&&e!=="";if(r==="number"){const n=Number(e),o=Number(s);switch(t){case"=":case"==":return n===o;case"!=":return n!==o;case">":return n>o;case">=":return n>=o;case"<":return n<o;case"<=":return n<=o;default:return!1}}if(r==="text"){const n=String(e||""),o=String(s||"");switch(t){case"=":case"==":return n===o;case"!=":return n!==o;case"contains":return n.includes(o);case"not_contains":return!n.includes(o);case"starts_with":return n.startsWith(o);case"ends_with":return n.endsWith(o);default:return!1}}if(r==="select"||r==="multi"){const n=Array.isArray(e)?e:[e],o=Array.isArray(s)?s:[s];switch(t){case"=":case"==":return JSON.stringify(n.sort())===JSON.stringify(o.sort());case"!=":return JSON.stringify(n.sort())!==JSON.stringify(o.sort());case"in":return n.some(a=>o.includes(a));case"not_in":return!n.some(a=>o.includes(a));default:return!1}}return r==="boolean"?e===s:!1}validateRule(e){const t=typeof e.actionConfig=="string"?JSON.parse(e.actionConfig):e.actionConfig;if(!t||!t.actions)return{valid:!0,message:""};const s=t.actions.find(o=>o.actionType==="validation");if(!s)return{valid:!0,message:""};const r=JSON.parse(s.actionParams||"{}"),n=this.executeValidation(r);return{valid:n,message:n?"":r.errorMessage||"验证失败"}}executeValidation(e){const{validationType:t,expression:s}=e;switch(t){case"range":return this.validateRange(e);case"regex":return this.validateRegex(e);case"custom":return this.validateCustom(s);default:return!0}}validateRange(e){const{field:t,min:s,max:r}=e,n=this.getFieldValue({judgeType:e.judgeType,node:e.node,field:t});if(n==null)return!1;const o=Number(n);return o>=s&&o<=r}validateRegex(e){const{field:t,pattern:s}=e,r=this.getFieldValue({judgeType:e.judgeType,node:e.node,field:t});return r?new RegExp(s).test(String(r)):!1}validateCustom(e){try{const t=this.buildSafeContext();return new Function(...Object.keys(t),`return ${e}`)(...Object.values(t))}catch(t){return console.error("自定义验证表达式执行失败:",t),!1}}buildSafeContext(){return{variables:this.context.variables||{},nodes:this.context.nodes||{},Math,String,Number,Array,Object}}async executeRuleActions(e){const t=typeof e.actionConfig=="string"?JSON.parse(e.actionConfig):e.actionConfig;if(!t||!t.actions)return[];const s=[],r=t.actions.sort((n,o)=>(n.actionPriority||0)-(o.actionPriority||0));for(const n of r)try{const o=await this.executeAction(n);s.push({actionId:n.actionId,actionType:n.actionType,success:!0,result:o})}catch(o){console.error(`动作执行失败 [${n.actionType}]:`,o),s.push({actionId:n.actionId,actionType:n.actionType,success:!1,error:o.message})}return s}async executeAction(e){const t=JSON.parse(e.actionParams||"{}");switch(e.actionType){case"setProperty":return this.actionSetProperty(t);case"showMessage":return this.actionShowMessage(t);case"hideNode":return this.actionHideNode(t);case"disableNode":return this.actionDisableNode(t);case"calculatePrice":return this.actionCalculatePrice(t);case"autoSelect":return this.actionAutoSelect(t);default:return console.warn(`未知的动作类型: ${e.actionType}`),null}}actionSetProperty(e){const{targetType:t,targetId:s,property:r,value:n}=e;return t==="node"?(this.context.nodes[s]||(this.context.nodes[s]={}),this.context.nodes[s].attributes||(this.context.nodes[s].attributes={}),this.context.nodes[s].attributes[r]=n):t==="variable"&&(this.context.variables||(this.context.variables={}),this.context.variables[r]=n),{property:r,value:n}}actionShowMessage(e){const{messageType:t,message:s}=e;return{messageType:t,message:s}}actionHideNode(e){const{nodeId:t}=e;return this.context.nodes[t]&&(this.context.nodes[t].isVisible=!1),{nodeId:t,hidden:!0}}actionDisableNode(e){const{nodeId:t}=e;return this.context.nodes[t]&&(this.context.nodes[t].isDisabled=!0),{nodeId:t,disabled:!0}}actionCalculatePrice(e){const{expression:t}=e;try{const s=this.buildSafeContext(),n=new Function(...Object.keys(s),`return ${t}`)(...Object.values(s));return this.context.pricing||(this.context.pricing={}),this.context.pricing.calculatedPrice=n,{price:n}}catch(s){return console.error("价格计算失败:",s),{price:0,error:s.message}}}actionAutoSelect(e){const{nodeId:t,productId:s,attributeValues:r}=e;return this.context.nodes[t]&&(s&&(this.context.nodes[t].selectedProductId=s),r&&Object.assign(this.context.nodes[t].attributes||{},r)),{nodeId:t,productId:s,attributeValues:r}}checkNodeConstraints(e,t){const s=this.context.nodes[e];if(!s||!t.constraintConfig)return{valid:!0,errors:[]};const r=typeof t.constraintConfig=="string"?JSON.parse(t.constraintConfig):t.constraintConfig,n=[];if(r.type==="condition"&&r.condition&&(this.validateCustom(r.condition)||n.push({type:"condition",message:`节点不满足条件约束: ${r.condition}`})),r.quantity){const o=s.quantity||0,{min:a,max:h,minExpr:l,maxExpr:c}=r.quantity;let d=a,p=h;if(l)try{const g=this.buildSafeContext();d=new Function(...Object.keys(g),`return ${l}`)(...Object.values(g))}catch(g){console.error("最小数量表达式计算失败:",g)}if(c)try{const g=this.buildSafeContext();p=new Function(...Object.keys(g),`return ${c}`)(...Object.values(g))}catch(g){console.error("最大数量表达式计算失败:",g)}o<d&&n.push({type:"quantity",message:`数量不能小于 ${d}`}),p&&o>p&&n.push({type:"quantity",message:`数量不能大于 ${p}`})}if(r.dependency){const{nodes:o,type:a,condition:h}=r.dependency;if(a==="mandatory")for(const l of o){const c=this.context.nodes[l];(!c||c.status!=="configured")&&n.push({type:"dependency",message:`必须先配置依赖节点: ${l}`})}else if(a==="exclusive"){const l=o.filter(c=>{const d=this.context.nodes[c];return d&&d.status==="configured"});l.length>1&&n.push({type:"dependency",message:`节点 ${l.join(", ")} 不能同时配置`})}else if(a==="conditional"&&h&&this.validateCustom(h))for(const c of o){const d=this.context.nodes[c];(!d||d.status!=="configured")&&n.push({type:"dependency",message:`在当前条件下，必须配置依赖节点: ${c}`})}}return{valid:n.length===0,errors:n}}getExecutionLog(){return this.executionLog}getContext(){return this.context}reset(){this.rules=[],this.context={},this.executionLog=[],this.validationErrors=[]}}const f=new O,q=S("configurator",{state:()=>({currentBomId:null,bomTreeData:[],nodesMap:new Map,configSession:{sessionId:null,bomId:null,sessionName:"",createdAt:null,updatedAt:null,status:"draft",configuration:{}},rules:[],variables:{},validationErrors:{},pricing:{totalPrice:0,breakdown:[]},loading:{bom:!1,rules:!1,validation:!1}}),getters:{configuredNodes:i=>Array.from(i.nodesMap.values()).filter(e=>e.status==="configured"),unconfiguredRequiredNodes:i=>Array.from(i.nodesMap.values()).filter(e=>e.isRequired&&e.status!=="configured"),isConfigurationComplete:i=>Array.from(i.nodesMap.values()).every(e=>!e.isRequired||e.status==="configured"),configurationSummary:i=>{const e={totalNodes:i.nodesMap.size,configuredNodes:0,requiredNodes:0,optionalNodes:0,errors:0};return i.nodesMap.forEach(t=>{t.status==="configured"&&e.configuredNodes++,t.isRequired?e.requiredNodes++:e.optionalNodes++,t.status==="error"&&e.errors++}),e}},actions:{async loadBomStructure(i){this.loading.bom=!0,this.currentBomId=i;try{const e=await v(i);return this.bomTreeData=e.data||[],this.buildNodesMap(this.bomTreeData),await this.loadBomVariables(i),await this.loadBomRules(i),this.initConfigSession(i),!0}catch(e){return console.error("加载BOM结构失败:",e),u.error("加载BOM结构失败"),!1}finally{this.loading.bom=!1}},buildNodesMap(i){i.forEach(e=>{if(e.status="unconfigured",e.isVisible=!0,e.isDisabled=!1,e.quantity=e.defaultQuantity||1,e.constraintConfig&&typeof e.constraintConfig=="string")try{e.constraintConfig=JSON.parse(e.constraintConfig)}catch(t){console.error("解析约束配置失败:",t)}e.isRequired=e.constraintType===""||e.constraintConfig&&e.constraintConfig.required===!0,this.nodesMap.set(e.bomStructureId,e),e.children&&e.children.length>0&&this.buildNodesMap(e.children)})},async loadBomVariables(i){try{const t=(await C(i)).data||[];this.variables={},t.forEach(s=>{this.variables[s.variableCode]=s.defaultValue})}catch(e){console.error("加载BOM变量失败:",e)}},async loadBomRules(i){this.loading.rules=!0;try{const s=((await x(i)).data||[]).filter(n=>n.status===0).map(n=>N(n.ruleId)),r=await Promise.all(s);this.rules=r.map(n=>n.data),f.loadRules(this.rules)}catch(e){console.error("加载BOM规则失败:",e)}finally{this.loading.rules=!1}},initConfigSession(i){this.configSession={sessionId:`SESSION_${Date.now()}`,bomId:i,sessionName:`配置会话_${new Date().toLocaleString()}`,createdAt:new Date,updatedAt:new Date,status:"draft",configuration:{},savedToBackend:!1}},async saveNodeConfiguration(i,e){const t=this.nodesMap.get(i);if(!t)throw new Error(`节点不存在: ${i}`);t.status="configured",t.configuration=e,this.configSession.configuration[i]=e,this.configSession.updatedAt=new Date,await this.runRuleEngine(),await this.calculateTotalPrice()},async updateNodeQuantity(i,e){const t=this.nodesMap.get(i);t&&(t.quantity=e,this.configSession.configuration[i]&&(this.configSession.configuration[i].quantity=e),await this.runRuleEngine(),await this.calculateTotalPrice())},async selectNodeProduct(i,e){const t=this.nodesMap.get(i);t&&(t.selectedProductId=e,this.configSession.configuration[i]||(this.configSession.configuration[i]={}),this.configSession.configuration[i].selectedProductId=e,await this.runRuleEngine(),await this.calculateTotalPrice())},async runRuleEngine(){const i={variables:this.variables,nodes:{},pricing:this.pricing};this.nodesMap.forEach((t,s)=>{i.nodes[s]={nodeId:s,nodeCode:t.nodeCode,nodeName:t.nodeName,nodeType:t.nodeType,quantity:t.quantity,selectedProductId:t.selectedProductId,attributes:t.configuration||{},status:t.status,isVisible:t.isVisible,isDisabled:t.isDisabled,product:t.product||{}}}),f.setContext(i);const e=await f.evaluateAll();return this.applyRuleResults(e),this.validationErrors={},e.errors.forEach(t=>{this.validationErrors[t.ruleId]=t.message}),e.passed},applyRuleResults(i){const e=f.getContext();Object.entries(e.nodes).forEach(([t,s])=>{const r=this.nodesMap.get(Number(t));r&&(r.isVisible=s.isVisible!==!1,r.isDisabled=s.isDisabled===!0,s.attributes&&Object.assign(r.configuration||{},s.attributes))}),e.variables&&Object.assign(this.variables,e.variables),i.actions.forEach(t=>{if(t.actionType==="showMessage"&&t.result){const{messageType:s,message:r}=t.result;s==="success"?u.success(r):s==="warning"?u.warning(r):s==="error"?u.error(r):u.info(r)}})},async validateNodeConfiguration(i,e){const t=this.nodesMap.get(i);if(!t)return!1;const s=t.configuration;t.configuration=e,t.status="configured";const r=await this.runRuleEngine(),n=f.checkNodeConstraints(i,t);return n.valid?r:(t.configuration=s,t.status="error",this.validationErrors[i]=n.errors.map(o=>o.message).join("; "),!1)},async validateAttribute(i,e,t){const s=f.getContext();s.nodes[i]||(s.nodes[i]={attributes:{}}),s.nodes[i].attributes[e]=t,f.setContext(s),await f.evaluateAll()},async calculateTotalPrice(){let i=0;const e=[];this.nodesMap.forEach((t,s)=>{if(t.status==="configured"&&t.isVisible){const r=t.quantity||1;let n=0;if(t.selectedProductId&&t.product?n=t.product.price||0:t.price&&(n=t.price),t.costCalculationRule)try{const a=f.getContext();f.setContext(a),n=new Function(...Object.keys(a),`return ${t.costCalculationRule}`)(...Object.values(a))}catch(a){console.error("价格计算规则执行失败:",a)}const o=n*r;i+=o,e.push({nodeId:s,nodeName:t.nodeName,quantity:r,unitPrice:n,totalPrice:o})}}),this.pricing={totalPrice:i,breakdown:e}},async saveConfigSession(){try{const i={sessionId:this.configSession.sessionId,bomId:this.configSession.bomId,sessionName:this.configSession.sessionName,status:"saved",configuration:this.configSession.configuration,pricing:this.pricing,remark:`保存于 ${new Date().toLocaleString()}`};return this.configSession.savedToBackend?await T(i):(await R(i),this.configSession.savedToBackend=!0),this.configSession.status="saved",this.configSession.updatedAt=new Date,u.success("配置已保存"),!0}catch(i){return console.error("保存配置会话失败:",i),u.error("保存配置失败"),!1}},async loadConfigSession(i){try{const t=(await w(i)).data;return this.configSession={sessionId:t.sessionId,bomId:t.bomId,sessionName:t.sessionName,createdAt:new Date(t.createTime),updatedAt:new Date(t.updateTime),status:t.sessionStatus,configuration:JSON.parse(t.configurationData||"{}"),savedToBackend:!0},t.pricingData&&(this.pricing=JSON.parse(t.pricingData)),Object.entries(this.configSession.configuration).forEach(([s,r])=>{const n=this.nodesMap.get(Number(s));n&&(n.status="configured",n.configuration=r,n.quantity=r.quantity||n.defaultQuantity||1,n.selectedProductId=r.selectedProductId||null)}),u.success("配置已加载"),!0}catch(e){return console.error("加载配置会话失败:",e),u.error("加载配置失败"),!1}},async completeConfiguration(){if(!this.isConfigurationComplete)return u.warning("请完成所有必选项的配置"),!1;if(!await this.runRuleEngine())return u.error("配置不符合规则要求"),!1;try{return await this.saveConfigSession()?(this.configSession.savedToBackend&&await M(this.configSession.sessionId),this.configSession.status="completed",this.configSession.updatedAt=new Date,u.success("配置完成"),!0):!1}catch(e){return console.error("完成配置失败:",e),u.error("完成配置失败"),!1}},resetConfiguration(){this.nodesMap.forEach(i=>{i.status="unconfigured",i.configuration={},i.quantity=i.defaultQuantity||1,i.selectedProductId=null,i.isVisible=!0,i.isDisabled=!1}),this.configSession.configuration={},this.configSession.status="draft",this.validationErrors={},this.pricing={totalPrice:0,breakdown:[]},f.reset()}}});export{q as u};
