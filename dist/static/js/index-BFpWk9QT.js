import{u as Le,T as qe,r as u,$ as N,aE as Ne,H as ke,h as we,S as Te,aB as Re,a as c,i as De,c as Fe,o as K,e as g,b as a,j as E,w as r,f as p,t as Q,a0 as Y,U as H,m as Be,l as Ee,aC as Me,F as Ae,E as m,Q as $e}from"./index-DgigFOm-.js";import{listProduct as ze,deleteProduct as Ge,updateProduct as Ke,autoIntegrateCatalogAttributes as W,addProduct as Qe,batchUpdateProductAttributeRelation as Ye}from"./product-C-f__cve.js";import{g as He}from"./brand-DSdvFTtC.js";import{g as We,a as je}from"./series-BysOPRJ0.js";import{l as Oe}from"./catalog-B3PFbkp3.js";import Je from"./ProductMainInfo-DagHQboF.js";import Xe from"./ProductPriceInfo-DugSr_Mm.js";import Ze from"./ProductMaterialInfo-DTBV9FEs.js";import et from"./ProductBomInfo-C0kGwbTz.js";import tt from"./ProductParamsInfo-BwiN41ms.js";import lt from"./ProductAttributesInfo-BF1t-KjZ.js";import"./attributeGroup-dZVme5vU.js";import"./attributeGroupAttributeValue-C1lKcUwc.js";const at={class:"cpq-container"},rt={class:"cpq-action-bar"},ot={class:"cpq-actions"},it={class:"cpq-search-card"},st={class:"cpq-pagination"},nt={class:"cpq-dialog"},ut={class:"dialog-footer"},dt={class:"el-upload__tip text-center"},ct={class:"el-upload__tip"},pt={class:"dialog-footer"},Vt={__name:"index",setup(mt){Le();const{proxy:y}=qe(),U=u(!0),C=u(!0),k=u(0),M=u([]),j=u([]),w=u(""),I=u(!1),T=u("main"),s=N({open:!1,title:"",isUploading:!1,updateSupport:0,headers:{Authorization:"Bearer "+Ne()},url:"/prod-api/cpq/product/importData",selectedFile:null}),A=u([]),R=u([]),V=u([]),P=u([]),h=u([]),O=u([]),J=u([]),X=u([]),x=u(null),Z=t=>{t==="attributes"&&x.value&&x.value.refresh()},l=N({productId:null,productCode:"",productName:"",productDesc:"",productStatus:"1",productVersion:"V1.0",catalogId:null,basePrice:null,priceUnit:"CNY",mainImageUrl:"",imageUrls:"",detailPageUrl:"",model3DUrl:"",manualUrl:"",installationGuideUrl:"",videoUrl:"",brandId:null,seriesId:null,productModel:"",packagingUnit:"",weight:null,dimensions:"",warrantyPeriod:null,specification:"",technicalParams:"",materialType:null,costPrice:null,minSalesPrice:null,maxSalesPrice:null,suggestedRetailPrice:null,priceValidityPeriod:null}),d=N({pageNum:1,pageSize:10,productCode:"",productName:"",productStatus:""}),ee=N({productName:[{required:!0,message:"产品名称不能为空",trigger:"blur"}],productStatus:[{required:!0,message:"产品状态不能为空",trigger:"change"}],catalogId:[{required:!0,message:"所属目录不能为空",trigger:"change"}],productVersion:[{required:!0,message:"产品版本不能为空",trigger:"blur"}],mainImageUrl:[{required:!1,message:"请上传产品主图",trigger:"change"},{type:"url",message:"请输入有效的URL地址",trigger:"blur"}],detailPageUrl:[{type:"url",message:"请输入有效的URL地址",trigger:"blur"}],model3DUrl:[{type:"url",message:"请输入有效的URL地址",trigger:"blur"}],manualUrl:[{type:"url",message:"请输入有效的URL地址",trigger:"blur"}],installationGuideUrl:[{type:"url",message:"请输入有效的URL地址",trigger:"blur"}],videoUrl:[{type:"url",message:"请输入有效的URL地址",trigger:"blur"}],basePrice:[{required:!1,message:"请输入基准价格",trigger:"blur"},{type:"number",transform:t=>Number(t),min:0,message:"基准价格必须大于等于0",trigger:"blur"}],priceUnit:[{required:!1,message:"请选择价格单位",trigger:"change"}],costPrice:[{required:!1,message:"请输入成本价格",trigger:"blur"},{type:"number",transform:t=>Number(t),min:0,message:"成本价格必须大于等于0",trigger:"blur"}],minSalesPrice:[{required:!1,message:"请输入最小销售价格",trigger:"blur"},{type:"number",transform:t=>Number(t),min:0,message:"最小销售价格必须大于等于0",trigger:"blur"}],maxSalesPrice:[{required:!1,message:"请输入最大销售价格",trigger:"blur"},{type:"number",transform:t=>Number(t),min:0,message:"最大销售价格必须大于等于0",trigger:"blur"}],suggestedRetailPrice:[{required:!1,message:"请输入建议零售价",trigger:"blur"},{type:"number",transform:t=>Number(t),min:0,message:"建议零售价必须大于等于0",trigger:"blur"}],brandId:[{required:!1,message:"请选择所属品牌",trigger:"change"}],seriesId:[{required:!1,message:"请选择所属系列",trigger:"change"}],materialType:[{required:!0,message:"请选择物料类型",trigger:"change"}],productModel:[{required:!0,message:"请输入产品型号",trigger:"blur"}],packagingUnit:[{required:!1,message:"请输入包装单位",trigger:"blur"}],weight:[{required:!1,message:"请输入产品重量",trigger:"blur"},{type:"number",transform:t=>Number(t),min:0,message:"产品重量必须大于等于0",trigger:"blur"}],dimensions:[{required:!1,message:"请输入产品尺寸",trigger:"blur"}]}),_=async()=>{U.value=!0;try{const t=await ze(d);M.value=t.rows,k.value=t.total,U.value=!1}catch{U.value=!1,m.error("获取产品列表失败")}},L=()=>{d.pageNum=1,_()},te=()=>{d.productCode="",d.productName="",d.productStatus="",L()},le=()=>{C.value=!C.value},ae=()=>{l.productId=null,l.productCode="",l.productName="",l.productDesc="",l.productStatus="1",l.productVersion="V1.0",l.catalogId=null,l.basePrice=null,l.priceUnit="CNY",l.mainImageUrl="",l.imageUrls="",l.detailPageUrl="",l.model3DUrl="",l.manualUrl="",l.installationGuideUrl="",l.videoUrl="",l.brandId=null,l.seriesId=null,l.materialType=null,l.productModel="",l.packagingUnit="",l.weight=null,l.dimensions="",l.warrantyPeriod=null,l.specification="",l.technicalParams="",l.costPrice=null,l.minSalesPrice=null,l.maxSalesPrice=null,l.suggestedRetailPrice=null,l.priceValidityPeriod=null,O.value=[],J.value=[],X.value=[],P.value=[],h.value=[],w.value="新增产品",T.value="main",I.value=!0},re=async t=>{await Promise.all([D(),F()]),l.productId=t.productId,l.productCode=t.productCode,l.productName=t.productName,l.productDesc=t.productDesc||"",l.productStatus=t.productStatus,l.productVersion=t.productVersion||"V1.0",l.catalogId=t.catalogId?Number(t.catalogId):null,l.basePrice=t.basePrice,l.priceUnit=t.priceUnit||"CNY",l.mainImageUrl=t.mainImageUrl||"",l.imageUrls=t.imageUrls||"",l.detailPageUrl=t.detailPageUrl||"",l.model3DUrl=t.model3DUrl||"",l.manualUrl=t.manualUrl||"",l.installationGuideUrl=t.installationGuideUrl||"",l.videoUrl=t.videoUrl||"",l.brandId=t.brandId?Number(t.brandId):null,l.seriesId=t.seriesId?Number(t.seriesId):null,l.materialType=t.materialType||null,l.productModel=t.productModel||"",l.packagingUnit=t.packagingUnit||"",l.weight=t.weight||null,l.dimensions=t.dimensions||"",l.warrantyPeriod=t.warrantyPeriod||null,l.specification=t.specification||"",l.technicalParams=t.technicalParams||"",l.costPrice=t.costPrice||null,l.minSalesPrice=t.minSalesPrice||null,l.maxSalesPrice=t.maxSalesPrice||null,l.suggestedRetailPrice=t.suggestedRetailPrice||null,l.priceValidityPeriod=t.priceValidityPeriod||null,P.value=t.bomList||[],h.value=t.paramList||[];const e=t.seriesId||null;l.brandId=t.brandId?Number(t.brandId):null,e&&setTimeout(()=>{l.seriesId=e?Number(e):null},0),w.value="修改产品",I.value=!0},oe=async t=>{await $e.confirm("确定要删除该产品吗？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});try{await Ge(t.productId),m.success("删除成功"),_()}catch{m.error("删除失败")}},ie=()=>{y.download("cpq/product/export",{...d},`product_${new Date().getTime()}.xlsx`)},se=()=>{s.title="产品导入",s.open=!0},ne=()=>{y.download("cpq/product/importTemplate",{},`product_template_${new Date().getTime()}.xlsx`)},ue=(t,e,i)=>{s.isUploading=!0},de=(t,e)=>{s.selectedFile=t},ce=(t,e)=>{s.selectedFile=null},pe=(t,e)=>{s.open=!1,s.isUploading=!1,y.$refs.uploadRef.handleRemove(e),y.$alert("<div style='overflow: auto;overflow-x: hidden;max-height: 70vh;padding: 10px 20px 0;'>"+t.msg+"</div>","导入结果",{dangerouslyUseHTMLString:!0}),_()},me=()=>{if(!s.selectedFile||s.selectedFile.length===0||!s.selectedFile.name.toLowerCase().endsWith(".xls")&&!s.selectedFile.name.toLowerCase().endsWith(".xlsx")){y.$modal.msgError("请选择后缀为 “xls”或“xlsx”的文件。");return}y.$refs.uploadRef.submit()},ge=async()=>{const t=q.value;if(!t){console.error("表单ref不存在");return}try{await t.validate(),U.value=!0;const e={...l,bomList:P.value,paramList:h.value};let i;l.productId?(i=await Ke(e),m.success("修改成功"),l.catalogId&&await W(l.productId),await $()):(i=await Qe(e),i.data&&(l.productId=i.data),m.success("新增成功"),l.catalogId&&l.productId&&(await W(l.productId),await $())),I.value=!1,_()}catch(e){console.error("操作失败:",e),e===!1?m.error("表单验证失败，请检查填写内容"):m.error("操作失败："+(e.message||"未知错误"))}finally{U.value=!1}},fe=()=>{I.value=!1,q.value&&q.value.resetFields(),P.value=[],h.value=[]},D=async()=>{try{const t=await He();A.value=t.data}catch{m.error("获取品牌列表失败")}},be=async(t=null)=>{try{let e;t?e=await We(t):e=await je(),R.value=e.data||[]}catch{m.error("获取系列列表失败"),R.value=[]}},ve=t=>{const e=[],i={};t.forEach(n=>{i[n.catalogId]={...n,children:[]}}),t.forEach(n=>{const b=n.parentId||0;b===0?e.push(i[n.catalogId]):i[b]&&i[b].children.push(i[n.catalogId])});const f=n=>{n.children&&n.children.length>0&&(n.children.sort((b,B)=>(b.catalogSort||0)-(B.catalogSort||0)),n.children.forEach(b=>f(b)))};return e.forEach(n=>f(n)),e},F=async()=>{try{const t=await Oe();t&&t.code===200&&t.rows?V.value=ve(t.rows):V.value=[]}catch(t){console.error("获取目录树失败:",t),V.value=[],m.error("获取目录树失败: "+(t.message||"未知错误"))}},$=async()=>{if(!l.productId){m.warning("请先保存产品基本信息");return}if(!x.value){m.warning("产品属性组件未加载完成");return}const t=x.value.getProductAttributes();if(t.length===0){m.warning("没有需要保存的产品属性");return}try{const e=t.map(f=>({relationId:f.relationId,productId:l.productId,attributeId:f.attribute.attributeId,catalogRelationId:f.relationId,attributeValue:f.attributeValue})),i=await Ye(e);i.code===200?m.success("产品属性保存成功"):m.error("产品属性保存失败："+i.msg)}catch(e){console.error("保存产品属性失败:",e),m.error("产品属性保存失败："+(e.message||"未知错误"))}},q=u(null);return ke(()=>l.brandId,(t,e)=>{t!==e&&(l.seriesId=null,be(t))}),we(async()=>{Te(),await Promise.all([D(),F()]),_()}),Re(async()=>{await Promise.all([D(),F()]),_()}),(t,e)=>{const i=c("el-button"),f=c("el-input"),n=c("el-form-item"),b=c("el-option"),B=c("el-select"),z=c("el-form"),v=c("el-table-column"),_e=c("el-tag"),ye=c("el-table"),Ue=c("pagination"),S=c("el-tab-pane"),Ie=c("el-tabs"),G=c("el-dialog"),Pe=c("el-icon"),he=c("el-checkbox"),Se=c("el-link"),xe=c("el-upload"),Ce=De("loading");return K(),Fe(Ae,null,[g("div",at,[e[25]||(e[25]=g("div",{class:"cpq-page-title"}," 产品管理 ",-1)),g("div",rt,[g("div",ot,[a(i,{type:"primary",icon:"Plus",onClick:ae},{default:r(()=>e[15]||(e[15]=[p(" 新增产品 ")])),_:1,__:[15]}),a(i,{type:"danger",icon:"Delete",disabled:j.value},{default:r(()=>e[16]||(e[16]=[p(" 批量删除 ")])),_:1,__:[16]},8,["disabled"]),a(i,{type:"warning",icon:"Download",onClick:ie},{default:r(()=>e[17]||(e[17]=[p(" 导出 ")])),_:1,__:[17]}),a(i,{type:"success",icon:"Upload",onClick:se},{default:r(()=>e[18]||(e[18]=[p(" 导入 ")])),_:1,__:[18]})]),a(i,{type:"info",icon:"Search",onClick:le},{default:r(()=>[p(Q(C.value?"收起":"展开")+"搜索 ",1)]),_:1})]),E(g("div",it,[a(z,{model:d,ref:"queryForm",inline:!0,"label-width":"80px"},{default:r(()=>[a(n,{label:"产品编码",prop:"productCode"},{default:r(()=>[a(f,{modelValue:d.productCode,"onUpdate:modelValue":e[0]||(e[0]=o=>d.productCode=o),placeholder:"请输入产品编码",clearable:"",onKeyup:H(L,["enter"])},null,8,["modelValue"])]),_:1}),a(n,{label:"产品名称",prop:"productName"},{default:r(()=>[a(f,{modelValue:d.productName,"onUpdate:modelValue":e[1]||(e[1]=o=>d.productName=o),placeholder:"请输入产品名称",clearable:"",onKeyup:H(L,["enter"])},null,8,["modelValue"])]),_:1}),a(n,{label:"产品状态",prop:"productStatus"},{default:r(()=>[a(B,{modelValue:d.productStatus,"onUpdate:modelValue":e[2]||(e[2]=o=>d.productStatus=o),placeholder:"请选择产品状态",clearable:""},{default:r(()=>[a(b,{label:"启用",value:"1"}),a(b,{label:"禁用",value:"0"})]),_:1},8,["modelValue"])]),_:1}),a(n,null,{default:r(()=>[a(i,{type:"primary",icon:"Search",onClick:L},{default:r(()=>e[19]||(e[19]=[p("搜索")])),_:1,__:[19]}),a(i,{icon:"RefreshRight",onClick:te},{default:r(()=>e[20]||(e[20]=[p("重置")])),_:1,__:[20]})]),_:1})]),_:1},8,["model"])],512),[[Y,C.value]]),E((K(),Be(ye,{data:M.value,onSelectionChange:t.handleSelectionChange,border:""},{default:r(()=>[a(v,{type:"selection",width:"55",align:"center"}),a(v,{label:"产品编码",align:"center",prop:"productCode","min-width":"120"}),a(v,{label:"产品名称",align:"left",prop:"productName","show-overflow-tooltip":!0,"min-width":"200"}),a(v,{label:"产品型号",align:"center",prop:"productModel","min-width":"150"}),a(v,{label:"产品状态",align:"center",prop:"productStatus"},{default:r(o=>[a(_e,{class:"cpq-status-tag",type:o.row.productStatus==="1"?"success":"danger",size:"small"},{default:r(()=>[p(Q(o.row.productStatus==="1"?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),a(v,{label:"产品版本",align:"center",prop:"productVersion","min-width":"100"}),a(v,{label:"创建时间",align:"center",prop:"createTime",width:"180"}),a(v,{label:"操作",align:"center",width:"220",fixed:"right"},{default:r(o=>[a(i,{size:"small",type:"primary",icon:"Edit",onClick:Ve=>re(o.row)},{default:r(()=>e[21]||(e[21]=[p(" 修改 ")])),_:2,__:[21]},1032,["onClick"]),a(i,{size:"small",type:"danger",icon:"Delete",onClick:Ve=>oe(o.row)},{default:r(()=>e[22]||(e[22]=[p(" 删除 ")])),_:2,__:[22]},1032,["onClick"])]),_:1})]),_:1},8,["data","onSelectionChange"])),[[Ce,U.value]]),g("div",st,[E(a(Ue,{total:k.value,page:d.pageNum,"onUpdate:page":e[3]||(e[3]=o=>d.pageNum=o),limit:d.pageSize,"onUpdate:limit":e[4]||(e[4]=o=>d.pageSize=o),onPagination:_},null,8,["total","page","limit"]),[[Y,k.value>0]])]),g("div",nt,[a(G,{title:w.value,modelValue:I.value,"onUpdate:modelValue":e[11]||(e[11]=o=>I.value=o),width:"900px","append-to-body":""},{footer:r(()=>[g("span",ut,[a(i,{onClick:fe},{default:r(()=>e[23]||(e[23]=[p("取消")])),_:1,__:[23]}),a(i,{type:"primary",onClick:ge},{default:r(()=>e[24]||(e[24]=[p("确定")])),_:1,__:[24]})])]),default:r(()=>[a(z,{ref_key:"formRef",ref:q,model:l,rules:ee,"label-width":"100px",class:"cpq-form"},{default:r(()=>[a(Ie,{modelValue:T.value,"onUpdate:modelValue":e[10]||(e[10]=o=>T.value=o),class:"cpq-tabs",onTabChange:Z},{default:r(()=>[a(S,{label:"主要信息",name:"main"},{default:r(()=>[a(Je,{form:l,"onUpdate:form":e[5]||(e[5]=o=>l=o),brandList:A.value,seriesList:R.value,catalogTree:V.value},null,8,["form","brandList","seriesList","catalogTree"])]),_:1}),a(S,{label:"价格信息",name:"price"},{default:r(()=>[a(Xe,{form:l,"onUpdate:form":e[6]||(e[6]=o=>l=o)},null,8,["form"])]),_:1}),a(S,{label:"资料信息",name:"material"},{default:r(()=>[a(Ze,{form:l,"onUpdate:form":e[7]||(e[7]=o=>l=o)},null,8,["form"])]),_:1}),a(S,{label:"BOM组成",name:"bom"},{default:r(()=>[a(et,{bomList:P.value,"onUpdate:bomList":e[8]||(e[8]=o=>P.value=o)},null,8,["bomList"])]),_:1}),a(S,{label:"特性参数",name:"params"},{default:r(()=>[a(tt,{paramList:h.value,"onUpdate:paramList":e[9]||(e[9]=o=>h.value=o)},null,8,["paramList"])]),_:1}),a(S,{label:"产品属性",name:"attributes"},{default:r(()=>[a(lt,{ref_key:"attributesRef",ref:x,form:l},null,8,["form"])]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue"])])]),a(G,{title:s.title,modelValue:s.open,"onUpdate:modelValue":e[14]||(e[14]=o=>s.open=o),width:"400px","append-to-body":""},{footer:r(()=>[g("div",pt,[a(i,{type:"primary",onClick:me},{default:r(()=>e[30]||(e[30]=[p("确 定")])),_:1,__:[30]}),a(i,{onClick:e[13]||(e[13]=o=>s.open=!1)},{default:r(()=>e[31]||(e[31]=[p("取 消")])),_:1,__:[31]})])]),default:r(()=>[a(xe,{ref:"uploadRef",limit:1,accept:".xlsx, .xls",headers:s.headers,action:s.url+"?updateSupport="+s.updateSupport,disabled:s.isUploading,"on-progress":ue,"on-success":pe,"on-change":de,"on-remove":ce,"auto-upload":!1,drag:""},{tip:r(()=>[g("div",dt,[g("div",ct,[a(he,{modelValue:s.updateSupport,"onUpdate:modelValue":e[12]||(e[12]=o=>s.updateSupport=o)},null,8,["modelValue"]),e[26]||(e[26]=p("是否更新已经存在的产品数据 "))]),e[28]||(e[28]=g("span",null,"仅允许导入xls、xlsx格式文件。",-1)),a(Se,{type:"primary",underline:!1,style:{"font-size":"12px","vertical-align":"baseline"},onClick:ne},{default:r(()=>e[27]||(e[27]=[p("下载模板")])),_:1,__:[27]})])]),default:r(()=>[a(Pe,{class:"el-icon--upload"},{default:r(()=>[a(Ee(Me))]),_:1}),e[29]||(e[29]=g("div",{class:"el-upload__text"},[p("将文件拖到此处，或"),g("em",null,"点击上传")],-1))]),_:1,__:[29]},8,["headers","action","disabled"])]),_:1},8,["title","modelValue"])],64)}}};export{Vt as default};
