import{_ as Ce,r as p,g as Ie,$ as Re,h as we,a as r,c as I,o as g,e as s,j as xe,b as l,k as W,w as n,f as v,F as ke,n as Te,a3 as Ne,t as k,x as O,l as b,al as Ue,am as S,aj as he,m as De,a0 as Ee,ao as Me,as as Be,ap as Oe,aq as Se,E as m,Q as $e}from"./index-DgigFOm-.js";import Ae from"./RuleConditionConfig-Dg9DxmSj.js";import ze from"./RuleActionConfig-LYjVYhPB.js";import je from"./RuleAdvancedConfig-BBItg349.js";/* empty css                                                                     */import{u as K,a as Le,d as Fe}from"./rule-ChqRra5H.js";import{g as qe,u as X,d as Ge}from"./TargetObjectSelector-Bt4flkLc.js";import"./vuedraggable.umd-B409vRHe.js";import"./sortable.esm-CAlIhjx7.js";import"./superBomStructure-C2O6seWy.js";import"./bom-CjuVRwkz.js";import"./superBomVariable-_jqz_F6y.js";import"./superBomDynamicAttribute-6n4Uab6m.js";import"./superBomProductRelation-c5nmns4w.js";import"./RuleActionItem-DhAQO5kb.js";import"./ActionHeader-0K2-qy4i.js";import"./ActionContent-BOqNEGN_.js";import"./ActionTypeSelector-DMQg9yzW.js";import"./actionConfig-C-hhf0v-.js";import"./TargetTypeSelector-CLltoMlE.js";import"./ActionParamsConfig-Dhc9pdhZ.js";import"./AttributeSelector-CyYPhvVA.js";import"./index-DAib79Lj.js";import"./NodeSelector-DEupmx4h.js";import"./BasicInfoSection-Cpw6sxwq.js";import"./ruleAction-CXds5VRx.js";const Je={class:"bom-rule-config"},Pe={class:"rule-content"},He={class:"rule-main"},Qe={class:"rule-list-container"},We={class:"list-header"},Ke={class:"list-actions"},Xe={class:"rule-list"},Ye=["onClick"],Ze={class:"rule-item-header"},el={class:"rule-item-info"},ll={class:"rule-name"},tl={class:"rule-meta"},al={key:0,class:"rule-item-description"},ol={key:0,class:"empty-rules"},nl={class:"rule-detail-container"},ul={key:0,class:"empty-detail"},sl={class:"rule-basic-info"},il={class:"form-actions"},rl={class:"dialog-footer"},dl={__name:"BomRuleConfig",props:{bomId:{type:[String,Number],required:!0}},setup(Y,{expose:Z}){const T=Y,$=p(!1),N=p(""),E=p([]),t=p(null),U=p("basic"),R=p(!1),ee=p(0),le=p(0),f=p(null),A=Ie(()=>N.value?E.value.filter(a=>a.ruleName.includes(N.value)):E.value),te=a=>({1:"验证规则",2:"计算规则",3:"条件规则",4:"跳转规则"})[a]||a,ae=a=>({1:"primary",2:"success",3:"warning",4:"info"})[a]||"default",w=p(!1),z=p(null),i=Re({ruleName:"",ruleType:"1",priority:1,description:""}),oe={ruleName:[{required:!0,message:"请输入规则名称",trigger:"blur"}],ruleType:[{required:!0,message:"请选择规则类型",trigger:"change"}]},V=async()=>{try{$.value=!0;const e=(await qe(T.bomId)).data||[];E.value=e.map(u=>({ruleId:u.ruleId,ruleName:u.ruleName,ruleCode:u.ruleCode,ruleType:u.ruleType,relationId:u.relationId,bomId:u.bomId,ruleOrder:u.ruleOrder,relationType:u.relationType,status:u.status===0||u.status==="0"?"enabled":"disabled",remark:u.remark,ruleExpression:"",conditions:[],actions:[],advancedConfig:{}}))}catch(a){console.error("加载规则列表失败:",a),m.error("加载规则列表失败")}finally{$.value=!1}},ne=a=>{t.value=a,U.value="basic"},ue=(a,e)=>{switch(a){case"edit":j(e);break;case"toggle":M(e);break;case"delete":L(e);break}},se=()=>{w.value=!0,Object.assign(i,{ruleName:"",ruleType:"1",priority:1,description:""})},j=a=>{t.value=a,U.value="basic"},M=async(a,e)=>{try{if(a.status=e,await K(a),a.relationId){const u={relationId:a.relationId,status:e==="enabled"?0:1};await X(u)}m.success(`规则及关联关系${e==="enabled"?"启用":"禁用"}成功`),await V()}catch(u){a.status=a.status==="enabled"?"disabled":"enabled",console.error("切换规则状态失败:",u),m.error("切换规则状态失败")}},L=async a=>{var e;try{await $e.confirm(`确定删除规则"${a.ruleName}"及关联关系吗？`,"提示",{type:"warning"}),a.relationId&&await Ge([a.relationId]),await Fe(a.ruleId),await V(),((e=t.value)==null?void 0:e.ruleId)===a.ruleId&&(t.value=null),m.success("删除规则及关联关系成功")}catch(u){u!=="cancel"&&(console.error("删除规则失败:",u),m.error("删除规则失败"))}},ie=()=>{f.value&&(j(f.value),R.value=!1)},re=()=>{f.value&&(M(f.value,f.value.status==="enabled"?"disabled":"enabled"),R.value=!1)},de=()=>{f.value&&(L(f.value),R.value=!1)},me=async()=>{try{await z.value.validate();const a={bomId:T.bomId,rule:{ruleCode:`RULE_${Date.now()}`,ruleName:i.ruleName,ruleType:i.ruleType,conditionType:"simple",triggerCondition:"onSelect",conditionConfig:JSON.stringify(i.conditions||[]),ruleAction:"showMessage",actionType:"simple",actionConfig:JSON.stringify(i.actions||[]),rulePriority:i.priority,effectiveDate:null,expireDate:null,ruleStatus:"0",description:i.description,ruleOrder:i.priority||1,remark:""}};await Le(a),w.value=!1,await V(),m.success("新增规则及关联关系成功")}catch(a){a!=="cancel"&&(console.error("新增规则失败:",a),m.error("新增规则失败"))}},pe=async()=>{try{if(!t.value)return;const a={ruleId:t.value.ruleId,ruleName:t.value.ruleName,ruleCode:t.value.ruleCode,ruleType:t.value.ruleType,status:t.value.status==="enabled"?0:1};if(await K(a),t.value.relationId){const e={relationId:t.value.relationId,ruleOrder:t.value.ruleOrder||t.value.priority||1,status:t.value.status==="enabled"?0:1,remark:t.value.remark};await X(e)}m.success("保存规则及关联关系成功"),await V()}catch(a){console.error("保存规则失败:",a),m.error("保存规则失败")}},ce=()=>{t.value=null},h=()=>{if(!t.value)return;const a=t.value.conditions||[],e=t.value.actions||[];let u="";a.length>0&&(u+="IF "+a.map(d=>`${d.field} ${d.operator} ${d.value}`).join(" AND ")+" THEN "),e.length>0&&(u+=e.map(d=>`${d.type}: ${d.target}`).join("; ")),t.value.ruleExpression=u},ve=a=>{t.value&&(Object.assign(t.value,a),h(),m.success("AI生成规则成功"))},fe=a=>{t.value&&(Object.assign(t.value,a),h(),m.success("AI优化规则成功"))},_e=a=>{a.length>0?m.warning(`检测到${a.length}个冲突，请检查规则配置`):m.success("未检测到冲突")};return document.addEventListener("click",()=>{R.value=!1}),we(()=>{V()}),Z({loadRuleList:V}),(a,e)=>{var Q;const u=r("el-input"),d=r("el-button"),ye=r("el-tag"),F=r("el-switch"),q=r("el-empty"),c=r("el-form-item"),D=r("el-col"),_=r("el-option"),G=r("el-select"),J=r("el-row"),P=r("el-input-number"),H=r("el-form"),x=r("el-tab-pane"),be=r("rule-ai-assist"),ge=r("el-tabs"),B=r("el-icon"),Ve=r("el-dialog");return g(),I("div",Je,[s("div",Pe,[s("div",He,[s("div",Qe,[s("div",We,[s("div",Ke,[l(u,{modelValue:N.value,"onUpdate:modelValue":e[0]||(e[0]=o=>N.value=o),placeholder:"搜索规则名称","prefix-icon":"Search",clearable:"",size:"small",style:{width:"200px","margin-right":"16px"}},null,8,["modelValue"]),l(d,{type:"primary",icon:"Plus",onClick:se,size:"small"},{default:n(()=>e[19]||(e[19]=[v("新增规则")])),_:1,__:[19]})])]),s("div",Xe,[(g(!0),I(ke,null,Te(A.value,o=>{var y;return g(),I("div",{key:o.ruleId,class:Ne(["rule-item",{"rule-item-selected":((y=t.value)==null?void 0:y.ruleId)===o.ruleId}]),onClick:C=>ne(o)},[s("div",Ze,[s("div",el,[s("div",ll,k(o.ruleName),1),s("div",tl,[l(ye,{type:ae(o.ruleType)},{default:n(()=>[v(k(te(o.ruleType)),1)]),_:2},1032,["type"]),l(F,{modelValue:o.status,"onUpdate:modelValue":C=>o.status=C,"active-value":"enabled","inactive-value":"disabled",onChange:C=>M(o,C),size:"small",onClick:e[1]||(e[1]=O(()=>{},["stop"]))},null,8,["modelValue","onUpdate:modelValue","onChange"])])]),l(b(he),{onCommand:C=>ue(C,o),onClick:e[2]||(e[2]=O(()=>{},["stop"]))},{dropdown:n(()=>[l(b(Ue),null,{default:n(()=>[l(b(S),{command:"edit"},{default:n(()=>e[20]||(e[20]=[v("编辑规则")])),_:1,__:[20]}),l(b(S),{command:"toggle"},{default:n(()=>[v(k(o.status==="enabled"?"禁用":"启用"),1)]),_:2},1024),l(b(S),{command:"delete"},{default:n(()=>e[21]||(e[21]=[v("删除规则")])),_:1,__:[21]})]),_:2},1024)]),default:n(()=>[l(d,{type:"text",icon:"More",size:"small"})]),_:2},1032,["onCommand"])]),o.description?(g(),I("div",al,k(o.description),1)):W("",!0)],10,Ye)}),128))]),A.value.length===0?(g(),I("div",ol,[l(q,{description:"暂无规则"})])):W("",!0)]),s("div",nl,[t.value?(g(),De(ge,{key:1,modelValue:U.value,"onUpdate:modelValue":e[11]||(e[11]=o=>U.value=o),type:"border-card"},{default:n(()=>[l(x,{label:"规则基本信息",name:"basic"},{default:n(()=>[s("div",sl,[l(H,{model:t.value,"label-width":"120px"},{default:n(()=>[l(J,{gutter:20},{default:n(()=>[l(D,{span:12},{default:n(()=>[l(c,{label:"规则名称"},{default:n(()=>[l(u,{modelValue:t.value.ruleName,"onUpdate:modelValue":e[3]||(e[3]=o=>t.value.ruleName=o),placeholder:"规则名称"},null,8,["modelValue"])]),_:1})]),_:1}),l(D,{span:12},{default:n(()=>[l(c,{label:"规则类型"},{default:n(()=>[l(G,{modelValue:t.value.ruleType,"onUpdate:modelValue":e[4]||(e[4]=o=>t.value.ruleType=o),placeholder:"规则类型"},{default:n(()=>[l(_,{label:"验证规则",value:"1"}),l(_,{label:"计算规则",value:"2"}),l(_,{label:"条件规则",value:"3"}),l(_,{label:"跳转规则",value:"4"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(J,{gutter:20},{default:n(()=>[l(D,{span:12},{default:n(()=>[l(c,{label:"优先级"},{default:n(()=>[l(P,{modelValue:t.value.priority,"onUpdate:modelValue":e[5]||(e[5]=o=>t.value.priority=o),min:1,max:10,step:1},null,8,["modelValue"])]),_:1})]),_:1}),l(D,{span:12},{default:n(()=>[l(c,{label:"状态"},{default:n(()=>[l(F,{modelValue:t.value.status,"onUpdate:modelValue":e[6]||(e[6]=o=>t.value.status=o),"active-value":"enabled","inactive-value":"disabled"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(c,{label:"描述"},{default:n(()=>[l(u,{modelValue:t.value.description,"onUpdate:modelValue":e[7]||(e[7]=o=>t.value.description=o),type:"textarea",rows:3,placeholder:"规则描述"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"]),s("div",il,[l(d,{type:"primary",onClick:pe},{default:n(()=>e[22]||(e[22]=[v("保存")])),_:1,__:[22]}),l(d,{onClick:ce},{default:n(()=>e[23]||(e[23]=[v("取消")])),_:1,__:[23]})])])]),_:1}),l(x,{label:"条件配置",name:"condition"},{default:n(()=>{var o;return[l(Ae,{modelValue:t.value.conditions,"onUpdate:modelValue":e[8]||(e[8]=y=>t.value.conditions=y),"rule-type":t.value.ruleType,"bom-id":T.bomId,"rule-id":(o=t.value)==null?void 0:o.ruleId,"onUpdate:conditions":h},null,8,["modelValue","rule-type","bom-id","rule-id"])]}),_:1}),l(x,{label:"动作配置",name:"action"},{default:n(()=>{var o;return[l(ze,{modelValue:t.value.actions,"onUpdate:modelValue":e[9]||(e[9]=y=>t.value.actions=y),"rule-type":t.value.ruleType,"rule-id":(o=t.value)==null?void 0:o.ruleId,"bom-id":T.bomId,"onUpdate:actions":h},null,8,["modelValue","rule-type","rule-id","bom-id"])]}),_:1}),l(x,{label:"高级配置",name:"advanced"},{default:n(()=>{var o;return[l(je,{modelValue:t.value.advancedConfig,"onUpdate:modelValue":e[10]||(e[10]=y=>t.value.advancedConfig=y),"rule-type":t.value.ruleType,"rule-id":(o=t.value)==null?void 0:o.ruleId},null,8,["modelValue","rule-type","rule-id"])]}),_:1}),l(x,{label:"AI辅助",name:"ai"},{default:n(()=>[l(be,{onGenerateRule:ve,onOptimizeRule:fe,onDetectConflicts:_e})]),_:1})]),_:1},8,["modelValue"])):(g(),I("div",ul,[l(q,{description:"请选择或新增一个规则"})]))])])]),xe(s("div",{class:"context-menu",style:Se({left:ee.value+"px",top:le.value+"px"}),onClick:e[12]||(e[12]=O(()=>{},["stop"]))},[s("div",{class:"menu-item",onClick:ie},[l(B,null,{default:n(()=>[l(b(Me))]),_:1}),e[24]||(e[24]=s("span",null,"编辑规则",-1))]),s("div",{class:"menu-item",onClick:re},[l(B,null,{default:n(()=>[l(b(Be))]),_:1}),s("span",null,k(((Q=f.value)==null?void 0:Q.status)==="enabled"?"禁用规则":"启用规则"),1)]),s("div",{class:"menu-item",onClick:de},[l(B,null,{default:n(()=>[l(b(Oe))]),_:1}),e[25]||(e[25]=s("span",null,"删除规则",-1))])],4),[[Ee,R.value]]),l(Ve,{title:"新增规则",modelValue:w.value,"onUpdate:modelValue":e[18]||(e[18]=o=>w.value=o),width:"600px","append-to-body":""},{footer:n(()=>[s("span",rl,[l(d,{onClick:e[17]||(e[17]=o=>w.value=!1)},{default:n(()=>e[26]||(e[26]=[v("取消")])),_:1,__:[26]}),l(d,{type:"primary",onClick:me},{default:n(()=>e[27]||(e[27]=[v("确定")])),_:1,__:[27]})])]),default:n(()=>[l(H,{ref_key:"dialogFormRef",ref:z,model:i,rules:oe,"label-width":"120px"},{default:n(()=>[l(c,{label:"规则名称",prop:"ruleName"},{default:n(()=>[l(u,{modelValue:i.ruleName,"onUpdate:modelValue":e[13]||(e[13]=o=>i.ruleName=o),placeholder:"请输入规则名称"},null,8,["modelValue"])]),_:1}),l(c,{label:"规则类型",prop:"ruleType"},{default:n(()=>[l(G,{modelValue:i.ruleType,"onUpdate:modelValue":e[14]||(e[14]=o=>i.ruleType=o),placeholder:"请选择规则类型"},{default:n(()=>[l(_,{label:"验证规则",value:"1"}),l(_,{label:"计算规则",value:"2"}),l(_,{label:"条件规则",value:"3"}),l(_,{label:"跳转规则",value:"4"})]),_:1},8,["modelValue"])]),_:1}),l(c,{label:"优先级",prop:"priority"},{default:n(()=>[l(P,{modelValue:i.priority,"onUpdate:modelValue":e[15]||(e[15]=o=>i.priority=o),min:1,max:10,step:1,placeholder:"请输入优先级"},null,8,["modelValue"])]),_:1}),l(c,{label:"描述",prop:"description"},{default:n(()=>[l(u,{modelValue:i.description,"onUpdate:modelValue":e[16]||(e[16]=o=>i.description=o),type:"textarea",placeholder:"请输入规则描述",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},$l=Ce(dl,[["__scopeId","data-v-f4d4cec3"]]);export{$l as default};
