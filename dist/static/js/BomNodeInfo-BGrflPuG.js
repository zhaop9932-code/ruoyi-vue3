import{_ as me,r as u,C as K,w as ce,o as pe,a7 as fe,h as i,d as U,e as w,j as s,H as be,i as t,k as a,q as S,t as ve,n as c,a8 as ye,a9 as ge,aa as Ne,ab as M,ac as _e,l as X,I as Ie,ad as Se,ae as Ve,af as xe,s as we,a5 as Ce,K as he,L as ke,V as y,E as Te}from"./index-CwdKQqOf.js";import Be from"./BomNodeInfoDetail-0OZwHhoY.js";import qe from"./BomNodeAttributes-Bk_BH8fC.js";import De from"./BomNodeProducts-b2piF3NW.js";import Ee from"./BomNodeDynamicProps-Cgi6cQPx.js";import Ue from"./BomNodeOtherInfo-2rRD_CG3.js";import{k as Me,m as Oe,n as Je,o as Le,p as Ae}from"./bom-DdrUuB8x.js";import"./index-BJWhiuhk.js";import"./superBomProductRelation-e2EKVMIZ.js";import"./product-CtyH2BmW.js";import"./series-CECqxvZD.js";import"./catalog-CV4btQTA.js";import"./superBomDynamicAttribute-BGTx_QxK.js";const Fe={class:"bom-node-info"},Pe={class:"node-content"},Re={class:"node-tree-container"},ze={class:"tree-header"},je={class:"tree-node"},Qe={class:"tree-node-action"},$e={class:"node-detail-container"},He={key:0,class:"empty-detail"},Ke={class:"dialog-footer"},Xe={__name:"BomNodeInfo",props:{bomId:{type:[String,Number],required:!0}},setup(g){const O=g,J=u(null),V=u(!1),B=u(""),d=u(null),C=u(null),L=u("nodeInfo"),N=u(!1),A=u(0),F=u(0),p=u(null),b=u(!1),h=u("新增节点"),k=u(!1),q=u(null),D=u([]),Y={label:"nodeName",children:"children"},o=K({bomStructureId:null,bomId:O.bomId,nodeCode:"",nodeName:"",nodeType:"0",parentNodeId:null,quantity:1,unit:"",status:"enabled",priority:1,description:"",children:[],isRequired:"0",selectionType:"single",minSelection:0,maxSelection:0,isQuantityEditable:"1",icon:"",nodeDescription:""}),G=K({nodeName:[{required:!0,message:"节点名称不能为空",trigger:"blur"}],nodeType:[{required:!0,message:"请选择节点类型",trigger:"change"}],parentNodeId:[{required:!1,message:"请选择父节点",trigger:"change"}],quantity:[{required:!0,message:"请输入数量",trigger:"blur"},{type:"number",min:0,message:"数量不能小于0",trigger:"blur"}],status:[{required:!0,message:"请选择状态",trigger:"change"}],priority:[{required:!0,message:"请输入优先级",trigger:"blur"},{type:"number",min:1,max:10,message:"优先级必须在1-10之间",trigger:"blur"}]}),W=(l,e)=>l?e.nodeName.toLowerCase().includes(l.toLowerCase()):!0;ce(B,l=>{J.value.filter(l)});const T=async()=>{V.value=!0;try{const e=(await Me(O.bomId)).data||[];D.value=Z(e),V.value=!1}catch(l){console.error("加载节点树失败:",l),y.error("加载节点树失败"),V.value=!1}},Z=l=>{if(!Array.isArray(l)||l.length===0)return[];const e=[],r=new Map;return l.forEach(m=>{r.set(m.bomStructureId,{...m,children:[]})}),l.forEach(m=>{const v=r.get(m.bomStructureId),x=m.parentNodeId||0;x===0||!r.has(x)?e.push(v):r.get(x).children.push(v)}),e},P=(l=D.value,e=[])=>{for(const r of l)e.push(r),r.children&&r.children.length>0&&P(r.children,e);return e},ee=async l=>{V.value=!0;try{const r=(await Oe({bomStructureId:l.bomStructureId})).rows.find(m=>m.bomStructureId===l.bomStructureId);r?(d.value={...r},console.log("selectedNode.value:",d.value),console.log("selectedNode.value.bomStructureId:",d.value.bomStructureId),C.value=JSON.parse(JSON.stringify(r))):(d.value={...l},C.value=JSON.parse(JSON.stringify(l)))}catch(e){console.error("获取节点信息失败:",e),y.error("获取节点信息失败"),d.value={...l},C.value=JSON.parse(JSON.stringify(l))}finally{V.value=!1}},te=(l,e)=>{l.preventDefault(),p.value=e,A.value=l.clientX,F.value=l.clientY,N.value=!0},R=l=>{l.target.closest(".context-menu")===null&&(N.value=!1)},oe=(l,e)=>{switch(p.value=e,l){case"addChild":z();break;case"edit":d.value={...e},C.value=JSON.parse(JSON.stringify(e)),j();break;case"delete":Q(e);break}},le=()=>{k.value=!0,$(),h.value="新增根节点",b.value=!0},z=()=>{p.value&&($(),o.parentNodeId=p.value.bomStructureId,k.value=!1,h.value="新增子节点",N.value=!1,b.value=!0)},j=()=>{p.value&&(Object.assign(o,{...p.value}),k.value=!p.value.parentNodeId,h.value="编辑节点",N.value=!1,b.value=!0)},ae=async()=>{p.value&&(await Q(p.value),N.value=!1)},Q=async l=>{try{await Te.confirm(`确定要删除节点 "${l.nodeName}" 吗？`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await Ae([l.bomStructureId]),await T(),y.success("节点删除成功"),d.value&&d.value.bomStructureId===l.bomStructureId&&(d.value=null)}catch(e){e!=="cancel"&&(y.error("删除失败"),console.error("删除节点失败:",e))}},ne=async()=>{try{await q.value.validate(),o.bomStructureId?(await Je(o),await T(),y.success("节点更新成功")):(await Le(o),await T(),y.success("节点新增成功")),b.value=!1}catch(l){l!==!1&&(y.error("操作失败，请检查表单数据"),console.error("提交节点表单失败:",l))}},$=()=>{var l;o.bomStructureId=null,o.nodeCode="",o.nodeName="",o.nodeType="0",o.parentNodeId=null,o.quantity=1,o.unit="",o.status="enabled",o.priority=1,o.description="",o.isRequired="0",o.selectionType="single",o.minSelection=0,o.maxSelection=0,o.isQuantityEditable="1",o.icon="",o.nodeDescription="",(l=q.value)==null||l.resetFields()};return pe(()=>{T(),document.addEventListener("click",R)}),fe(()=>{document.removeEventListener("click",R)}),(l,e)=>{const r=i("el-input"),m=i("el-button"),v=i("el-icon"),x=i("el-empty"),_=i("el-tab-pane"),re=i("el-tabs"),f=i("el-form-item"),I=i("el-option"),E=i("el-select"),H=i("el-input-number"),de=i("el-form"),ue=i("el-dialog");return w(),U("div",Fe,[s("div",Pe,[s("div",Re,[s("div",ze,[t(r,{modelValue:B.value,"onUpdate:modelValue":e[0]||(e[0]=n=>B.value=n),placeholder:"搜索节点名称","prefix-icon":"Search",clearable:"",size:"small",style:{width:"150px"}},null,8,["modelValue"]),t(m,{type:"primary",icon:"Plus",onClick:le,size:"small",style:{"margin-left":"8px"}},{default:a(()=>e[14]||(e[14]=[S("新增节点")])),_:1,__:[14]})]),t(c(_e),{ref_key:"nodeTree",ref:J,data:D.value,props:Y,"filter-node-method":W,onNodeClick:ee,onNodeContextmenu:te,"node-key":"bomStructureId","default-expand-all":"","highlight-current":!0},{default:a(({node:n,data:se})=>[s("div",je,[s("span",null,ve(n.label),1),t(c(ye),{onCommand:ie=>oe(ie,se)},{dropdown:a(()=>[t(c(Ne),null,{default:a(()=>[t(c(M),{command:"addChild"},{default:a(()=>e[15]||(e[15]=[S("新增子节点")])),_:1,__:[15]}),t(c(M),{command:"edit"},{default:a(()=>e[16]||(e[16]=[S("编辑节点")])),_:1,__:[16]}),t(c(M),{command:"delete"},{default:a(()=>e[17]||(e[17]=[S("删除节点")])),_:1,__:[17]})]),_:1})]),default:a(()=>[s("span",Qe,[t(v,{class:"more-icon"},{default:a(()=>[t(c(ge))]),_:1})])]),_:2},1032,["onCommand"])])]),_:1},8,["data"])]),s("div",$e,[d.value?(w(),X(re,{key:1,modelValue:L.value,"onUpdate:modelValue":e[1]||(e[1]=n=>L.value=n),type:"border-card"},{default:a(()=>[t(_,{label:"节点信息",name:"nodeInfo"},{default:a(()=>[t(Be,{"bom-id":g.bomId,"bom-structure-id":d.value.bomStructureId,"selected-node":d.value},null,8,["bom-id","bom-structure-id","selected-node"])]),_:1}),t(_,{label:"属性信息",name:"attributes"},{default:a(()=>[t(qe,{"bom-id":g.bomId,"node-name":d.value.nodeName,"bom-structure-id":d.value.bomStructureId},null,8,["bom-id","node-name","bom-structure-id"])]),_:1}),t(_,{label:"关联产品",name:"products"},{default:a(()=>[t(De,{"bom-id":g.bomId,"bom-structure-id":d.value.bomStructureId},null,8,["bom-id","bom-structure-id"])]),_:1}),t(_,{label:"动态属性",name:"dynamicProps"},{default:a(()=>[t(Ee,{"bom-id":g.bomId,"bom-structure-id":d.value.bomStructureId},null,8,["bom-id","bom-structure-id"])]),_:1}),t(_,{label:"其他",name:"other"},{default:a(()=>[t(Ue,{"bom-id":g.bomId,"bom-structure-id":d.value.bomStructureId},null,8,["bom-id","bom-structure-id"])]),_:1})]),_:1},8,["modelValue"])):(w(),U("div",He,[t(x,{description:"请选择或新增一个节点"})]))])]),be(s("div",{class:"context-menu",style:Ce({left:A.value+"px",top:F.value+"px"}),onClick:e[2]||(e[2]=we(()=>{},["stop"]))},[s("div",{class:"menu-item",onClick:z},[t(v,null,{default:a(()=>[t(c(Se))]),_:1}),e[18]||(e[18]=s("span",null,"新增子节点",-1))]),s("div",{class:"menu-item",onClick:j},[t(v,null,{default:a(()=>[t(c(Ve))]),_:1}),e[19]||(e[19]=s("span",null,"编辑节点",-1))]),s("div",{class:"menu-item",onClick:ae},[t(v,null,{default:a(()=>[t(c(xe))]),_:1}),e[20]||(e[20]=s("span",null,"删除节点",-1))])],4),[[Ie,N.value]]),t(ue,{title:h.value,modelValue:b.value,"onUpdate:modelValue":e[13]||(e[13]=n=>b.value=n),width:"600px","append-to-body":""},{footer:a(()=>[s("span",Ke,[t(m,{onClick:e[12]||(e[12]=n=>b.value=!1)},{default:a(()=>e[21]||(e[21]=[S("取消")])),_:1,__:[21]}),t(m,{type:"primary",onClick:ne},{default:a(()=>e[22]||(e[22]=[S("确定")])),_:1,__:[22]})])]),default:a(()=>[t(de,{ref_key:"dialogFormRef",ref:q,model:o,rules:G,"label-width":"120px"},{default:a(()=>[t(f,{label:"节点编码",prop:"nodeCode"},{default:a(()=>[t(r,{modelValue:o.nodeCode,"onUpdate:modelValue":e[3]||(e[3]=n=>o.nodeCode=n),placeholder:"自动生成",disabled:""},null,8,["modelValue"])]),_:1}),t(f,{label:"节点名称",prop:"nodeName"},{default:a(()=>[t(r,{modelValue:o.nodeName,"onUpdate:modelValue":e[4]||(e[4]=n=>o.nodeName=n),placeholder:"请输入节点名称"},null,8,["modelValue"])]),_:1}),t(f,{label:"节点类型",prop:"nodeType"},{default:a(()=>[t(E,{modelValue:o.nodeType,"onUpdate:modelValue":e[5]||(e[5]=n=>o.nodeType=n),placeholder:"请选择节点类型"},{default:a(()=>[t(I,{label:"物料",value:"0"}),t(I,{label:"组件",value:"1"}),t(I,{label:"服务",value:"2"})]),_:1},8,["modelValue"])]),_:1}),t(f,{label:"父节点",prop:"parentNodeId"},{default:a(()=>[t(E,{modelValue:o.parentNodeId,"onUpdate:modelValue":e[6]||(e[6]=n=>o.parentNodeId=n),placeholder:"请选择父节点",disabled:k.value},{default:a(()=>[(w(!0),U(he,null,ke(P(),n=>(w(),X(I,{key:n.bomStructureId,label:n.nodeName,value:n.bomStructureId},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),t(f,{label:"数量",prop:"quantity"},{default:a(()=>[t(H,{modelValue:o.quantity,"onUpdate:modelValue":e[7]||(e[7]=n=>o.quantity=n),min:0,step:1,placeholder:"请输入数量"},null,8,["modelValue"])]),_:1}),t(f,{label:"单位",prop:"unit"},{default:a(()=>[t(r,{modelValue:o.unit,"onUpdate:modelValue":e[8]||(e[8]=n=>o.unit=n),placeholder:"请输入单位"},null,8,["modelValue"])]),_:1}),t(f,{label:"状态",prop:"status"},{default:a(()=>[t(E,{modelValue:o.status,"onUpdate:modelValue":e[9]||(e[9]=n=>o.status=n),placeholder:"请选择状态"},{default:a(()=>[t(I,{label:"启用",value:"enabled"}),t(I,{label:"禁用",value:"disabled"})]),_:1},8,["modelValue"])]),_:1}),t(f,{label:"优先级",prop:"priority"},{default:a(()=>[t(H,{modelValue:o.priority,"onUpdate:modelValue":e[10]||(e[10]=n=>o.priority=n),min:1,max:10,step:1,placeholder:"请输入优先级"},null,8,["modelValue"])]),_:1}),t(f,{label:"描述",prop:"description"},{default:a(()=>[t(r,{modelValue:o.description,"onUpdate:modelValue":e[11]||(e[11]=n=>o.description=n),type:"textarea",placeholder:"请输入节点描述",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue"])])}}},st=me(Xe,[["__scopeId","data-v-4b1ce0b1"]]);export{st as default};
