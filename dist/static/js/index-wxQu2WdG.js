import{a as Le,f as we,r as d,C as q,aJ as ke,w as qe,o as Te,b as Ne,h as c,G as Re,d as De,e as z,j as g,i as a,H as F,k as r,q as p,t as G,I as K,p as Y,l as Fe,n as Be,at as Me,K as Ee,V as m,E as Ae}from"./index-CwdKQqOf.js";import{listProduct as $e,deleteProduct as ze,updateProduct as Ge,autoIntegrateCatalogAttributes as H,addProduct as Ke,batchUpdateProductAttributeRelation as Ye}from"./product-CtyH2BmW.js";import{g as He}from"./brand-DsHCj4TR.js";import{g as Qe,a as We}from"./series-CECqxvZD.js";import{l as je}from"./catalog-CV4btQTA.js";import Je from"./ProductMainInfo-MFggMcV2.js";import Oe from"./ProductPriceInfo-BwwVE7QQ.js";import Xe from"./ProductMaterialInfo-BhlTbQ8N.js";import Ze from"./ProductBomInfo-WXL-4uIh.js";import et from"./ProductParamsInfo-Cmdpnzcx.js";import tt from"./ProductAttributesInfo-DhnWRjzO.js";import"./attributeGroup-DT63RTG0.js";import"./attributeGroupAttributeValue-BHir5xz_.js";const lt={class:"cpq-container"},at={class:"cpq-action-bar"},rt={class:"cpq-actions"},ot={class:"cpq-search-card"},it={class:"cpq-pagination"},nt={class:"cpq-dialog"},st={class:"dialog-footer"},dt={class:"el-upload__tip text-center"},ut={class:"el-upload__tip"},ct={class:"dialog-footer"},Ct={__name:"index",setup(pt){Le();const{proxy:_}=we(),C=d(!0),V=d(!0),T=d(0),B=d([]),Q=d([]),N=d(""),U=d(!1),P=d("main"),n=q({open:!1,title:"",isUploading:!1,updateSupport:0,headers:{Authorization:"Bearer "+ke()},url:"/prod-api/cpq/product/importData",selectedFile:null}),M=d([]),R=d([]),L=d([]),h=d([]),S=d([]),W=d([]),j=d([]),J=d([]),x=d(null),O=l=>{l==="attributes"&&x.value&&x.value.refresh()},t=q({productId:null,productCode:"",productName:"",productDesc:"",productStatus:"1",productVersion:"V1.0",catalogId:"",basePrice:null,priceUnit:"CNY",mainImageUrl:"",imageUrls:"",detailPageUrl:"",model3DUrl:"",manualUrl:"",installationGuideUrl:"",videoUrl:"",brandId:null,seriesId:null,productModel:"",packagingUnit:"",weight:null,dimensions:"",warrantyPeriod:null,specification:"",technicalParams:"",materialType:null,costPrice:null,minSalesPrice:null,maxSalesPrice:null,suggestedRetailPrice:null,priceValidityPeriod:null}),u=q({pageNum:1,pageSize:10,productCode:"",productName:"",productStatus:""}),X=q({productName:[{required:!0,message:"产品名称不能为空",trigger:"blur"}],productStatus:[{required:!0,message:"产品状态不能为空",trigger:"change"}],catalogId:[{required:!0,message:"所属目录不能为空",trigger:"change"}],productVersion:[{required:!0,message:"产品版本不能为空",trigger:"blur"}],priceUnit:[{required:!0,message:"价格单位不能为空",trigger:"change"}],mainImageUrl:[{required:!1,message:"请上传产品主图",trigger:"change"},{type:"url",message:"请输入有效的URL地址",trigger:"blur"}],detailPageUrl:[{type:"url",message:"请输入有效的URL地址",trigger:"blur"}],model3DUrl:[{type:"url",message:"请输入有效的URL地址",trigger:"blur"}],manualUrl:[{type:"url",message:"请输入有效的URL地址",trigger:"blur"}],installationGuideUrl:[{type:"url",message:"请输入有效的URL地址",trigger:"blur"}],videoUrl:[{type:"url",message:"请输入有效的URL地址",trigger:"blur"}],brandId:[{required:!1,message:"请选择所属品牌",trigger:"change"}],seriesId:[{required:!1,message:"请选择所属系列",trigger:"change"}],materialType:[{required:!0,message:"请选择物料类型",trigger:"change"}],productModel:[{required:!0,message:"请输入产品型号",trigger:"blur"}],packagingUnit:[{required:!1,message:"请输入包装单位",trigger:"blur"}],weight:[{required:!1,message:"请输入产品重量",trigger:"blur"},{type:"number",min:0,message:"产品重量必须大于等于0",trigger:"blur"}],dimensions:[{required:!1,message:"请输入产品尺寸",trigger:"blur"}]}),y=async()=>{C.value=!0;try{const l=await $e(u);B.value=l.rows,T.value=l.total,C.value=!1}catch{C.value=!1,m.error("获取产品列表失败")}},w=()=>{u.pageNum=1,y()},Z=()=>{u.productCode="",u.productName="",u.productStatus="",w()},ee=()=>{V.value=!V.value},te=()=>{t.productId=null,t.productCode="",t.productName="",t.productDesc="",t.productStatus="1",t.productVersion="V1.0",t.catalogId="",t.basePrice=null,t.priceUnit="CNY",t.mainImageUrl="",t.imageUrls="",t.detailPageUrl="",t.model3DUrl="",t.manualUrl="",t.installationGuideUrl="",t.videoUrl="",t.brandId=null,t.seriesId=null,t.materialType=null,t.productModel="",t.packagingUnit="",t.weight=null,t.dimensions="",t.warrantyPeriod=null,t.specification="",t.technicalParams="",t.costPrice=null,t.minSalesPrice=null,t.maxSalesPrice=null,t.suggestedRetailPrice=null,t.priceValidityPeriod=null,W.value=[],j.value=[],J.value=[],h.value=[],S.value=[],N.value="新增产品",P.value="main",U.value=!0},le=l=>{t.productId=l.productId,t.productCode=l.productCode,t.productName=l.productName,t.productDesc=l.productDesc||"",t.productStatus=l.productStatus,t.productVersion=l.productVersion||"V1.0",t.catalogId=l.catalogId,t.basePrice=l.basePrice,t.priceUnit=l.priceUnit||"CNY",t.mainImageUrl=l.mainImageUrl||"",t.imageUrls=l.imageUrls||"",t.detailPageUrl=l.detailPageUrl||"",t.model3DUrl=l.model3DUrl||"",t.manualUrl=l.manualUrl||"",t.installationGuideUrl=l.installationGuideUrl||"",t.videoUrl=l.videoUrl||"",t.brandId=l.brandId||null,t.seriesId=l.seriesId||null,t.materialType=l.materialType||null,t.productModel=l.productModel||"",t.packagingUnit=l.packagingUnit||"",t.weight=l.weight||null,t.dimensions=l.dimensions||"",t.warrantyPeriod=l.warrantyPeriod||null,t.specification=l.specification||"",t.technicalParams=l.technicalParams||"",t.costPrice=l.costPrice||null,t.minSalesPrice=l.minSalesPrice||null,t.maxSalesPrice=l.maxSalesPrice||null,t.suggestedRetailPrice=l.suggestedRetailPrice||null,t.priceValidityPeriod=l.priceValidityPeriod||null,h.value=l.bomList||[],S.value=l.paramList||[],N.value="修改产品",U.value=!0},ae=async l=>{await Ae.confirm("确定要删除该产品吗？","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});try{await ze(l.productId),m.success("删除成功"),y()}catch{m.error("删除失败")}},re=()=>{_.download("cpq/product/export",{...u},`product_${new Date().getTime()}.xlsx`)},oe=()=>{n.title="产品导入",n.open=!0},ie=()=>{_.download("cpq/product/importTemplate",{},`product_template_${new Date().getTime()}.xlsx`)},ne=(l,e,i)=>{n.isUploading=!0},se=(l,e)=>{n.selectedFile=l},de=(l,e)=>{n.selectedFile=null},ue=(l,e)=>{n.open=!1,n.isUploading=!1,_.$refs.uploadRef.handleRemove(e),_.$alert("<div style='overflow: auto;overflow-x: hidden;max-height: 70vh;padding: 10px 20px 0;'>"+l.msg+"</div>","导入结果",{dangerouslyUseHTMLString:!0}),y()},ce=()=>{if(!n.selectedFile||n.selectedFile.length===0||!n.selectedFile.name.toLowerCase().endsWith(".xls")&&!n.selectedFile.name.toLowerCase().endsWith(".xlsx")){_.$modal.msgError("请选择后缀为 “xls”或“xlsx”的文件。");return}_.$refs.uploadRef.submit()},pe=async()=>{const l=k.value;if(!l){console.error("表单ref不存在");return}try{await l.validate();let e;t.productId?(e=await Ge(t),m.success("修改成功"),t.catalogId&&(await H(t.productId),P.value==="attributes"&&await E())):(e=await Ke(t),e.data&&(t.productId=e.data),m.success("新增成功"),t.catalogId&&t.productId&&(await H(t.productId),P.value==="attributes"&&productAttributes.value.length>0&&await E())),U.value=!1,y()}catch(e){console.error("操作失败:",e),e===!1?m.error("表单验证失败，请检查填写内容"):m.error("操作失败："+(e.message||"未知错误"))}},me=()=>{U.value=!1,k.value&&k.value.resetFields(),h.value=[],S.value=[]},ge=async()=>{try{const l=await He();M.value=l.data}catch{m.error("获取品牌列表失败")}},fe=async(l=null)=>{try{let e;l?e=await Qe(l):e=await We(),R.value=e.data||[]}catch{m.error("获取系列列表失败"),R.value=[]}},be=l=>{const e=[],i={};l.forEach(s=>{i[s.catalogId]={...s,children:[]}}),l.forEach(s=>{const b=s.parentId||0;b===0?e.push(i[s.catalogId]):i[b]&&i[b].children.push(i[s.catalogId])});const f=s=>{s.children&&s.children.length>0&&(s.children.sort((b,D)=>(b.catalogSort||0)-(D.catalogSort||0)),s.children.forEach(b=>f(b)))};return e.forEach(s=>f(s)),e},ve=async()=>{try{const l=await je();l&&l.code===200&&l.rows?L.value=be(l.rows):L.value=[]}catch(l){console.error("获取目录树失败:",l),L.value=[],m.error("获取目录树失败: "+(l.message||"未知错误"))}},E=async()=>{if(!t.productId){m.warning("请先保存产品基本信息");return}if(!x.value){m.warning("产品属性组件未加载完成");return}const l=x.value.getProductAttributes();if(l.length===0){m.warning("没有需要保存的产品属性");return}try{const e=l.map(f=>({relationId:f.relationId,productId:t.productId,attributeId:f.attribute.attributeId,catalogRelationId:f.relationId,attributeValue:f.attributeValue})),i=await Ye(e);i.code===200?m.success("产品属性保存成功"):m.error("产品属性保存失败："+i.msg)}catch(e){console.error("保存产品属性失败:",e),m.error("产品属性保存失败："+(e.message||"未知错误"))}},k=d(null);return qe(()=>t.brandId,(l,e)=>{l!==e&&(t.seriesId=null,fe(l))}),Te(async()=>{Ne(),await Promise.all([ge(),ve()]),y()}),(l,e)=>{const i=c("el-button"),f=c("el-input"),s=c("el-form-item"),b=c("el-option"),D=c("el-select"),A=c("el-form"),v=c("el-table-column"),_e=c("el-tag"),Ue=c("el-table"),ye=c("pagination"),I=c("el-tab-pane"),Ie=c("el-tabs"),$=c("el-dialog"),Pe=c("el-icon"),he=c("el-checkbox"),Se=c("el-link"),xe=c("el-upload"),Ce=Re("loading");return z(),De(Ee,null,[g("div",lt,[e[25]||(e[25]=g("div",{class:"cpq-page-title"}," 产品管理 ",-1)),g("div",at,[g("div",rt,[a(i,{type:"primary",icon:"Plus",onClick:te},{default:r(()=>e[15]||(e[15]=[p(" 新增产品 ")])),_:1,__:[15]}),a(i,{type:"danger",icon:"Delete",disabled:Q.value},{default:r(()=>e[16]||(e[16]=[p(" 批量删除 ")])),_:1,__:[16]},8,["disabled"]),a(i,{type:"warning",icon:"Download",onClick:re},{default:r(()=>e[17]||(e[17]=[p(" 导出 ")])),_:1,__:[17]}),a(i,{type:"success",icon:"Upload",onClick:oe},{default:r(()=>e[18]||(e[18]=[p(" 导入 ")])),_:1,__:[18]})]),a(i,{type:"info",icon:"Search",onClick:ee},{default:r(()=>[p(G(V.value?"收起":"展开")+"搜索 ",1)]),_:1})]),F(g("div",ot,[a(A,{model:u,ref:"queryForm",inline:!0,"label-width":"80px"},{default:r(()=>[a(s,{label:"产品编码",prop:"productCode"},{default:r(()=>[a(f,{modelValue:u.productCode,"onUpdate:modelValue":e[0]||(e[0]=o=>u.productCode=o),placeholder:"请输入产品编码",clearable:"",onKeyup:Y(w,["enter"])},null,8,["modelValue"])]),_:1}),a(s,{label:"产品名称",prop:"productName"},{default:r(()=>[a(f,{modelValue:u.productName,"onUpdate:modelValue":e[1]||(e[1]=o=>u.productName=o),placeholder:"请输入产品名称",clearable:"",onKeyup:Y(w,["enter"])},null,8,["modelValue"])]),_:1}),a(s,{label:"产品状态",prop:"productStatus"},{default:r(()=>[a(D,{modelValue:u.productStatus,"onUpdate:modelValue":e[2]||(e[2]=o=>u.productStatus=o),placeholder:"请选择产品状态",clearable:""},{default:r(()=>[a(b,{label:"启用",value:"1"}),a(b,{label:"禁用",value:"0"})]),_:1},8,["modelValue"])]),_:1}),a(s,null,{default:r(()=>[a(i,{type:"primary",icon:"Search",onClick:w},{default:r(()=>e[19]||(e[19]=[p("搜索")])),_:1,__:[19]}),a(i,{icon:"RefreshRight",onClick:Z},{default:r(()=>e[20]||(e[20]=[p("重置")])),_:1,__:[20]})]),_:1})]),_:1},8,["model"])],512),[[K,V.value]]),F((z(),Fe(Ue,{data:B.value,onSelectionChange:l.handleSelectionChange,border:""},{default:r(()=>[a(v,{type:"selection",width:"55",align:"center"}),a(v,{label:"产品编码",align:"center",prop:"productCode","min-width":"120"}),a(v,{label:"产品名称",align:"left",prop:"productName","show-overflow-tooltip":!0,"min-width":"200"}),a(v,{label:"产品型号",align:"center",prop:"productModel","min-width":"150"}),a(v,{label:"产品状态",align:"center",prop:"productStatus"},{default:r(o=>[a(_e,{class:"cpq-status-tag",type:o.row.productStatus==="1"?"success":"danger",size:"small"},{default:r(()=>[p(G(o.row.productStatus==="1"?"启用":"禁用"),1)]),_:2},1032,["type"])]),_:1}),a(v,{label:"产品版本",align:"center",prop:"productVersion","min-width":"100"}),a(v,{label:"创建时间",align:"center",prop:"createTime",width:"180"}),a(v,{label:"操作",align:"center",width:"220",fixed:"right"},{default:r(o=>[a(i,{size:"small",type:"primary",icon:"Edit",onClick:Ve=>le(o.row)},{default:r(()=>e[21]||(e[21]=[p(" 修改 ")])),_:2,__:[21]},1032,["onClick"]),a(i,{size:"small",type:"danger",icon:"Delete",onClick:Ve=>ae(o.row)},{default:r(()=>e[22]||(e[22]=[p(" 删除 ")])),_:2,__:[22]},1032,["onClick"])]),_:1})]),_:1},8,["data","onSelectionChange"])),[[Ce,C.value]]),g("div",it,[F(a(ye,{total:T.value,page:u.pageNum,"onUpdate:page":e[3]||(e[3]=o=>u.pageNum=o),limit:u.pageSize,"onUpdate:limit":e[4]||(e[4]=o=>u.pageSize=o),onPagination:y},null,8,["total","page","limit"]),[[K,T.value>0]])]),g("div",nt,[a($,{title:N.value,modelValue:U.value,"onUpdate:modelValue":e[11]||(e[11]=o=>U.value=o),width:"900px","append-to-body":""},{footer:r(()=>[g("span",st,[a(i,{onClick:me},{default:r(()=>e[23]||(e[23]=[p("取消")])),_:1,__:[23]}),a(i,{type:"primary",onClick:pe},{default:r(()=>e[24]||(e[24]=[p("确定")])),_:1,__:[24]})])]),default:r(()=>[a(A,{ref_key:"formRef",ref:k,model:t,rules:X,"label-width":"100px",class:"cpq-form"},{default:r(()=>[a(Ie,{modelValue:P.value,"onUpdate:modelValue":e[10]||(e[10]=o=>P.value=o),class:"cpq-tabs",onTabChange:O},{default:r(()=>[a(I,{label:"主要信息",name:"main"},{default:r(()=>[a(Je,{form:t,"onUpdate:form":e[5]||(e[5]=o=>t=o),brandList:M.value,seriesList:R.value,catalogTree:L.value},null,8,["form","brandList","seriesList","catalogTree"])]),_:1}),a(I,{label:"价格信息",name:"price"},{default:r(()=>[a(Oe,{form:t,"onUpdate:form":e[6]||(e[6]=o=>t=o)},null,8,["form"])]),_:1}),a(I,{label:"资料信息",name:"material"},{default:r(()=>[a(Xe,{form:t,"onUpdate:form":e[7]||(e[7]=o=>t=o)},null,8,["form"])]),_:1}),a(I,{label:"BOM组成",name:"bom"},{default:r(()=>[a(Ze,{bomList:h.value,"onUpdate:bomList":e[8]||(e[8]=o=>h.value=o)},null,8,["bomList"])]),_:1}),a(I,{label:"特性参数",name:"params"},{default:r(()=>[a(et,{paramList:S.value,"onUpdate:paramList":e[9]||(e[9]=o=>S.value=o)},null,8,["paramList"])]),_:1}),a(I,{label:"产品属性",name:"attributes"},{default:r(()=>[a(tt,{ref_key:"attributesRef",ref:x,form:t},null,8,["form"])]),_:1})]),_:1},8,["modelValue"])]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue"])])]),a($,{title:n.title,modelValue:n.open,"onUpdate:modelValue":e[14]||(e[14]=o=>n.open=o),width:"400px","append-to-body":""},{footer:r(()=>[g("div",ct,[a(i,{type:"primary",onClick:ce},{default:r(()=>e[30]||(e[30]=[p("确 定")])),_:1,__:[30]}),a(i,{onClick:e[13]||(e[13]=o=>n.open=!1)},{default:r(()=>e[31]||(e[31]=[p("取 消")])),_:1,__:[31]})])]),default:r(()=>[a(xe,{ref:"uploadRef",limit:1,accept:".xlsx, .xls",headers:n.headers,action:n.url+"?updateSupport="+n.updateSupport,disabled:n.isUploading,"on-progress":ne,"on-success":ue,"on-change":se,"on-remove":de,"auto-upload":!1,drag:""},{tip:r(()=>[g("div",dt,[g("div",ut,[a(he,{modelValue:n.updateSupport,"onUpdate:modelValue":e[12]||(e[12]=o=>n.updateSupport=o)},null,8,["modelValue"]),e[26]||(e[26]=p("是否更新已经存在的产品数据 "))]),e[28]||(e[28]=g("span",null,"仅允许导入xls、xlsx格式文件。",-1)),a(Se,{type:"primary",underline:!1,style:{"font-size":"12px","vertical-align":"baseline"},onClick:ie},{default:r(()=>e[27]||(e[27]=[p("下载模板")])),_:1,__:[27]})])]),default:r(()=>[a(Pe,{class:"el-icon--upload"},{default:r(()=>[a(Be(Me))]),_:1}),e[29]||(e[29]=g("div",{class:"el-upload__text"},[p("将文件拖到此处，或"),g("em",null,"点击上传")],-1))]),_:1,__:[29]},8,["headers","action","disabled"])]),_:1},8,["title","modelValue"])],64)}}};export{Ct as default};
