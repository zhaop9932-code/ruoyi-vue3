import{aa as g}from"./index-DgigFOm-.js";const w=g("configurator",{state:()=>({currentBom:{bomId:"",bomName:"",bomCode:""},loading:{bom:!1,rules:!1,attributes:!1},configSession:{status:"draft",configuration:{}},configurationSummary:{totalNodes:0,configuredNodes:0,requiredNodes:0,errors:0},configuredNodes:[],pricing:{breakdown:[],totalPrice:0,productPrice:0,servicePrice:0,subtotal:0},validationErrors:{}}),actions:{setCurrentBom(e){this.currentBom=e||{bomId:"",bomName:"",bomCode:""}},async loadBomStructure(e){this.loading.bom=!0;try{await new Promise(t=>setTimeout(t,1e3)),console.log("加载BOM结构:",e),this.configurationSummary={totalNodes:10,configuredNodes:0,requiredNodes:5,errors:0},this.configuredNodes=[],this.pricing={breakdown:[],totalPrice:0,productPrice:0,servicePrice:0,subtotal:0}}catch(t){throw console.error("加载BOM结构失败:",t),t}finally{this.loading.bom=!1}},async saveConfigSession(){try{await new Promise(e=>setTimeout(e,800)),this.configSession.status="saved",console.log("保存配置会话成功")}catch(e){throw console.error("保存配置会话失败:",e),e}},resetConfiguration(){this.configSession.configuration={},this.configuredNodes=[],this.pricing={breakdown:[],totalPrice:0,productPrice:0,servicePrice:0,subtotal:0},this.configurationSummary.configuredNodes=0,this.configurationSummary.errors=0},completeConfiguration(){return this.configuredNodes.length===0?!1:(this.configSession.status="completed",!0)},updateNodeQuantity(e,t){console.log("更新节点数量:",e,t);const r=this.configuredNodes.findIndex(i=>i.bomStructureId===e);r!==-1&&(this.configuredNodes[r].quantity=t,this.updatePriceBreakdown(e,this.configuredNodes[r].configuration,this.configuredNodes[r]))},updateProductQuantity(e,t,r){console.log("更新产品数量:",e,t,r);const i=this.configuredNodes.findIndex(o=>o.bomStructureId===e);if(i!==-1){const o=this.configuredNodes[i];o.configuration.productQuantities||(o.configuration.productQuantities={}),o.configuration.productQuantities[t]=r,this.updatePriceBreakdown(e,o.configuration,o)}},selectNodeProduct(e,t){console.log("选择节点产品:",e,t);let r=this.configuredNodes.find(i=>i.bomStructureId===e);r||(r={bomStructureId:e,nodeName:`节点${e}`,nodeType:"0",quantity:1,configuration:{}},this.configuredNodes.push(r),this.configurationSummary.configuredNodes++),r.configuration.selectedProductId=t},selectNodeProducts(e,t){console.log("选择多个节点产品:",e,t);let r=this.configuredNodes.find(i=>i.bomStructureId===e);r||(r={bomStructureId:e,nodeName:`节点${e}`,nodeType:"0",quantity:1,configuration:{}},this.configuredNodes.push(r),this.configurationSummary.configuredNodes++),r.configuration.selectedProductIds=t},async saveNodeConfiguration(e,t){console.log("保存节点配置:",e,t);try{await new Promise(i=>setTimeout(i,500));let r=this.configuredNodes.find(i=>i.bomStructureId===e);return r||(r={bomStructureId:e,nodeName:`节点${e}`,nodeType:"0",quantity:t.quantity||1,configuration:{}},this.configuredNodes.push(r),this.configurationSummary.configuredNodes++),r.quantity=t.quantity||1,r.configuration={...r.configuration,...t},this.updatePriceBreakdown(e,t,r),!0}catch(r){return console.error("保存节点配置失败:",r),!1}},updatePriceBreakdown(e,t,r){var c,l,m,h;this.pricing.breakdown=this.pricing.breakdown.filter(s=>typeof s.nodeId!="string"||!s.nodeId.startsWith(`${e}`));let i=[];t&&(t.selectedProductId?i=[t.selectedProductId]:Array.isArray(t.selectedProductIds)&&(i=t.selectedProductIds));const o=(r==null?void 0:r.nodeType)||"0";if(i.length>0)i.forEach((s,a)=>{var y,f,N,P;let u=`产品${s}`,n="";t&&t.productDetails&&t.productDetails[s]?(u=t.productDetails[s].name||u,n=t.productDetails[s].model||""):t&&(n=t.model||t.productModel||"",n||(n=((y=t.attrs)==null?void 0:y.model)||((f=t.attrs)==null?void 0:f.productModel)||((N=t.dynamicAttrs)==null?void 0:N.model)||((P=t.dynamicAttrs)==null?void 0:P.productModel)||""));let b=n||"",d=1;t&&t.productQuantities?d=t.productQuantities[s]||t.quantity||1:d=(t==null?void 0:t.quantity)||1;const p=(t==null?void 0:t.price)||0;this.pricing.breakdown.push({nodeId:`${e}-${a}`,productName:u,specification:b,unitPrice:p,quantity:d,totalPrice:p*d})});else if(!["0","1","2"].includes(o)){let s=r.nodeName,a="";t&&(a=t.model||t.productModel||"",a||(a=((c=t.attrs)==null?void 0:c.model)||((l=t.attrs)==null?void 0:l.productModel)||((m=t.dynamicAttrs)==null?void 0:m.model)||((h=t.dynamicAttrs)==null?void 0:h.productModel)||""));let u=a||"";this.pricing.breakdown.push({nodeId:e,productName:s,specification:u,unitPrice:(t==null?void 0:t.price)||0,quantity:(t==null?void 0:t.quantity)||1,totalPrice:((t==null?void 0:t.price)||0)*((t==null?void 0:t.quantity)||1)})}this.recalculateTotalPrice()},recalculateTotalPrice(){const e=this.pricing.breakdown.reduce((t,r)=>t+r.totalPrice,0);this.pricing.totalPrice=e,this.pricing.productPrice=e,this.pricing.servicePrice=0,this.pricing.subtotal=e},async validateAttribute(e,t,r){console.log("验证属性:",e,t,r);let i=this.configuredNodes.find(o=>o.bomStructureId===e);if(i||(i={bomStructureId:e,nodeName:`节点${e}`,nodeType:"3",quantity:1,configuration:{attrs:{},dynamicAttrs:{}}},this.configuredNodes.push(i),this.configurationSummary.configuredNodes++),t.startsWith("dynamicAttrs.")){const o=t.replace("dynamicAttrs.","");i.configuration.dynamicAttrs={...i.configuration.dynamicAttrs,[o]:r}}else i.configuration.attrs={...i.configuration.attrs,[t]:r};return i.nodeType==="3"&&this.updatePriceBreakdown(e,i.configuration,i),!0},async validateNodeConfiguration(e,t){return console.log("验证节点配置:",e,t),this.validationErrors={},!0},deleteProduct(e){this.pricing.breakdown=this.pricing.breakdown.filter(t=>t.nodeId!==e),this.recalculateTotalPrice()}}});export{w as u};
