import{_ as me,r as u,g as X,h as ce,i as pe,y as fe,a as i,c as U,o as w,e as s,k as be,b as t,w as a,f as N,t as ve,N as c,ab as ge,ac as ye,ad as _e,ae as M,af as Ne,m as Y,v as Se,ag as Ie,ah as Ve,ai as xe,G as we,A as Ce,F as he,s as ke,E as g,n as Te}from"./index-kbfDsxmo.js";import Be from"./BomNodeInfoDetail-CDvHcFPx.js";import qe from"./BomNodeAttributes-DS39e60v.js";import De from"./BomNodeProducts-QYMUOPKg.js";/* empty css                                                                            */import Ee from"./BomNodeOtherInfo-ENT3dVpi.js";import{b as Ue,e as Me,f as Oe,c as Je,k as Ae}from"./bom-uPfK0qwF.js";import"./index-BKHIMnA4.js";import"./product-CAJLpTLf.js";import"./series-Bcmj16bf.js";import"./catalog-BurGbDor.js";const Fe={class:"bom-node-info"},Le={class:"node-content"},Re={class:"node-tree-container"},ze={class:"tree-header"},Pe={class:"tree-node"},Qe={class:"tree-node-action"},$e={class:"node-detail-container"},je={key:0,class:"empty-detail"},Ge={class:"dialog-footer"},Xe={__name:"BomNodeInfo",props:{bomId:{type:[String,Number],required:!0}},setup(S){const O=S,J=u(null),I=u(!1),B=u(""),d=u(null),C=u(null),A=u("nodeInfo"),y=u(!1),F=u(0),L=u(0),p=u(null),b=u(!1),h=u("新增节点"),k=u(!1),q=u(null),D=u([]),H={label:"nodeName",children:"children"},l=X({bomStructureId:null,bomId:O.bomId,nodeCode:"",nodeName:"",nodeType:"0",parentNodeId:null,quantity:1,unit:"",status:"enabled",priority:1,description:"",children:[],isRequired:"0",selectionType:"single",minSelection:0,maxSelection:0,isQuantityEditable:"1",icon:"",nodeDescription:""}),K=X({nodeName:[{required:!0,message:"节点名称不能为空",trigger:"blur"}],nodeType:[{required:!0,message:"请选择节点类型",trigger:"change"}],parentNodeId:[{required:!1,message:"请选择父节点",trigger:"change"}],quantity:[{required:!0,message:"请输入数量",trigger:"blur"},{type:"number",min:0,message:"数量不能小于0",trigger:"blur"}],status:[{required:!0,message:"请选择状态",trigger:"change"}],priority:[{required:!0,message:"请输入优先级",trigger:"blur"},{type:"number",min:1,max:10,message:"优先级必须在1-10之间",trigger:"blur"}]}),W=(o,e)=>o?e.nodeName.toLowerCase().includes(o.toLowerCase()):!0;ce(B,o=>{J.value.filter(o)});const T=async()=>{I.value=!0;try{const e=(await Ue(O.bomId)).data||[];D.value=Z(e),I.value=!1}catch(o){console.error("加载节点树失败:",o),g.error("加载节点树失败"),I.value=!1}},Z=o=>{if(!Array.isArray(o)||o.length===0)return[];const e=[],r=new Map;return o.forEach(m=>{r.set(m.bomStructureId,{...m,children:[]})}),o.forEach(m=>{const v=r.get(m.bomStructureId),V=m.parentNodeId||0;V===0||!r.has(V)?e.push(v):r.get(V).children.push(v)}),e},R=(o=D.value,e=[])=>{for(const r of o)e.push(r),r.children&&r.children.length>0&&R(r.children,e);return e},ee=async o=>{I.value=!0;try{const r=(await Ae({bomStructureId:o.bomStructureId})).rows.find(m=>m.bomStructureId===o.bomStructureId);r?(d.value={...r},console.log("selectedNode.value:",d.value),console.log("selectedNode.value.bomStructureId:",d.value.bomStructureId),C.value=JSON.parse(JSON.stringify(r))):(d.value={...o},C.value=JSON.parse(JSON.stringify(o)))}catch(e){console.error("获取节点信息失败:",e),g.error("获取节点信息失败"),d.value={...o},C.value=JSON.parse(JSON.stringify(o))}finally{I.value=!1}},te=(o,e)=>{o.preventDefault(),p.value=e,F.value=o.clientX,L.value=o.clientY,y.value=!0},z=o=>{o.target.closest(".context-menu")===null&&(y.value=!1)},le=(o,e)=>{switch(p.value=e,o){case"addChild":P();break;case"edit":d.value={...e},C.value=JSON.parse(JSON.stringify(e)),Q();break;case"delete":$(e);break}},oe=()=>{k.value=!0,j(),h.value="新增根节点",b.value=!0},P=()=>{p.value&&(j(),l.parentNodeId=p.value.bomStructureId,k.value=!1,h.value="新增子节点",y.value=!1,b.value=!0)},Q=()=>{p.value&&(Object.assign(l,{...p.value}),k.value=!p.value.parentNodeId,h.value="编辑节点",y.value=!1,b.value=!0)},ae=async()=>{p.value&&(await $(p.value),y.value=!1)},$=async o=>{try{await Te.confirm(`确定要删除节点 "${o.nodeName}" 吗？`,"警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await Je([o.bomStructureId]),await T(),g.success("节点删除成功"),d.value&&d.value.bomStructureId===o.bomStructureId&&(d.value=null)}catch(e){e!=="cancel"&&(g.error("删除失败"),console.error("删除节点失败:",e))}},ne=async()=>{try{await q.value.validate(),l.bomStructureId?(await Me(l),await T(),g.success("节点更新成功")):(await Oe(l),await T(),g.success("节点新增成功")),b.value=!1}catch(o){o!==!1&&(g.error("操作失败，请检查表单数据"),console.error("提交节点表单失败:",o))}},j=()=>{var o;l.bomStructureId=null,l.nodeCode="",l.nodeName="",l.nodeType="0",l.parentNodeId=null,l.quantity=1,l.unit="",l.status="enabled",l.priority=1,l.description="",l.isRequired="0",l.selectionType="single",l.minSelection=0,l.maxSelection=0,l.isQuantityEditable="1",l.icon="",l.nodeDescription="",(o=q.value)==null||o.resetFields()};return pe(()=>{T(),document.addEventListener("click",z)}),fe(()=>{document.removeEventListener("click",z)}),(o,e)=>{const r=i("el-input"),m=i("el-button"),v=i("el-icon"),V=i("el-empty"),x=i("el-tab-pane"),re=i("el-tabs"),f=i("el-form-item"),_=i("el-option"),E=i("el-select"),G=i("el-input-number"),de=i("el-form"),ue=i("el-dialog");return w(),U("div",Fe,[s("div",Le,[s("div",Re,[s("div",ze,[t(r,{modelValue:B.value,"onUpdate:modelValue":e[0]||(e[0]=n=>B.value=n),placeholder:"搜索节点名称","prefix-icon":"Search",clearable:"",size:"small",style:{width:"150px"}},null,8,["modelValue"]),t(m,{type:"primary",icon:"Plus",onClick:oe,size:"small",style:{"margin-left":"8px"}},{default:a(()=>e[14]||(e[14]=[N("新增节点")])),_:1,__:[14]})]),t(c(Ne),{ref_key:"nodeTree",ref:J,data:D.value,props:H,"filter-node-method":W,onNodeClick:ee,onNodeContextmenu:te,"node-key":"bomStructureId","default-expand-all":"","highlight-current":!0},{default:a(({node:n,data:se})=>[s("div",Pe,[s("span",null,ve(n.label),1),t(c(ge),{onCommand:ie=>le(ie,se)},{dropdown:a(()=>[t(c(_e),null,{default:a(()=>[t(c(M),{command:"addChild"},{default:a(()=>e[15]||(e[15]=[N("新增子节点")])),_:1,__:[15]}),t(c(M),{command:"edit"},{default:a(()=>e[16]||(e[16]=[N("编辑节点")])),_:1,__:[16]}),t(c(M),{command:"delete"},{default:a(()=>e[17]||(e[17]=[N("删除节点")])),_:1,__:[17]})]),_:1})]),default:a(()=>[s("span",Qe,[t(v,{class:"more-icon"},{default:a(()=>[t(c(ye))]),_:1})])]),_:2},1032,["onCommand"])])]),_:1},8,["data"])]),s("div",$e,[d.value?(w(),Y(re,{key:1,modelValue:A.value,"onUpdate:modelValue":e[1]||(e[1]=n=>A.value=n),type:"border-card"},{default:a(()=>[t(x,{label:"节点信息",name:"nodeInfo"},{default:a(()=>[t(Be,{"bom-id":S.bomId,"bom-structure-id":d.value.bomStructureId,"selected-node":d.value},null,8,["bom-id","bom-structure-id","selected-node"])]),_:1}),t(x,{label:"属性信息",name:"attributes"},{default:a(()=>[t(qe,{"bom-id":S.bomId,"node-name":d.value.nodeName,"bom-structure-id":d.value.bomStructureId},null,8,["bom-id","node-name","bom-structure-id"])]),_:1}),t(x,{label:"关联产品",name:"products"},{default:a(()=>[t(De,{"bom-id":S.bomId,"bom-structure-id":d.value.bomStructureId},null,8,["bom-id","bom-structure-id"])]),_:1}),t(x,{label:"其他",name:"other"},{default:a(()=>[t(Ee,{"bom-id":S.bomId,"bom-structure-id":d.value.bomStructureId},null,8,["bom-id","bom-structure-id"])]),_:1})]),_:1},8,["modelValue"])):(w(),U("div",je,[t(V,{description:"请选择或新增一个节点"})]))])]),be(s("div",{class:"context-menu",style:Ce({left:F.value+"px",top:L.value+"px"}),onClick:e[2]||(e[2]=we(()=>{},["stop"]))},[s("div",{class:"menu-item",onClick:P},[t(v,null,{default:a(()=>[t(c(Ie))]),_:1}),e[18]||(e[18]=s("span",null,"新增子节点",-1))]),s("div",{class:"menu-item",onClick:Q},[t(v,null,{default:a(()=>[t(c(Ve))]),_:1}),e[19]||(e[19]=s("span",null,"编辑节点",-1))]),s("div",{class:"menu-item",onClick:ae},[t(v,null,{default:a(()=>[t(c(xe))]),_:1}),e[20]||(e[20]=s("span",null,"删除节点",-1))])],4),[[Se,y.value]]),t(ue,{title:h.value,modelValue:b.value,"onUpdate:modelValue":e[13]||(e[13]=n=>b.value=n),width:"600px","append-to-body":""},{footer:a(()=>[s("span",Ge,[t(m,{onClick:e[12]||(e[12]=n=>b.value=!1)},{default:a(()=>e[21]||(e[21]=[N("取消")])),_:1,__:[21]}),t(m,{type:"primary",onClick:ne},{default:a(()=>e[22]||(e[22]=[N("确定")])),_:1,__:[22]})])]),default:a(()=>[t(de,{ref_key:"dialogFormRef",ref:q,model:l,rules:K,"label-width":"120px"},{default:a(()=>[t(f,{label:"节点编码",prop:"nodeCode"},{default:a(()=>[t(r,{modelValue:l.nodeCode,"onUpdate:modelValue":e[3]||(e[3]=n=>l.nodeCode=n),placeholder:"自动生成",disabled:""},null,8,["modelValue"])]),_:1}),t(f,{label:"节点名称",prop:"nodeName"},{default:a(()=>[t(r,{modelValue:l.nodeName,"onUpdate:modelValue":e[4]||(e[4]=n=>l.nodeName=n),placeholder:"请输入节点名称"},null,8,["modelValue"])]),_:1}),t(f,{label:"节点类型",prop:"nodeType"},{default:a(()=>[t(E,{modelValue:l.nodeType,"onUpdate:modelValue":e[5]||(e[5]=n=>l.nodeType=n),placeholder:"请选择节点类型"},{default:a(()=>[t(_,{label:"物料",value:"0"}),t(_,{label:"组件",value:"1"}),t(_,{label:"服务",value:"2"})]),_:1},8,["modelValue"])]),_:1}),t(f,{label:"父节点",prop:"parentNodeId"},{default:a(()=>[t(E,{modelValue:l.parentNodeId,"onUpdate:modelValue":e[6]||(e[6]=n=>l.parentNodeId=n),placeholder:"请选择父节点",disabled:k.value},{default:a(()=>[(w(!0),U(he,null,ke(R(),n=>(w(),Y(_,{key:n.bomStructureId,label:n.nodeName,value:n.bomStructureId},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),t(f,{label:"数量",prop:"quantity"},{default:a(()=>[t(G,{modelValue:l.quantity,"onUpdate:modelValue":e[7]||(e[7]=n=>l.quantity=n),min:0,step:1,placeholder:"请输入数量"},null,8,["modelValue"])]),_:1}),t(f,{label:"单位",prop:"unit"},{default:a(()=>[t(r,{modelValue:l.unit,"onUpdate:modelValue":e[8]||(e[8]=n=>l.unit=n),placeholder:"请输入单位"},null,8,["modelValue"])]),_:1}),t(f,{label:"状态",prop:"status"},{default:a(()=>[t(E,{modelValue:l.status,"onUpdate:modelValue":e[9]||(e[9]=n=>l.status=n),placeholder:"请选择状态"},{default:a(()=>[t(_,{label:"启用",value:"enabled"}),t(_,{label:"禁用",value:"disabled"})]),_:1},8,["modelValue"])]),_:1}),t(f,{label:"优先级",prop:"priority"},{default:a(()=>[t(G,{modelValue:l.priority,"onUpdate:modelValue":e[10]||(e[10]=n=>l.priority=n),min:1,max:10,step:1,placeholder:"请输入优先级"},null,8,["modelValue"])]),_:1}),t(f,{label:"描述",prop:"description"},{default:a(()=>[t(r,{modelValue:l.description,"onUpdate:modelValue":e[11]||(e[11]=n=>l.description=n),type:"textarea",placeholder:"请输入节点描述",rows:3},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["title","modelValue"])])}}},rt=me(Xe,[["__scopeId","data-v-217f3d4f"]]);export{rt as default};
