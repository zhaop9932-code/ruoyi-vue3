import{r as s,g as q,H as m,h as D,a as h,m as S,o as v,w as I,az as C,b as k,l as J,ae as P,E as w,ad as T}from"./index-DgigFOm-.js";import{l as z}from"./superBomStructure-C2O6seWy.js";const L={__name:"NodeSelector",props:{modelValue:{type:[String,Number,Array],default:()=>""},bomId:{type:[String,Number],required:!0},label:{type:String,default:"节点"},placeholder:{type:String,default:"请选择当前BOM下树状节点"},multiple:{type:Boolean,default:!1},checkStrictly:{type:Boolean,default:!0},required:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1}},emits:["update:modelValue","change"],setup(u,{emit:O}){const o=u,y=O,d=s(!1),r=s([]),n=s(""),i=s(!1),M=q(()=>{if(d.value)return"加载中...";const e=o.modelValue;return e?N(e)||e:""}),N=(e,t=r.value)=>{if(!e)return null;for(const a of t){if(a.bomStructureId==e)return a.nodeName;if(a.children&&a.children.length>0){const l=N(e,a.children);if(l)return l}}return null},_={children:"children",label:"nodeName",value:"bomStructureId"},A=s(0),g=async()=>{if(!o.bomId){w.warning("BOM ID为空，无法加载节点数据");return}d.value=!0;try{const e=await z(o.bomId);let t=[];if(Array.isArray(e)?t=e:e&&e.code===200&&Array.isArray(e.data)?t=e.data:e&&e.data?t=[e.data]:t=[],t.length>0){const a=t.map(l=>({...l,bomStructureId:l.bomStructureId||l.id||l.structureId||"",nodeName:l.nodeName||l.name||l.structureName||"未知节点"}));r.value=x(a),console.log("BOM结构树加载成功，节点数量:",r.value.length)}else r.value=[],console.warn("BOM结构树数据为空数组")}catch(e){console.error("加载BOM结构树失败:",e),w.error("加载BOM结构树失败: "+(e.message||"未知错误")),r.value=[]}finally{d.value=!1}},x=e=>{if(!e||e.length===0)return[];const t={},a=[];return e.forEach(l=>{if(!l.bomStructureId){console.warn("节点缺少bomStructureId:",l);return}t[l.bomStructureId]={...l,children:[]}}),e.forEach(l=>{l.bomStructureId&&(l.parentNodeId&&t[l.parentNodeId]?t[l.parentNodeId].children.push(t[l.bomStructureId]):a.push(t[l.bomStructureId]))}),a},E=e=>{console.log("节点选择变化:",e),n.value=e,y("update:modelValue",e),y("change",e)},B=async e=>{if(!e||r.value.length===0){n.value="";return}console.log("开始回显处理, 值:",e,"类型:",typeof e),i.value=!0;try{let t=null;const a=(f,b=r.value)=>{for(const c of b){if(c.bomStructureId==f)return c;if(c.children&&c.children.length>0){const V=a(f,c.children);if(V)return V}}return null};if(t=a(e),!t){console.warn("结构ID不在树形数据中:",e),n.value="";return}console.log("匹配到的节点:",t);const l=t.bomStructureId,p=t.nodeName;n.value="",await T(),n.value=l,console.log("回显处理完成，结构ID:",l,"类型:",typeof l,"结构名称:",p)}finally{i.value=!1}};return m(()=>o.bomId,async e=>{e&&await g()},{immediate:!0}),m(r,async e=>{console.log("树形数据已更新，节点数量:",e.length),e.length>0&&o.modelValue&&await B(o.modelValue)},{deep:!0}),m(()=>o.modelValue,async(e,t)=>{JSON.stringify(e)!==JSON.stringify(t)&&(console.log("modelValue变化:",t,"->",e),e?r.value.length===0?(console.log("树形数据未加载，开始加载"),await g()):await B(e):i.value||(n.value=""))},{immediate:!0}),m(n,e=>{!i.value&&JSON.stringify(e)!==JSON.stringify(o.modelValue)&&(console.log("localSelectedValue变化，触发emit:",e),y("update:modelValue",e))}),D(async()=>{console.log("NodeSelector组件已挂载, bomId:",o.bomId,"modelValue:",o.modelValue),await g()}),(e,t)=>{const a=h("el-tree-select"),l=h("el-icon"),p=h("el-input"),f=h("el-form-item");return v(),S(f,{label:u.label,required:u.required},{default:I(()=>[r.value.length>0&&!d.value?(v(),S(a,{modelValue:n.value,"onUpdate:modelValue":t[0]||(t[0]=b=>n.value=b),data:r.value,props:_,multiple:u.multiple,"check-strictly":u.checkStrictly,"render-after-expand":!1,placeholder:u.placeholder,disabled:u.disabled,clearable:"",filterable:"",key:A.value,style:{width:"100%"},onChange:E},null,8,["modelValue","data","multiple","check-strictly","placeholder","disabled"])):(v(),S(p,{key:1,"model-value":M.value,placeholder:d.value?"加载中...":u.placeholder,loading:d.value,disabled:!0,readonly:"",style:{width:"100%"}},C({_:2},[d.value?{name:"suffix",fn:I(()=>[k(l,{class:"is-loading"},{default:I(()=>[k(J(P))]),_:1})]),key:"0"}:void 0]),1032,["model-value","placeholder","loading"]))]),_:1},8,["label","required"])}}};export{L as default};
