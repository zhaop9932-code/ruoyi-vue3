import{_ as nt,B as at,u as lt,r,C as he,y as ye,D as be,g as G,h as rt,E as u,G as st,H as te,a as i,i as ut,c as I,o as b,e as c,k as oe,j as it,b as n,t as k,w as l,f,l as _,I as ct,J as dt,F as we,n as Ne,m as Ce,K as ft,L as mt,p as vt,M as pt,N as gt,O as _t,P as ht,Q as ne}from"./index-DgigFOm-.js";import{u as yt}from"./configurator-DfpJCp-f.js";import bt from"./ProductTree-BiH8oUeM.js";import wt from"./AttributeConfig-CbF9N8kH.js";import Nt from"./ConfigurationSummary-jRJAckAV.js";import Ct from"./RecommendPanel-CeSPz8-h.js";/* empty css                                                                       */import{g as It,a as kt,b as St}from"./bom-CjuVRwkz.js";import{l as Bt}from"./rule-ChqRra5H.js";import"./superBomProductRelation-c5nmns4w.js";import"./superBomDynamicAttribute-6n4Uab6m.js";const xt={class:"product-configurator"},Pt={class:"configurator-header"},Tt={class:"header-left"},Dt={class:"header-info"},Rt={class:"header-right"},Vt={class:"config-progress"},qt={class:"progress-text"},Et={class:"total-price"},At={class:"price-value"},Mt={class:"solution-item"},Ot={key:0,class:"config-wizard"},$t={class:"configurator-content"},zt={class:"panel-header"},Ft={class:"tab-label"},Ut={class:"tab-label"},Lt={key:0,class:"panel-content"},Qt={key:1,class:"panel-content"},Wt={class:"panel-header"},Gt={class:"tab-label"},Ht={class:"panel-content"},Jt={__name:"index",setup(Kt){const R=at(),V=lt(),H=yt(),Ie=r(null),ke=r(null),ae=r(null),p=r(R.params.bomId||R.query.bomId),N=r({bomId:null,bomName:"",bomCode:"",bomDesc:""}),Se=r("320px"),Be=r("380px"),$=r("tree");r("summary");const J=r(!1),K=r(0),xe=r([{title:"选择产品",description:"从产品结构树选择节点",icon:he},{title:"配置属性",description:"设置产品属性和参数",icon:ye},{title:"完成配置",description:"保存配置结果",icon:be}]),h=r(!1),g=r([]),d=r(null),m=r([]),w=r({}),q=r([]),S=r(null),z=r([]),B=r([]),F=r([]),E=r(0);r({});const A=r(!1),C=r({configName:"",configDesc:""}),Pe={configName:[{required:!0,message:"请输入配置名称",trigger:"blur"}]},X=G(()=>le(g.value)),Te=G(()=>re(g.value)),Y=G(()=>X.value===0?0:Math.round(m.value.length/X.value*100)),De=G(()=>{const e=Y.value;return e<30?"#f56c6c":e<60?"#e6a23c":e<100?"#409eff":"#67c23a"}),le=e=>{let t=0;return e.forEach(o=>{t++,o.children&&o.children.length>0&&(t+=le(o.children))}),t},re=e=>{let t=0;return e.forEach(o=>{o.isRequired==="1"&&t++,o.children&&o.children.length>0&&(t+=re(o.children))}),t},Re=e=>e.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g,","),se=async()=>{try{const e=await It(p.value);N.value=e.data||{},H.setCurrentBom({bomId:N.value.bomId,bomName:N.value.bomName,bomCode:N.value.bomCode})}catch(e){console.error("加载BOM信息失败:",e),u.error("加载BOM信息失败"),H.setCurrentBom()}},x=async(e=!1)=>{try{if(!e&&g.value.length>0)return;h.value=!0;const o=(await kt(p.value)).data||[];if(!Z(g.value,o)&&(g.value=o,ue(g.value),Ve(),d.value&&(ee(g.value,d.value.bomStructureId)||(d.value=null)),m.value=m.value.filter(a=>ee(g.value,a.bomStructureId)!==null),o.length>0&&!d.value)){const a=o[0];console.log("自动选中第一个节点:",a),j(a)}}catch(t){console.error("加载BOM结构失败:",t),u.error("加载BOM结构失败")}finally{h.value=!1}},Z=(e,t)=>{if(e===t)return!0;if(e==null||t==null||typeof e!=typeof t)return!1;if(Array.isArray(e)&&Array.isArray(t)){if(e.length!==t.length)return!1;for(let o=0;o<e.length;o++)if(!Z(e[o],t[o]))return!1;return!0}if(typeof e=="object"&&typeof t=="object"){const o=Object.keys(e),a=Object.keys(t);if(o.length!==a.length)return!1;for(const T of o)if(!a.includes(T)||!Z(e[T],t[T]))return!1;return!0}return!1},Ve=()=>{};let P=null;const qe=()=>{P&&clearInterval(P),P=setInterval(async()=>{await x(!0)},6e4)},Ee=()=>{P&&(clearInterval(P),P=null)},ue=e=>{e.forEach(t=>{t.status="pending",t.isVisible=!0,t.isDisabled=!1,t.children&&t.children.length>0&&ue(t.children)})},ie=async()=>{try{const e=await St(p.value);q.value=e.data||[],q.value.length>0&&(S.value=q.value[0],await ce(S.value.solutionId))}catch(e){console.error("加载方案列表失败:",e)}},ce=async e=>{try{h.value=!0,u.success("方案加载成功")}catch(t){console.error("应用方案失败:",t),u.error("应用方案失败")}finally{h.value=!1}},Ae=async e=>{if(e==="custom"){S.value=null;return}const t=q.value.find(o=>o.solutionId===e);t&&(S.value=t,await ce())},Me=e=>{console.log("左侧标签页切换:",e.paneName)},j=e=>{console.log("节点被点击:",e),d.value=e,J.value&&(K.value=1),console.log("selectedNode已更新:",d.value)},Oe=e=>{w.value={...w.value,[d.value.bomStructureId]:e},de(),fe()},$e=e=>{d.value&&(d.value.status="configured",d.value.configuration=e,m.value.find(t=>t.bomStructureId===d.value.bomStructureId)||m.value.push({...d.value,configuration:e}),J.value&&(K.value=2),u.success("配置保存成功"),setTimeout(()=>{d.value=null},500))},ze=e=>{ne.confirm("应用推荐配置将覆盖当前配置，是否继续？","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{w.value=e,u.success("推荐配置已应用"),x()}).catch(()=>{})},de=async()=>{try{const t=(await Bt({bomId:p.value})).rows||[];z.value=[],B.value=[],t.forEach(o=>{const a=Fe(o,w.value);z.value.push(a),a.passed||B.value.push({nodeId:a.nodeId,ruleName:o.ruleName,message:a.message})}),Ue()}catch(e){console.error("验证配置失败:",e)}},Fe=(e,t)=>({ruleId:e.ruleId,ruleName:e.ruleName,passed:!0,message:"",nodeId:null}),Ue=()=>{const e=new Set(B.value.map(o=>o.nodeId)),t=o=>{o.forEach(a=>{e.has(a.bomStructureId)?a.status="error":a.status==="error"&&!e.has(a.bomStructureId)&&(a.status=a.configuration?"configured":"pending"),a.children&&a.children.length>0&&t(a.children)})};t(g.value)},ee=(e,t)=>{for(const o of e){if(o.bomStructureId===t)return o;if(o.children&&o.children.length>0){const a=ee(o.children,t);if(a)return a}}return null},Le=e=>{j(e)},fe=()=>{let e=[],t=0;m.value.forEach(o=>{if(o.configuration){const a=o.nodeType||"0";if(o.configuration.selectedProductId||Array.isArray(o.configuration.selectedProductIds)&&o.configuration.selectedProductIds.length>0)(Array.isArray(o.configuration.selectedProductIds)?o.configuration.selectedProductIds:[o.configuration.selectedProductId]).forEach((v,D)=>{var M;if(o.configuration.price){const U=((M=o.configuration.productQuantities)==null?void 0:M[v])||o.configuration.quantity||1,L=o.configuration.price,Q=U*L,O=(o.configuration.productDetails||{})[v]||{};e.push({nodeId:`${o.bomStructureId}-${D}`,productName:O.name||o.configuration.productName||`产品${v}`,specification:O.model||"",quantity:U,unitPrice:L,subtotal:Q}),t+=Q}});else if(!["0","1","2"].includes(a)&&o.configuration.price){const y=o.configuration.quantity||1,v=o.configuration.price,D=y*v;e.push({nodeId:o.bomStructureId,productName:o.nodeName,specification:"",quantity:y,unitPrice:v,subtotal:D}),t+=D}}}),F.value=e,E.value=t},Qe=async()=>{if(m.value.length>0)try{await ne.confirm("当前配置尚未保存，确定要返回吗？","提示",{confirmButtonText:"保存并返回",cancelButtonText:"直接返回",distinguishCancelAndClose:!0,type:"warning"}),await me(),V.push({path:"/userselect/configurator/list"})}catch(e){e==="cancel"&&V.push({path:"/userselect/configurator/list"})}else V.push({path:"/userselect/configurator/list"})},We=async()=>{await x(),d.value=null,m.value=[],w.value={},z.value=[],B.value=[]},Ge=async()=>{try{await ne.confirm("确定要重置所有配置吗？此操作不可撤销。","警告",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),H.resetConfiguration(),d.value=null,m.value=[],w.value={},z.value=[],B.value=[],F.value=[],E.value=0,await x(!0),u.success("配置已重置")}catch(e){e!=="cancel"&&(console.error("重置配置失败:",e),u.error("重置配置失败"))}},He=async()=>{try{if(m.value.length===0){u.warning("请先配置产品后再生成报价单");return}h.value=!0,await new Promise(t=>setTimeout(t,1e3));const e={bomId:p.value,bomName:N.value.bomName,totalPrice:E.value,pricingBreakdown:F.value,configuredNodes:m.value,generateTime:new Date().toISOString()};console.log("生成报价单:",e),u.success("报价单生成成功")}catch(e){console.error("生成报价单失败:",e),u.error("生成报价单失败")}finally{h.value=!1}},Je=async()=>{try{if(m.value.length===0){u.warning("请先配置产品后再分享");return}h.value=!0,await new Promise(t=>setTimeout(t,800));const e=`${window.location.origin}${window.location.pathname}?bomId=${p.value}&shareToken=mock-share-token-123456`;await navigator.clipboard.writeText(e),u.success("分享链接已复制到剪贴板")}catch(e){console.error("分享配置失败:",e),u.error("分享配置失败")}finally{h.value=!1}},Ke=async()=>{const e=Xe();if(e.length>0){u.warning(`还有${e.length}个必选节点未配置`);return}if(await de(),B.value.length>0){u.error("配置不符合规则要求，请检查");return}A.value=!0},Xe=()=>{const e=[],t=o=>{o.forEach(a=>{a.isRequired==="1"&&a.status!=="configured"&&e.push(a),a.children&&a.children.length>0&&t(a.children)})};return t(g.value),e},me=async()=>{try{await ae.value.validate(),h.value=!0;const e={bomId:p.value,configName:C.value.configName,configDesc:C.value.configDesc,configuration:w.value,configuredNodes:m.value,totalPrice:E.value,pricingBreakdown:F.value};u.success("配置保存成功"),A.value=!1}catch(e){e!==!1&&(console.error("保存配置失败:",e),u.error("保存配置失败"))}finally{h.value=!1}};return rt(async()=>{if(console.log("初始化开始"),console.log("路由参数:",R.params),console.log("查询参数:",R.query),console.log("初始bomId:",p.value),!p.value){u.error("缺少BOM ID参数"),V.push({path:"/userselect/configurator/list"});return}try{await Promise.all([se(),x(),ie()]),console.log("初始化完成"),console.log("treeData:",g.value),console.log("selectedNode:",d.value),qe()}catch(e){console.error("初始化失败:",e),u.error("初始化失败"),setTimeout(()=>{V.push({path:"/userselect/configurator/list"})},2e3)}}),st(()=>{Ee()}),te(()=>p.value,async e=>{if(e)try{await Promise.all([se(),x(!0),ie()])}catch(t){console.error("切换BOM失败:",t),u.error("切换BOM失败")}}),te(()=>R.params.bomId,e=>{e&&e!==p.value&&(p.value=e)}),te(()=>m.value.length,()=>{fe()},{deep:!0}),(e,t)=>{const o=i("el-breadcrumb-item"),a=i("el-breadcrumb"),T=i("el-progress"),y=i("el-icon"),v=i("el-button"),D=i("el-tag"),M=i("el-dropdown-item"),U=i("el-dropdown-menu"),L=i("el-dropdown"),Q=i("el-step"),ve=i("el-steps"),O=i("el-tab-pane"),Ye=i("el-tabs"),pe=i("el-aside"),Ze=i("el-main"),je=i("el-container"),ge=i("el-input"),_e=i("el-form-item"),et=i("el-form"),tt=i("el-dialog"),ot=ut("loading");return b(),I("div",xt,[c("div",Pt,[c("div",Tt,[c("div",Dt,[c("h2",null,k(N.value.bomName||"产品配置器"),1),n(a,{separator:"/"},{default:l(()=>[n(o,{to:{path:"/userselect/configurator/list"}},{default:l(()=>t[5]||(t[5]=[f("产品配置器")])),_:1,__:[5]}),n(o,null,{default:l(()=>[f(k(N.value.bomName||"配置详情"),1)]),_:1})]),_:1})])]),c("div",Rt,[c("div",Vt,[n(T,{percentage:Y.value,color:De.value,"show-text":!1,style:{width:"120px"}},null,8,["percentage","color"]),c("span",qt,k(Y.value)+"%",1)]),c("div",Et,[t[6]||(t[6]=c("span",{class:"price-label"},"总价:",-1)),c("span",At,"¥"+k(Re(E.value)),1)]),n(L,{onCommand:Ae,trigger:"click"},{dropdown:l(()=>[n(U,null,{default:l(()=>[(b(!0),I(we,null,Ne(q.value,s=>{var W;return b(),Ce(M,{key:s.solutionId,command:s.solutionId,disabled:s.solutionId===((W=S.value)==null?void 0:W.solutionId)},{default:l(()=>[c("div",Mt,[c("span",null,k(s.solutionName),1),n(D,{size:"small",type:"info"},{default:l(()=>[f(k(s.scenarioName),1)]),_:2},1024)])]),_:2},1032,["command","disabled"])}),128)),n(M,{divided:"",command:"custom"},{default:l(()=>[n(y,null,{default:l(()=>[n(_(ft))]),_:1}),t[7]||(t[7]=f(" 自定义方案 "))]),_:1,__:[7]})]),_:1})]),default:l(()=>[n(v,{icon:_(ct)},{default:l(()=>{var s;return[f(k(((s=S.value)==null?void 0:s.solutionName)||"选择方案")+" ",1),n(y,{class:"el-icon--right"},{default:l(()=>[n(_(dt))]),_:1})]}),_:1},8,["icon"])]),_:1}),n(v,{icon:_(mt),onClick:We},{default:l(()=>t[8]||(t[8]=[f("刷新")])),_:1,__:[8]},8,["icon"]),n(v,{icon:_(ye),onClick:Ge},{default:l(()=>t[9]||(t[9]=[f("重置")])),_:1,__:[9]},8,["icon"]),n(v,{icon:_(vt),onClick:He},{default:l(()=>t[10]||(t[10]=[f("生成报价单")])),_:1,__:[10]},8,["icon"]),n(v,{icon:_(pt),onClick:Je},{default:l(()=>t[11]||(t[11]=[f("分享配置")])),_:1,__:[11]},8,["icon"]),n(v,{type:"primary",icon:_(be),onClick:Ke},{default:l(()=>t[12]||(t[12]=[f("完成配置")])),_:1,__:[12]},8,["icon"]),n(v,{icon:_(gt),onClick:Qe},{default:l(()=>t[13]||(t[13]=[f("返回列表")])),_:1,__:[13]},8,["icon"])])]),J.value?(b(),I("div",Ot,[n(ve,{active:K.value,"align-center":"","finish-status":"success"},{default:l(()=>[(b(!0),I(we,null,Ne(xe.value,(s,W)=>(b(),Ce(Q,{key:W,title:s.title,description:s.description,icon:s.icon},null,8,["title","description","icon"]))),128))]),_:1},8,["active"])])):oe("",!0),it((b(),I("div",$t,[n(je,null,{default:l(()=>[n(pe,{width:Se.value,class:"tree-panel"},{default:l(()=>[c("div",zt,[n(Ye,{modelValue:$.value,"onUpdate:modelValue":t[0]||(t[0]=s=>$.value=s),onTabClick:Me},{default:l(()=>[n(O,{label:"产品结构",name:"tree"},{label:l(()=>[c("span",Ft,[n(y,null,{default:l(()=>[n(_(he))]),_:1}),t[14]||(t[14]=f(" 产品结构 "))])]),_:1}),n(O,{label:"推荐方案",name:"recommend"},{label:l(()=>[c("span",Ut,[n(y,null,{default:l(()=>[n(_(_t))]),_:1}),t[15]||(t[15]=f(" 智能推荐 "))])]),_:1})]),_:1},8,["modelValue"])]),$.value==="tree"?(b(),I("div",Lt,[n(bt,{ref_key:"productTreeRef",ref:Ie,"bom-id":p.value,"tree-data":g.value,"configured-nodes":m.value,onNodeSelect:j},null,8,["bom-id","tree-data","configured-nodes"])])):oe("",!0),$.value==="recommend"?(b(),I("div",Qt,[n(Ct,{"bom-id":p.value,"current-config":w.value,onApplyRecommend:ze},null,8,["bom-id","current-config"])])):oe("",!0)]),_:1},8,["width"]),n(Ze,{class:"config-panel"},{default:l(()=>[n(wt,{ref_key:"attributeConfigRef",ref:ke,"current-node":d.value,"bom-id":p.value,onConfigChange:Oe,onConfigConfirm:$e},null,8,["current-node","bom-id"])]),_:1}),n(pe,{width:Be.value,class:"summary-panel"},{default:l(()=>[c("div",Wt,[c("div",Gt,[t[16]||(t[16]=f("     ")),n(y,null,{default:l(()=>[n(_(ht))]),_:1}),t[17]||(t[17]=f(" 配置摘要 "))])]),c("div",Ht,[n(Nt,{"configured-nodes":m.value,"total-nodes":X.value,"required-nodes":Te.value,onNodeClick:Le},null,8,["configured-nodes","total-nodes","required-nodes"])])]),_:1},8,["width"])]),_:1})])),[[ot,h.value]]),n(tt,{modelValue:A.value,"onUpdate:modelValue":t[4]||(t[4]=s=>A.value=s),title:"保存配置",width:"500px","append-to-body":""},{footer:l(()=>[n(v,{onClick:t[3]||(t[3]=s=>A.value=!1)},{default:l(()=>t[18]||(t[18]=[f("取消")])),_:1,__:[18]}),n(v,{type:"primary",onClick:me},{default:l(()=>t[19]||(t[19]=[f("保存")])),_:1,__:[19]})]),default:l(()=>[n(et,{ref_key:"saveFormRef",ref:ae,model:C.value,rules:Pe,"label-width":"100px"},{default:l(()=>[n(_e,{label:"配置名称",prop:"configName"},{default:l(()=>[n(ge,{modelValue:C.value.configName,"onUpdate:modelValue":t[1]||(t[1]=s=>C.value.configName=s),placeholder:"请输入配置名称"},null,8,["modelValue"])]),_:1}),n(_e,{label:"配置描述",prop:"configDesc"},{default:l(()=>[n(ge,{modelValue:C.value.configDesc,"onUpdate:modelValue":t[2]||(t[2]=s=>C.value.configDesc=s),type:"textarea",rows:3,placeholder:"请输入配置描述"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},so=nt(Jt,[["__scopeId","data-v-fd695087"]]);export{so as default};
