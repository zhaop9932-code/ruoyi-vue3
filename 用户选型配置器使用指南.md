# ç”¨æˆ·é€‰å‹é…ç½®å™¨ä½¿ç”¨æŒ‡å—

## ğŸ“š ç›®å½•

1. [åŠŸèƒ½æ¦‚è¿°](#åŠŸèƒ½æ¦‚è¿°)
2. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
3. [æ ¸å¿ƒåŠŸèƒ½è¯´æ˜](#æ ¸å¿ƒåŠŸèƒ½è¯´æ˜)
4. [æŠ€æœ¯å®ç°äº®ç‚¹](#æŠ€æœ¯å®ç°äº®ç‚¹)
5. [åç«¯æ¥å£è¦æ±‚](#åç«¯æ¥å£è¦æ±‚)
6. [å¼€å‘è°ƒè¯•](#å¼€å‘è°ƒè¯•)
7. [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## åŠŸèƒ½æ¦‚è¿°

ç”¨æˆ·é€‰å‹é…ç½®å™¨æ˜¯ä¸€ä¸ªåŸºäºè¶…çº§BOMè§„åˆ™é…ç½®çš„å‰ç«¯CPQï¼ˆConfigure, Price, Quoteï¼‰äº§å“é…ç½®å·¥å…·ï¼Œæä¾›ä»¥ä¸‹æ ¸å¿ƒåŠŸèƒ½ï¼š

### âœ¨ ä¸»è¦ç‰¹æ€§

- **å¯è§†åŒ–äº§å“ç»“æ„æ ‘**ï¼šæ ‘å½¢å±•ç¤ºBOMå±‚çº§ç»“æ„ï¼Œæ”¯æŒèŠ‚ç‚¹çŠ¶æ€æ ‡è¯†
- **åŠ¨æ€å±æ€§é…ç½®**ï¼šæ”¯æŒ12+ç§è¾“å…¥ç±»å‹çš„å±æ€§é…ç½®
- **å®æ—¶è§„åˆ™éªŒè¯**ï¼šå‰ç«¯è§„åˆ™å¼•æ“å®æ—¶æ ¡éªŒé…ç½®åˆè§„æ€§
- **æ™ºèƒ½çº¦æŸå¤„ç†**ï¼šè‡ªåŠ¨å¤„ç†èŠ‚ç‚¹ä¾èµ–ã€æ•°é‡çº¦æŸã€äº’æ–¥å…³ç³»
- **å®æ—¶ä»·æ ¼è®¡ç®—**ï¼šé…ç½®å˜æ›´è‡ªåŠ¨è§¦å‘ä»·æ ¼é‡æ–°è®¡ç®—
- **é…ç½®ä¼šè¯ç®¡ç†**ï¼šæ”¯æŒä¿å­˜ã€åŠ è½½ã€åˆ†äº«é…ç½®æ–¹æ¡ˆ
- **é…ç½®æ‘˜è¦é¢æ¿**ï¼šå®æ—¶å±•ç¤ºé…ç½®è¿›åº¦å’Œä»·æ ¼æ˜ç»†

---

## å¿«é€Ÿå¼€å§‹

### 1. æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ views/cpq/configurator/              # é…ç½®å™¨ä¸»ç›®å½•
â”‚   â”œâ”€â”€ list.vue                         # é…ç½®é€‰å‹åˆ—è¡¨é¡µï¼ˆå…¥å£ï¼‰
â”‚   â”œâ”€â”€ index.vue                        # é…ç½®å™¨è¯¦æƒ…é¡µ
â”‚   â””â”€â”€ components/
â”‚       â”œâ”€â”€ ProductTree.vue              # äº§å“ç»“æ„æ ‘ç»„ä»¶
â”‚       â”œâ”€â”€ AttributeConfig.vue          # å±æ€§é…ç½®ç»„ä»¶
â”‚       â””â”€â”€ ConfigurationSummary.vue     # é…ç½®æ‘˜è¦ç»„ä»¶
â”œâ”€â”€ store/modules/
â”‚   â””â”€â”€ configurator.js                  # Pinia StoreçŠ¶æ€ç®¡ç†
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ ruleEngine.js                    # å‰ç«¯è§„åˆ™å¼•æ“
â””â”€â”€ api/cpq/
    â””â”€â”€ configSession.js                 # é…ç½®ä¼šè¯API
```

### 2. è·¯ç”±é…ç½®

å·²åœ¨ `src/router/index.js` ä¸­é…ç½®ä¸º**é™æ€è·¯ç”±**ï¼ˆä¸ä¾èµ–åç«¯é…ç½®ï¼‰ï¼š

```javascript
// CPQç³»ç»Ÿ - äº§å“é…ç½®å™¨ï¼ˆé™æ€è·¯ç”±ï¼‰
{
  path: '/cpq',
  component: () => import('@/layout/index.vue'),
  redirect: '/cpq/configurator',
  name: 'Cpq',
  meta: { title: 'CPQç³»ç»Ÿ', icon: 'shopping', alwaysShow: true },
  children: [
    {
      path: 'configurator',
      component: () => import('@/views/cpq/configurator/list.vue'),
      name: 'CpqConfigurator',
      meta: { title: 'äº§å“é…ç½®å™¨', icon: 'setting' }
    },
    {
      path: 'configurator/:bomId',
      component: () => import('@/views/cpq/configurator/index.vue'),
      name: 'CpqConfiguratorDetail',
      meta: { title: 'é…ç½®è¯¦æƒ…', icon: 'setting' },
      hidden: true
    }
  ]
}
```

**æ³¨æ„ï¼š** æœ¬é¡¹ç›®ä½¿ç”¨åŠ¨æ€è·¯ç”±æœºåˆ¶ï¼Œä½†ä¸ºäº†å¿«é€Ÿä½¿ç”¨ï¼Œå°†é…ç½®å™¨è·¯ç”±é…ç½®ä¸ºé™æ€è·¯ç”±ã€‚å¦‚éœ€æƒé™æ§åˆ¶ï¼Œå¯åç»­è¿ç§»åˆ°åŠ¨æ€è·¯ç”±ã€‚

### 3. ä½¿ç”¨æµç¨‹

#### æ­¥éª¤1ï¼šè®¿é—®é…ç½®é€‰å‹åˆ—è¡¨é¡µ

**æ–¹å¼1ï¼šä»èœå•è®¿é—®ï¼ˆæ¨èï¼‰**
- ç‚¹å‡»å·¦ä¾§èœå•ï¼š`CPQç³»ç»Ÿ` â†’ `äº§å“é…ç½®å™¨`
- ç³»ç»Ÿè‡ªåŠ¨å¯¼èˆªåˆ°é…ç½®é€‰å‹åˆ—è¡¨é¡µ

**æ–¹å¼2ï¼šç›´æ¥è®¿é—®URL**
- è®¿é—®åœ°å€ï¼š`http://your-domain/cpq/configurator`

**é¡µé¢åŠŸèƒ½ï¼š** å±•ç¤ºæ‰€æœ‰å¯ç”¨çš„BOMæ–¹æ¡ˆï¼ˆå¡ç‰‡å½¢å¼ï¼‰
- æ”¯æŒæœç´¢å’Œåˆ†é¡µ
- æ˜¾ç¤ºBOMåŸºæœ¬ä¿¡æ¯ã€ç»Ÿè®¡æ•°æ®

#### æ­¥éª¤2ï¼šé€‰æ‹©BOMæ–¹æ¡ˆ

ç‚¹å‡»"å¼€å§‹é…ç½®"æŒ‰é’®ï¼Œè·³è½¬åˆ°é…ç½®è¯¦æƒ…é¡µï¼š
`http://your-domain/cpq/configurator/123` (123ä¸ºbomId)

#### æ­¥éª¤3ï¼šè¿›è¡Œäº§å“é…ç½®

- å·¦ä¾§ï¼šäº§å“ç»“æ„æ ‘
- ä¸­é—´ï¼šå±æ€§é…ç½®é¢æ¿
- å³ä¾§ï¼šé…ç½®æ‘˜è¦

#### æ­¥éª¤4ï¼šå®Œæˆé…ç½®

- ä¿å­˜é…ç½®ï¼šä¿å­˜å½“å‰é…ç½®çŠ¶æ€
- å®Œæˆé…ç½®ï¼šæäº¤æœ€ç»ˆé…ç½®æ–¹æ¡ˆ
- è¿”å›åˆ—è¡¨ï¼šè¿”å›é…ç½®é€‰å‹åˆ—è¡¨é¡µ

### 4. ä½¿ç”¨ç¤ºä¾‹

#### 4.1 ä»èœå•è®¿é—®ï¼ˆæ¨èï¼‰

ç‚¹å‡»å·¦ä¾§èœå• **CPQç³»ç»Ÿ â†’ äº§å“é…ç½®å™¨**ï¼Œè¿›å…¥é…ç½®é€‰å‹åˆ—è¡¨é¡µ

#### 4.2 ç¼–ç¨‹æ–¹å¼è·³è½¬åˆ°åˆ—è¡¨é¡µ

```vue
<script setup>
import { useRouter } from 'vue-router'

const router = useRouter()

// è·³è½¬åˆ°é…ç½®é€‰å‹åˆ—è¡¨
const goToConfiguratorList = () => {
  router.push({ name: 'CpqConfigurator' })
}
</script>
```

#### 4.3 ç¼–ç¨‹æ–¹å¼è·³è½¬åˆ°é…ç½®è¯¦æƒ…é¡µ

```vue
<script setup>
import { useRouter } from 'vue-router'

const router = useRouter()

// è·³è½¬åˆ°æŒ‡å®šBOMçš„é…ç½®é¡µé¢
const startConfiguration = (bomId, bomName) => {
  router.push({
    name: 'CpqConfiguratorDetail',
    params: { bomId },
    query: { bomName }
  })
}
</script>
```

#### 4.4 ç›´æ¥ä½¿ç”¨Store

```vue
<script setup>
import { onMounted } from 'vue'
import { useConfiguratorStore } from '@/store/modules/configurator'

const configuratorStore = useConfiguratorStore()

onMounted(async () => {
  // åŠ è½½BOMç»“æ„
  await configuratorStore.loadBomStructure(123)
  
  // è·å–é…ç½®æ‘˜è¦
  console.log(configuratorStore.configurationSummary)
  
  // ä¿å­˜é…ç½®
  await configuratorStore.saveConfigSession()
})
</script>
```

---

## æ ¸å¿ƒåŠŸèƒ½è¯´æ˜

### ğŸ“Š 1. äº§å“ç»“æ„æ ‘ï¼ˆProductTreeï¼‰

#### åŠŸèƒ½ç‰¹ç‚¹

- âœ… æ ‘å½¢å±•ç¤ºBOMå±‚çº§ç»“æ„
- âœ… èŠ‚ç‚¹çŠ¶æ€å¯è§†åŒ–ï¼ˆæœªé…ç½®ã€å·²é…ç½®ã€é”™è¯¯ã€ç¦ç”¨ï¼‰
- âœ… èŠ‚ç‚¹æœç´¢å’Œå¿«é€Ÿå®šä½
- âœ… å¿…é€‰/å¯é€‰æ ‡è¯†
- âœ… åŠ¨æ€æ˜¾ç¤º/éšè—ï¼ˆåŸºäºè§„åˆ™ï¼‰

#### èŠ‚ç‚¹çŠ¶æ€è¯´æ˜

| çŠ¶æ€ | å›¾æ ‡ | é¢œè‰² | è¯´æ˜ |
|-----|------|------|------|
| `unconfigured` | - | ç°è‰² | æœªé…ç½® |
| `configured` | âœ“ | ç»¿è‰² | å·²é…ç½® |
| `partial` | - | é»„è‰² | éƒ¨åˆ†é…ç½® |
| `error` | ! | çº¢è‰² | é…ç½®é”™è¯¯ |
| `disabled` | - | ç°è‰²é€æ˜ | ç¦ç”¨ï¼ˆä¸æ»¡è¶³çº¦æŸï¼‰ |

#### ä½¿ç”¨ç¤ºä¾‹

```vue
<ProductTree
  :bom-id="bomId"
  @node-select="handleNodeSelect"
/>

<script setup>
const handleNodeSelect = (node) => {
  console.log('é€‰ä¸­èŠ‚ç‚¹:', node)
  // nodeåŒ…å«: bomStructureId, nodeName, status, isRequiredç­‰
}
</script>
```

---

### âš™ï¸ 2. å±æ€§é…ç½®ï¼ˆAttributeConfigï¼‰

#### æ”¯æŒçš„å±æ€§ç±»å‹

| ç±»å‹ | ç»„ä»¶ | é€‚ç”¨åœºæ™¯ |
|-----|------|---------|
| `text` | el-input | æ–‡æœ¬è¾“å…¥ï¼ˆå¦‚ï¼šäº§å“åç§°ï¼‰ |
| `number` | el-input-number | æ•°å€¼è¾“å…¥ï¼ˆå¦‚ï¼šé‡é‡ã€å°ºå¯¸ï¼‰ |
| `select` | el-select | å•é€‰ä¸‹æ‹‰ï¼ˆå¦‚ï¼šé¢œè‰²ã€å‹å·ï¼‰ |
| `multi` | el-select(multiple) | å¤šé€‰ä¸‹æ‹‰ï¼ˆå¦‚ï¼šé…ä»¶é€‰æ‹©ï¼‰ |
| `radio` | el-radio-group | å•é€‰æŒ‰é’®ç»„ |
| `checkbox` | el-checkbox-group | å¤šé€‰æŒ‰é’®ç»„ |
| `date` | el-date-picker | æ—¥æœŸé€‰æ‹© |
| `datetime` | el-date-picker(datetime) | æ—¥æœŸæ—¶é—´é€‰æ‹© |
| `textarea` | el-input(textarea) | å¤šè¡Œæ–‡æœ¬ |
| `slider` | el-slider | æ»‘å—ï¼ˆå¦‚ï¼šäº®åº¦ã€éŸ³é‡ï¼‰ |
| `switch` | el-switch | å¼€å…³ï¼ˆå¦‚ï¼šæ˜¯å¦å¯ç”¨ï¼‰ |
| `color` | el-color-picker | é¢œè‰²é€‰æ‹©å™¨ |

#### å±æ€§é…ç½®æµç¨‹

```mermaid
graph LR
    A[é€‰æ‹©èŠ‚ç‚¹] --> B[åŠ è½½èŠ‚ç‚¹å±æ€§]
    B --> C[æŒ‰å±æ€§ç»„åˆ†ç»„æ˜¾ç¤º]
    C --> D[ç”¨æˆ·å¡«å†™å±æ€§å€¼]
    D --> E[å®æ—¶è§„åˆ™æ ¡éªŒ]
    E --> F[ä¿å­˜é…ç½®]
    F --> G[æ›´æ–°æ ‘çŠ¶æ€]
```

#### å±æ€§é…ç½®æ•°æ®ç»“æ„

```javascript
{
  quantity: 2,                    // æ•°é‡
  selectedProductId: 101,         // é€‰æ‹©çš„äº§å“ID
  attrs: {
    color: 'red',                 // å±æ€§ï¼šé¢œè‰²
    size: 'L',                    // å±æ€§ï¼šå°ºå¯¸
    customText: 'Hello',          // å±æ€§ï¼šè‡ªå®šä¹‰æ–‡æœ¬
    features: ['wifi', 'bt']      // å±æ€§ï¼šåŠŸèƒ½ï¼ˆå¤šé€‰ï¼‰
  }
}
```

---

### ğŸ” 3. è§„åˆ™å¼•æ“ï¼ˆRuleEngineï¼‰

#### è§„åˆ™ç±»å‹

| ç±»å‹ | ä»£ç  | è¯´æ˜ | ç¤ºä¾‹ |
|-----|------|------|------|
| éªŒè¯è§„åˆ™ | `1` | æ ¡éªŒé…ç½®åˆè§„æ€§ | é‡é‡å¿…é¡»åœ¨0-1000kgä¹‹é—´ |
| è®¡ç®—è§„åˆ™ | `2` | åŠ¨æ€è®¡ç®—å±æ€§å€¼ | æ€»ä»· = å•ä»· Ã— æ•°é‡ Ã— æŠ˜æ‰£ |
| æ¡ä»¶è§„åˆ™ | `3` | æ¡ä»¶æ§åˆ¶ | é€‰æ‹©çº¢è‰²æ—¶è‡ªåŠ¨å¯ç”¨LEDç¯ |
| è·³è½¬è§„åˆ™ | `4` | æµç¨‹è·³è½¬ | å®ŒæˆåŸºç¡€é…ç½®åè·³åˆ°é«˜çº§é…ç½® |

#### è§„åˆ™æ‰§è¡Œæµç¨‹

```javascript
// 1. åŠ è½½è§„åˆ™
RuleEngine.loadRules(rules)

// 2. è®¾ç½®ä¸Šä¸‹æ–‡
RuleEngine.setContext({
  variables: { totalPrice: 0, discount: 0.1 },
  nodes: {
    1: { attributes: { color: 'red' }, quantity: 2 }
  }
})

// 3. è¯„ä¼°æ‰€æœ‰è§„åˆ™
const result = await RuleEngine.evaluateAll()

// ç»“æœç¤ºä¾‹
{
  passed: true,
  executedRules: [1, 3, 5],
  errors: [],
  actions: [
    { actionType: 'setProperty', result: { property: 'discount', value: 0.15 } },
    { actionType: 'showMessage', result: { messageType: 'success', message: 'æ‚¨è·å¾—äº†é¢å¤–æŠ˜æ‰£' } }
  ]
}
```

#### æ¡ä»¶è¡¨è¾¾å¼ç¤ºä¾‹

```javascript
// ç®€å•æ¡ä»¶
{
  judgeType: 'nodeStaticAttr',    // åˆ¤æ–­ç±»å‹ï¼šèŠ‚ç‚¹é™æ€å±æ€§
  node: 1,                         // èŠ‚ç‚¹ID
  field: 'color',                  // å­—æ®µï¼šé¢œè‰²
  operator: '=',                   // æ“ä½œç¬¦ï¼šç­‰äº
  value: 'red',                    // å€¼ï¼šçº¢è‰²
  type: 'text'                     // ç±»å‹ï¼šæ–‡æœ¬
}

// å¤æ‚æ¡ä»¶ï¼ˆåµŒå¥—ï¼‰
{
  configType: 'complex',
  logic: 'AND',
  children: [
    { judgeType: 'variable', field: 'totalPrice', operator: '>', value: 1000 },
    { judgeType: 'nodeStaticAttr', node: 1, field: 'isVip', operator: '=', value: true }
  ]
}
```

#### çº¦æŸç±»å‹è¯´æ˜

##### 1. æ¡ä»¶çº¦æŸ

```javascript
{
  type: 'condition',
  condition: 'parent.quantity > 0'  // çˆ¶èŠ‚ç‚¹æ•°é‡å¿…é¡»å¤§äº0
}
```

##### 2. æ•°é‡çº¦æŸ

```javascript
{
  type: 'quantity',
  quantity: {
    default: 1,
    min: 1,
    max: 10,
    minExpr: 'parent.quantity * 2',  // åŠ¨æ€æœ€å°å€¼è¡¨è¾¾å¼
    maxExpr: 'parent.quantity * 5'   // åŠ¨æ€æœ€å¤§å€¼è¡¨è¾¾å¼
  }
}
```

##### 3. ä¾èµ–çº¦æŸ

```javascript
{
  type: 'dependency',
  dependency: {
    nodes: [2, 3, 4],              // ä¾èµ–èŠ‚ç‚¹IDåˆ—è¡¨
    type: 'mandatory',              // mandatory(å¿…é€‰) | exclusive(äº’æ–¥) | conditional(æ¡ä»¶)
    condition: 'node2.selected'     // æ¡ä»¶è¡¨è¾¾å¼ï¼ˆtypeä¸ºconditionalæ—¶ä½¿ç”¨ï¼‰
  }
}
```

##### 4. ç»„åˆçº¦æŸ

```javascript
{
  type: 'combination',
  combination: {
    replaceableNodes: [5, 6],       // å¯æ›¿æ¢èŠ‚ç‚¹IDåˆ—è¡¨
    condition: 'color == "red"'     // æ›¿æ¢æ¡ä»¶
  }
}
```

---

### ğŸ’° 4. ä»·æ ¼è®¡ç®—

#### è®¡ç®—è§„åˆ™

```javascript
// 1. åŸºç¡€ä»·æ ¼ = èŠ‚ç‚¹å•ä»· Ã— æ•°é‡
const basePrice = node.price * node.quantity

// 2. äº§å“ä»·æ ¼ï¼ˆå¦‚æœé€‰æ‹©äº†äº§å“ï¼‰
const productPrice = node.product.price * node.quantity

// 3. è‡ªå®šä¹‰è®¡ç®—è§„åˆ™
if (node.costCalculationRule) {
  // æ”¯æŒè¡¨è¾¾å¼è®¡ç®—
  // ä¾‹: "basePrice * (1 - discount) + shippingFee"
  const calculatedPrice = evaluate(node.costCalculationRule)
}

// 4. æ€»ä»· = æ‰€æœ‰å·²é…ç½®èŠ‚ç‚¹ä»·æ ¼ä¹‹å’Œ
const totalPrice = sum(allConfiguredNodes.map(n => n.totalPrice))
```

#### ä»·æ ¼æ˜ç»†æ•°æ®ç»“æ„

```javascript
{
  totalPrice: 15800.00,
  breakdown: [
    {
      nodeId: 1,
      nodeName: 'ä¸»æœº',
      quantity: 1,
      unitPrice: 5000.00,
      totalPrice: 5000.00
    },
    {
      nodeId: 2,
      nodeName: 'CPU',
      quantity: 2,
      unitPrice: 3000.00,
      totalPrice: 6000.00
    }
  ]
}
```

---

### ğŸ’¾ 5. é…ç½®ä¼šè¯ç®¡ç†

#### ä¼šè¯ç”Ÿå‘½å‘¨æœŸ

```
åˆ›å»ºä¼šè¯ â†’ é…ç½®ä¸­(draft) â†’ ä¿å­˜é…ç½®(saved) â†’ å®Œæˆé…ç½®(completed) â†’ ç”ŸæˆæŠ¥ä»·
```

#### APIä½¿ç”¨ç¤ºä¾‹

```javascript
import { useConfiguratorStore } from '@/store/modules/configurator'

const configuratorStore = useConfiguratorStore()

// 1. ä¿å­˜å½“å‰é…ç½®
await configuratorStore.saveConfigSession()

// 2. åŠ è½½å†å²é…ç½®
await configuratorStore.loadConfigSession('SESSION_1234567890')

// 3. å®Œæˆé…ç½®
const success = await configuratorStore.completeConfiguration()
if (success) {
  // è·³è½¬åˆ°æŠ¥ä»·é¡µé¢æˆ–å…¶ä»–æ“ä½œ
}

// 4. é‡ç½®é…ç½®
configuratorStore.resetConfiguration()
```

#### ä¼šè¯æ•°æ®ç»“æ„

```javascript
{
  sessionId: 'SESSION_1701234567890',
  bomId: 123,
  sessionName: 'é…ç½®ä¼šè¯_2024/1/3 15:30:00',
  createdAt: new Date('2024-01-03T15:30:00'),
  updatedAt: new Date('2024-01-03T16:00:00'),
  status: 'draft',              // draft | saved | completed
  configuration: {
    1: {                        // èŠ‚ç‚¹ID: é…ç½®æ•°æ®
      quantity: 2,
      selectedProductId: 101,
      attrs: { color: 'red', size: 'L' }
    }
  },
  savedToBackend: false
}
```

---

## æŠ€æœ¯å®ç°äº®ç‚¹

### ğŸ¯ 1. å‰ç«¯è§„åˆ™å¼•æ“

**ä¼˜åŠ¿ï¼š**
- âœ… æ— éœ€åç«¯è°ƒç”¨ï¼Œå®æ—¶å“åº”å¿«
- âœ… æ”¯æŒå¤æ‚åµŒå¥—æ¡ä»¶
- âœ… å®‰å…¨çš„è¡¨è¾¾å¼æ‰§è¡Œç¯å¢ƒ
- âœ… å®Œæ•´çš„è§„åˆ™æ‰§è¡Œæ—¥å¿—

**æ ¸å¿ƒç®—æ³•ï¼š**

```javascript
// é€’å½’è¯„ä¼°åµŒå¥—æ¡ä»¶
evaluateConditions(conditions) {
  let result = null
  
  for (let i = 0; i < conditions.length; i++) {
    const cond = conditions[i]
    const condResult = cond.configType === 'complex'
      ? this.evaluateConditions(cond.children)  // é€’å½’
      : this.evaluateSingleCondition(cond)
    
    if (i === 0) {
      result = condResult
    } else {
      result = cond.logic === 'AND' 
        ? result && condResult 
        : result || condResult
    }
  }
  
  return result
}
```

### ğŸ”„ 2. å“åº”å¼çŠ¶æ€ç®¡ç†

**Pinia Storeä¼˜åŠ¿ï¼š**
- âœ… é›†ä¸­å¼çŠ¶æ€ç®¡ç†
- âœ… TypeScriptå‹å¥½
- âœ… æ”¯æŒDevToolsè°ƒè¯•
- âœ… è‡ªåŠ¨æŒä¹…åŒ–ï¼ˆå¯æ‰©å±•ï¼‰

**æ ¸å¿ƒGettersï¼š**

```javascript
getters: {
  // å·²é…ç½®èŠ‚ç‚¹
  configuredNodes: (state) => {
    return Array.from(state.nodesMap.values())
      .filter(node => node.status === 'configured')
  },
  
  // é…ç½®å®Œæ•´æ€§
  isConfigurationComplete: (state) => {
    return Array.from(state.nodesMap.values())
      .every(node => !node.isRequired || node.status === 'configured')
  },
  
  // é…ç½®æ‘˜è¦
  configurationSummary: (state) => ({
    totalNodes: state.nodesMap.size,
    configuredNodes: /* ... */,
    requiredNodes: /* ... */,
    errors: /* ... */
  })
}
```

### ğŸ§© 3. ç»„ä»¶åŒ–è®¾è®¡

**ç»„ä»¶èŒè´£æ¸…æ™°ï¼š**

| ç»„ä»¶ | èŒè´£ | è¾“å…¥ | è¾“å‡º |
|-----|------|------|------|
| `ProductTree` | å±•ç¤ºBOMæ ‘ | bomId | node-selectäº‹ä»¶ |
| `AttributeConfig` | é…ç½®å±æ€§ | currentNode | config-confirmäº‹ä»¶ |
| `ConfigurationSummary` | æ˜¾ç¤ºæ‘˜è¦ | - | æ“ä½œäº‹ä»¶ |

**ç»„ä»¶é€šä¿¡æ–¹å¼ï¼š**

```
ProductTree ----(node-select)----> index.vue
                                      |
                                      v
                             selectedNode (props)
                                      |
                                      v
                              AttributeConfig
                                      |
                                      v
                             (config-confirm)
                                      |
                                      v
                                Storeæ›´æ–°
                                      |
                                      v
                           ConfigurationSummaryè‡ªåŠ¨æ›´æ–°
```

### ğŸš€ 4. æ€§èƒ½ä¼˜åŒ–

**ä¼˜åŒ–ç­–ç•¥ï¼š**

1. **è™šæ‹Ÿæ»šåŠ¨**ï¼ˆå¾…å®ç°ï¼‰ï¼šå¤§æ•°æ®é‡å±æ€§åˆ—è¡¨
2. **æ‡’åŠ è½½**ï¼šèŠ‚ç‚¹å±æ€§æŒ‰éœ€åŠ è½½
3. **ç¼“å­˜ç­–ç•¥**ï¼šè§„åˆ™å’ŒBOMç»“æ„ç¼“å­˜
4. **é˜²æŠ–/èŠ‚æµ**ï¼šæœç´¢ã€æ ¡éªŒç­‰æ“ä½œ
5. **è®¡ç®—å±æ€§**ï¼šé¿å…é‡å¤è®¡ç®—

```javascript
// ç¤ºä¾‹ï¼šç¼“å­˜è§„åˆ™å¼•æ“ä¸Šä¸‹æ–‡
const contextCache = new Map()

const getCachedContext = (nodeId) => {
  if (!contextCache.has(nodeId)) {
    contextCache.set(nodeId, buildContext(nodeId))
  }
  return contextCache.get(nodeId)
}
```

---

## åç«¯æ¥å£è¦æ±‚

### å¿…éœ€æ¥å£åˆ—è¡¨

#### 1. BOMç»“æ„ç›¸å…³

```javascript
// è·å–BOMæ ‘å½¢ç»“æ„
GET /cpq/bom/structure/tree?bomId=123
Response: {
  data: [
    {
      bomStructureId: 1,
      nodeName: 'ä¸»æœº',
      nodeType: '1',
      defaultQuantity: 1,
      minQuantity: 1,
      maxQuantity: 10,
      constraintType: 'quantity',
      constraintConfig: '{ "quantity": { "min": 1, "max": 10 } }',
      children: [...]
    }
  ]
}

// è·å–èŠ‚ç‚¹å±æ€§
GET /cpq/bom/structure/attribute/list?bomStructureId=1
Response: {
  data: [
    {
      attributeId: 1,
      attributeCode: 'color',
      attributeName: 'é¢œè‰²',
      attributeType: 'select',
      defaultValue: 'red',
      isRequired: '0',
      attributeGroupId: 1,
      attributeGroupName: 'å¤–è§‚å±æ€§',
      attributeValues: [
        { valueId: 1, valueCode: 'red', valueName: 'çº¢è‰²' },
        { valueId: 2, valueCode: 'blue', valueName: 'è“è‰²' }
      ]
    }
  ]
}

// è·å–èŠ‚ç‚¹å…³è”äº§å“
GET /cpq/bom/structure/product/list?bomStructureId=1
Response: {
  data: [
    {
      productId: 101,
      productName: 'Intel i7-12700K',
      price: 3000.00
    }
  ]
}
```

#### 2. è§„åˆ™ç›¸å…³

```javascript
// è·å–BOMå…³è”è§„åˆ™
POST /cpq/superBomRuleRelation/getByBomId
Request: { bomId: 123 }
Response: {
  data: [
    {
      relationId: 1,
      ruleId: 10,
      ruleName: 'é¢œè‰²éªŒè¯è§„åˆ™',
      ruleType: '1',
      status: 0
    }
  ]
}

// è·å–è§„åˆ™è¯¦æƒ…
GET /cpq/rule/10
Response: {
  data: {
    ruleId: 10,
    ruleCode: 'RULE_COLOR_VALIDATION',
    ruleName: 'é¢œè‰²éªŒè¯è§„åˆ™',
    ruleType: '1',
    rulePriority: 5,
    ruleStatus: '0',
    conditionConfig: '{ "conditions": [...] }',
    actionConfig: '{ "actions": [...] }'
  }
}
```

#### 3. å˜é‡ç›¸å…³

```javascript
// è·å–BOMå˜é‡
GET /cpq/superBomVariable/getBomId/123
Response: {
  data: [
    {
      variableId: 1,
      variableCode: 'totalPrice',
      variableName: 'æ€»ä»·',
      variableType: 'number',
      defaultValue: '0'
    }
  ]
}
```

#### 4. é…ç½®ä¼šè¯ç›¸å…³ï¼ˆæ–°å¢ï¼‰

```javascript
// æ–°å¢é…ç½®ä¼šè¯
POST /cpq/configSession
Request: {
  sessionId: 'SESSION_1701234567890',
  bomId: 123,
  sessionName: 'é…ç½®ä¼šè¯_2024/1/3 15:30:00',
  sessionStatus: 'saved',
  configurationData: '{ "1": { "quantity": 2, ... } }',
  pricingData: '{ "totalPrice": 15800.00, ... }',
  remark: 'ä¿å­˜äº 2024/1/3 16:00:00'
}
Response: {
  code: 200,
  msg: 'æ“ä½œæˆåŠŸ',
  data: { sessionId: 'SESSION_1701234567890' }
}

// æŸ¥è¯¢é…ç½®ä¼šè¯
GET /cpq/configSession/SESSION_1701234567890
Response: {
  data: {
    sessionId: 'SESSION_1701234567890',
    bomId: 123,
    sessionName: 'é…ç½®ä¼šè¯_2024/1/3 15:30:00',
    sessionStatus: 'saved',
    configurationData: '{ ... }',
    pricingData: '{ ... }',
    createTime: '2024-01-03 15:30:00',
    updateTime: '2024-01-03 16:00:00'
  }
}

// æ›´æ–°é…ç½®ä¼šè¯
PUT /cpq/configSession
Request: {
  sessionId: 'SESSION_1701234567890',
  sessionStatus: 'completed',
  configurationData: '{ ... }',
  pricingData: '{ ... }'
}

// å®Œæˆé…ç½®
POST /cpq/configSession/complete/SESSION_1701234567890
Response: {
  code: 200,
  msg: 'é…ç½®å·²å®Œæˆ'
}
```

### æ•°æ®åº“è¡¨è®¾è®¡å»ºè®®

```sql
-- é…ç½®ä¼šè¯è¡¨
CREATE TABLE cpq_config_session (
  session_id VARCHAR(50) PRIMARY KEY,
  bom_id BIGINT NOT NULL,
  session_name VARCHAR(200),
  session_status VARCHAR(20) DEFAULT 'draft',
  configuration_data TEXT,
  pricing_data TEXT,
  created_by VARCHAR(64),
  created_time DATETIME,
  updated_time DATETIME,
  remark VARCHAR(500)
);

CREATE INDEX idx_bom_id ON cpq_config_session(bom_id);
CREATE INDEX idx_status ON cpq_config_session(session_status);
```

---

## å¼€å‘è°ƒè¯•

### 1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨

```bash
# å®‰è£…ä¾èµ–
npm install

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev

# è®¿é—®é…ç½®å™¨
http://localhost:5173/cpq/configurator?bomId=123
```

### 2. è°ƒè¯•æŠ€å·§

#### ä½¿ç”¨Vue DevTools

```javascript
// æŸ¥çœ‹StoreçŠ¶æ€
const configuratorStore = useConfiguratorStore()
console.log(configuratorStore.$state)

// æŸ¥çœ‹è§„åˆ™å¼•æ“æ—¥å¿—
console.log(RuleEngine.getExecutionLog())

// æŸ¥çœ‹ä¸Šä¸‹æ–‡
console.log(RuleEngine.getContext())
```

#### æ¨¡æ‹Ÿåç«¯æ•°æ®

```javascript
// åœ¨ src/mock/ ç›®å½•åˆ›å»ºæ¨¡æ‹Ÿæ•°æ®
export const mockBomTree = [
  {
    bomStructureId: 1,
    nodeName: 'ä¸»æœº',
    nodeType: '1',
    children: [
      {
        bomStructureId: 2,
        nodeName: 'CPU',
        nodeType: '0'
      }
    ]
  }
]
```

### 3. å•å…ƒæµ‹è¯•ï¼ˆå¾…å®ç°ï¼‰

```javascript
// tests/unit/ruleEngine.spec.js
import { describe, it, expect } from 'vitest'
import RuleEngine from '@/utils/ruleEngine'

describe('RuleEngine', () => {
  it('åº”æ­£ç¡®è¯„ä¼°ç®€å•æ¡ä»¶', () => {
    RuleEngine.setContext({
      variables: { price: 1000 }
    })
    
    const condition = {
      judgeType: 'variable',
      field: 'price',
      operator: '>',
      value: 500,
      type: 'number'
    }
    
    const result = RuleEngine.evaluateSingleCondition(condition)
    expect(result).toBe(true)
  })
})
```

---

## å¸¸è§é—®é¢˜

### Q1: é…ç½®å™¨åŠ è½½ç¼“æ…¢æ€ä¹ˆåŠï¼Ÿ

**A:** ä¼˜åŒ–ç­–ç•¥ï¼š
1. æ£€æŸ¥BOMæ ‘ç»“æ„æ˜¯å¦è¿‡å¤§ï¼ˆå»ºè®®<500ä¸ªèŠ‚ç‚¹ï¼‰
2. å¯ç”¨è§„åˆ™ç¼“å­˜
3. ä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¤§æ•°æ®é‡ï¼‰
4. æŒ‰éœ€åŠ è½½èŠ‚ç‚¹å±æ€§

```javascript
// æ‡’åŠ è½½ç¤ºä¾‹
const loadNodeAttributesOnDemand = async (nodeId) => {
  if (!attributeCache.has(nodeId)) {
    const attrs = await fetchAttributes(nodeId)
    attributeCache.set(nodeId, attrs)
  }
  return attributeCache.get(nodeId)
}
```

### Q2: è§„åˆ™ä¸ç”Ÿæ•ˆæ€ä¹ˆæ’æŸ¥ï¼Ÿ

**A:** æ’æŸ¥æ­¥éª¤ï¼š
1. æ£€æŸ¥è§„åˆ™çŠ¶æ€ï¼ˆ`ruleStatus` å¿…é¡»ä¸º `'0'`ï¼‰
2. æŸ¥çœ‹è§„åˆ™æ‰§è¡Œæ—¥å¿—
3. éªŒè¯æ¡ä»¶è¡¨è¾¾å¼è¯­æ³•
4. ç¡®è®¤ä¸Šä¸‹æ–‡æ•°æ®æ˜¯å¦æ­£ç¡®

```javascript
// è°ƒè¯•ä»£ç 
const result = await RuleEngine.evaluateAll()
console.log('æ‰§è¡Œçš„è§„åˆ™:', result.executedRules)
console.log('è§„åˆ™é”™è¯¯:', result.errors)
console.log('æ‰§è¡Œæ—¥å¿—:', RuleEngine.getExecutionLog())
```

### Q3: ä»·æ ¼è®¡ç®—ä¸å‡†ç¡®æ€ä¹ˆåŠï¼Ÿ

**A:** æ£€æŸ¥é¡¹ï¼š
1. èŠ‚ç‚¹ä»·æ ¼é…ç½®æ˜¯å¦æ­£ç¡®
2. æ•°é‡æ˜¯å¦æ­£ç¡®
3. è‡ªå®šä¹‰è®¡ç®—è§„åˆ™è¡¨è¾¾å¼æ˜¯å¦æ­£ç¡®
4. æ˜¯å¦é€‰æ‹©äº†äº§å“ï¼ˆäº§å“ä»·æ ¼ä¼˜å…ˆï¼‰

```javascript
// æ‰‹åŠ¨è§¦å‘ä»·æ ¼é‡ç®—
await configuratorStore.calculateTotalPrice()

// æŸ¥çœ‹ä»·æ ¼æ˜ç»†
console.log(configuratorStore.pricing.breakdown)
```

### Q4: å¦‚ä½•æ‰©å±•æ–°çš„å±æ€§ç±»å‹ï¼Ÿ

**A:** æ·»åŠ æ­¥éª¤ï¼š
1. åœ¨ `AttributeConfig.vue` çš„ `getAttributeComponent` æ–¹æ³•ä¸­æ·»åŠ æ˜ å°„
2. åœ¨ `getComponentProps` æ–¹æ³•ä¸­æ·»åŠ å±æ€§é…ç½®
3. å¦‚éœ€è‡ªå®šä¹‰ç»„ä»¶ï¼Œåˆ›å»ºæ–°ç»„ä»¶å¹¶æ³¨å†Œ

```javascript
// ç¤ºä¾‹ï¼šæ·»åŠ è¯„åˆ†ç»„ä»¶
const getAttributeComponent = (type) => {
  const componentMap = {
    // ... ç°æœ‰æ˜ å°„
    rating: 'el-rate'  // æ–°å¢
  }
  return componentMap[type] || 'el-input'
}

const getComponentProps = (attr) => {
  switch (attr.attributeType) {
    case 'rating':
      return {
        max: 5,
        'allow-half': true,
        'show-text': true
      }
    // ...
  }
}
```

### Q5: å¦‚ä½•å®ç°é…ç½®åˆ†äº«åŠŸèƒ½ï¼Ÿ

**A:** å®ç°æ–¹æ¡ˆï¼š

```javascript
// 1. ç”Ÿæˆåˆ†äº«é“¾æ¥
const generateShareLink = (sessionId) => {
  const baseUrl = window.location.origin
  return `${baseUrl}/cpq/configurator?sessionId=${sessionId}`
}

// 2. å¤åˆ¶åˆ°å‰ªè´´æ¿
const copyShareLink = async (sessionId) => {
  const link = generateShareLink(sessionId)
  await navigator.clipboard.writeText(link)
  ElMessage.success('åˆ†äº«é“¾æ¥å·²å¤åˆ¶')
}

// 3. ä»åˆ†äº«é“¾æ¥åŠ è½½é…ç½®
onMounted(async () => {
  const { sessionId } = route.query
  if (sessionId) {
    await configuratorStore.loadConfigSession(sessionId)
  }
})
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š

- **GitHub Issues**: [é¡¹ç›®åœ°å€]
- **æŠ€æœ¯æ–‡æ¡£**: [åœ¨çº¿æ–‡æ¡£]
- **å¼€å‘è€…é‚®ç®±**: developer@example.com

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### v1.0.0 (2024-01-03)

- âœ¨ åˆå§‹ç‰ˆæœ¬å‘å¸ƒ
- âœ… å®Œæˆæ ¸å¿ƒåŠŸèƒ½å¼€å‘
- âœ… é›†æˆå‰ç«¯è§„åˆ™å¼•æ“
- âœ… å®ç°é…ç½®ä¼šè¯ç®¡ç†
- âœ… æ”¯æŒå®æ—¶ä»·æ ¼è®¡ç®—
- âœ… æä¾›å®Œæ•´æŠ€æœ¯æ–‡æ¡£

---

**ç¥æ‚¨ä½¿ç”¨æ„‰å¿«ï¼** ğŸ‰
