# 系统多租户架构迁移方案

## 一、系统现状分析

### 1. 架构现状
- 基于Spring Boot的单体应用
- 使用MyBatis作为ORM框架
- MySQL单数据库实例存储所有数据
- 经典MVC架构，包含系统管理、CPQ核心业务、监控和工具模块

### 2. 数据库现状
- 所有实体继承自BaseEntity，包含通用字段
- 核心业务表：cpq_product_price、cpq_product_master等
- 当前为单用户架构，无租户隔离机制

## 二、多租户架构设计

### 1. 租户数据隔离策略
**采用行级隔离方案**，原因：
- 适合中小规模租户，部署成本低
- 对现有系统改动相对较小
- 便于集中管理和维护
- 性能较好，适合CPQ业务系统

### 2. 核心设计方案

#### 2.1 数据模型改造
- **新增租户表**：sys_tenant，存储租户基本信息
- **BaseEntity扩展**：添加tenant_id字段作为租户标识
- **所有业务表**：继承扩展后的BaseEntity，自动包含tenant_id

#### 2.2 租户识别与认证
- **Token增强**：在JWT Token中添加tenant_id字段
- **拦截器实现**：通过请求拦截器自动识别租户，设置到上下文
- **多租户上下文**：ThreadLocal存储当前租户信息

#### 2.3 数据访问层改造
- **MyBatis拦截器**：自动为SQL添加tenant_id条件
- **Mapper改造**：确保所有CRUD操作都包含租户隔离
- **分页插件适配**：确保分页查询也能正确进行租户隔离

#### 2.4 系统配置租户化
- **配置表改造**：添加tenant_id字段，支持租户级配置
- **配置加载机制**：优先加载租户配置，其次系统默认配置

#### 2.5 权限控制扩展
- **角色租户化**：角色与租户关联，支持租户内独立角色管理
- **菜单租户化**：支持租户自定义菜单和权限
- **数据权限增强**：确保用户只能访问所属租户数据

## 三、实施步骤

### 1. 准备阶段
- 设计租户表结构
- 扩展BaseEntity，添加tenant_id字段
- 创建多租户上下文工具类

### 2. 数据模型改造
- 修改所有实体类，确保继承扩展后的BaseEntity
- 执行数据库迁移，为所有表添加tenant_id字段
- 初始化默认租户数据

### 3. 数据访问层改造
- 实现MyBatis多租户拦截器
- 修改Mapper文件，确保所有SQL都支持租户隔离
- 测试数据访问的正确性

### 4. 认证授权改造
- 修改JWT生成逻辑，添加tenant_id
- 实现租户识别拦截器
- 改造权限控制，支持租户级权限

### 5. 系统配置改造
- 修改配置表结构，添加tenant_id
- 改造配置加载逻辑，支持租户级配置

### 6. 业务功能适配
- 改造所有业务接口，确保租户隔离
- 测试核心业务流程，确保功能不受影响
- 修复可能出现的租户隔离问题

### 7. 数据迁移
- 为现有数据设置默认租户ID
- 确保历史数据能正确访问

### 8. 测试验证
- 功能测试：确保所有业务功能正常
- 性能测试：验证多租户架构下的系统性能
- 安全测试：确保租户间数据隔离安全
- 租户隔离测试：验证不同租户数据完全隔离

## 四、关键技术实现

### 1. 多租户上下文
```java
public class TenantContext {
    private static final ThreadLocal<Long> CURRENT_TENANT = new ThreadLocal<>();
    
    public static void setTenantId(Long tenantId) {
        CURRENT_TENANT.set(tenantId);
    }
    
    public static Long getTenantId() {
        return CURRENT_TENANT.get();
    }
    
    public static void clear() {
        CURRENT_TENANT.remove();
    }
}
```

### 2. MyBatis多租户拦截器
```java
@Component
@Intercepts({
    @Signature(type = Executor.class, method = "update", args = {MappedStatement.class, Object.class}),
    @Signature(type = Executor.class, method = "query", args = {MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class, CacheKey.class, BoundSql.class}),
    @Signature(type = Executor.class, method = "query", args = {MappedStatement.class, Object.class, RowBounds.class, ResultHandler.class})
})
public class TenantInterceptor implements Interceptor {
    // 实现拦截逻辑，自动添加tenant_id条件
}
```

### 3. 租户表设计
```sql
CREATE TABLE sys_tenant (
    tenant_id BIGINT NOT NULL AUTO_INCREMENT COMMENT '租户ID',
    tenant_name VARCHAR(100) NOT NULL COMMENT '租户名称',
    tenant_code VARCHAR(50) NOT NULL COMMENT '租户编码',
    status CHAR(1) DEFAULT '0' COMMENT '状态（0正常 1停用）',
    create_by VARCHAR(64) DEFAULT '' COMMENT '创建者',
    create_time DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    update_by VARCHAR(64) DEFAULT '' COMMENT '更新者',
    update_time DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    remark VARCHAR(500) DEFAULT NULL COMMENT '备注',
    PRIMARY KEY (tenant_id),
    UNIQUE KEY uk_tenant_code (tenant_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='租户信息表';
```

## 五、风险评估与应对

| 风险点 | 应对措施 |
|--------|----------|
| 数据隔离不彻底 | 加强测试，特别是跨租户数据访问测试 |
| 性能下降 | 优化SQL查询，添加合适索引，考虑读写分离 |
| 现有功能受影响 | 采用增量改造，先支持多租户，再逐步优化 |
| 数据迁移失败 | 制定详细的数据迁移计划，做好数据备份 |

## 六、预期效果

1. **数据安全隔离**：不同租户数据完全隔离，确保数据安全
2. **独立配置管理**：支持租户级系统配置，满足个性化需求
3. **资源有效共享**：系统资源共享，降低部署和维护成本
4. **良好扩展性**：支持动态添加租户，适应业务快速发展
5. **性能稳定可靠**：经过优化的多租户架构，性能满足业务需求

## 七、实施计划

| 阶段 | 时间 | 主要任务 |
|------|------|----------|
| 准备阶段 | 1天 | 设计租户表结构，扩展BaseEntity，创建多租户上下文 |
| 数据模型改造 | 2天 | 修改所有实体类，执行数据库迁移，初始化默认租户数据 |
| 数据访问层改造 | 2天 | 实现MyBatis多租户拦截器，修改Mapper文件 |
| 认证授权改造 | 1天 | 修改JWT逻辑，实现租户识别拦截器，改造权限控制 |
| 系统配置改造 | 1天 | 修改配置表结构，改造配置加载逻辑 |
| 业务功能适配 | 2天 | 改造业务接口，测试核心业务流程 |
| 数据迁移 | 1天 | 为现有数据设置默认租户ID |
| 测试验证 | 2天 | 功能测试、性能测试、安全测试、租户隔离测试 |
| 上线部署 | 1天 | 生产环境部署，监控运行状态 |

## 八、后续优化方向

1. 考虑引入租户资源配额管理
2. 支持租户级数据备份和恢复
3. 实现租户级日志隔离
4. 考虑支持多数据库实例部署，应对大规模租户场景
5. 引入租户管理控制台，方便租户自助管理

该方案确保了系统从单用户架构平滑迁移至多租户架构，同时保持现有业务功能不受影响，满足数据安全隔离、独立配置及资源分配要求。